<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascensão Demoníaca | Demon Slayer RPG</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-deep: #020202;
            --bg-panel: #0a0a0c;
            --blood-primary: #990000;
            --blood-bright: #ff0000;
            --blood-dark: #4a0000;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --font-main: 'Outfit', sans-serif;
            --font-display: 'Cinzel', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1a0505 0%, #000 70%);
        }

        /* --- BACKGROUND FX --- */
        .blood-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.4;
        }

        .particle {
            position: absolute;
            background: var(--blood-bright);
            border-radius: 50%;
            opacity: 0;
            animation: floatUp 10s infinite linear;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }

            20% {
                opacity: 0.6;
            }

            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        /* --- CONTAINER --- */
        .creation-container {
            width: 100%;
            max-width: none;
            height: 100vh;
            display: flex;
            background: rgba(10, 10, 12, 0.8);
            border: none;
            border-radius: 0;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: none;
            position: relative;
            z-index: 10;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--bg-panel) 0%, #050505 100%);
            border-right: 1px solid #222;
            padding: 3rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .brand-title {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--blood-bright);
            text-align: center;
            letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
            margin-bottom: 2rem;
        }

        .steps-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            border-radius: 8px;
            color: #666;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .step-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--blood-bright);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .step-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.03);
        }

        .step-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(1);
        }

        .lock-icon {
            margin-left: auto;
            width: 16px;
            height: 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .step-item.locked .lock-icon {
            opacity: 1;
        }

        .step-item.active {
            color: white;
            background: linear-gradient(90deg, rgba(153, 0, 0, 0.1), transparent);
        }

        .step-item.active::before {
            transform: scaleY(1);
        }

        .step-num {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 700;
            opacity: 0.5;
        }

        /* --- MAIN CONTENT --- */
        .content-area {
            flex: 1;
            padding: 4rem 6rem;
            overflow-y: auto;
            position: relative;
        }

        .step-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .step-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 3rem;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .section-desc {
            color: #aaa;
            font-size: 1.1rem;
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        /* --- CARDS & GRID --- */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .bg-card {
            background: #0f0f13;
            border: 1px solid #333;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            height: 400px;
        }

        .bg-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            border-color: #666;
        }

        .bg-card.selected {
            border-color: var(--blood-bright);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
            transition: 0.4s;
        }

        .bg-card:hover .card-img {
            opacity: 0.8;
            scale: 1.05;
        }

        .bg-card.selected .card-img {
            opacity: 0.4;
            scale: 1.1;
            filter: grayscale(100%) sepia(50%) hue-rotate(-50deg) saturate(300%);
        }

        .card-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), transparent);
            padding: 2rem;
            z-index: 2;
        }

        .card-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-text {
            color: #ccc;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* --- ATTRIBUTES --- */
        .attr-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .attr-input-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .attr-input-card:hover,
        .attr-input-card:focus-within {
            border-color: var(--blood-bright);
            background: rgba(153, 0, 0, 0.05);
        }

        .attr-val-input {
            background: transparent;
            border: none;
            color: white;
            font-family: var(--font-display);
            font-size: 2.5rem;
            text-align: center;
            width: 100px;
            outline: none;
            border-bottom: 2px solid #333;
            transition: 0.3s;
        }

        .attr-val-input:focus {
            border-color: var(--blood-bright);
        }

        /* --- PARTICULARITIES --- */
        .part-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .part-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            padding: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .part-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .part-item.selected {
            background: linear-gradient(135deg, rgba(153, 0, 0, 0.2), transparent);
            border-color: var(--blood-bright);
        }

        /* --- INPUTS TEXT --- */
        .text-input-group {
            margin-bottom: 2rem;
        }

        .ds-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            color: white;
            padding: 1rem;
            font-size: 1rem;
            border-radius: 8px;
            font-family: var(--font-main);
        }

        .ds-input:focus {
            outline: none;
            border-color: var(--blood-bright);
        }

        /* --- CONTROLS --- */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 300px;
            right: 320px;
            width: auto;
            padding: 2rem 4rem;
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            z-index: 20;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-text {
            background: transparent;
            color: #888;
            border: 1px solid transparent;
        }

        .btn-text:hover {
            color: white;
        }

        .btn-primary {
            background: var(--blood-primary);
            color: white;
            border: none;
            box-shadow: 0 0 20px rgba(153, 0, 0, 0.4);
        }

        .btn-primary:hover {
            background: var(--blood-bright);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
            transform: scale(1.05);
        }

        /* Locked Placeholder */
        .locked-card {
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none;
        }

        /* ATTRIBUTE SLIDERS */
        .attr-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .attr-label {
            width: 140px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ddd;
        }

        .attr-input-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #333;
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--blood-bright);
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #ff4d4d;
        }

        .attr-val-box {
            background: #222;
            width: 40px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
            font-family: var(--font-display);
            color: white;
            border: 1px solid #444;
        }

        .points-box {
            background: rgba(153, 0, 0, 0.2);
            border: 1px solid var(--blood-bright);
            color: var(--blood-bright);
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.1rem;
            float: right;
            transform: translateY(-5px);
            font-family: var(--font-display);
        }

        /* --- RIGHT SIDEBAR --- */
        .sidebar-right {
            width: 320px;
            background: linear-gradient(180deg, var(--bg-panel) 0%, #050505 100%);
            border-left: 1px solid #222;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .preview-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #222;
            border: 2px solid var(--blood-bright);
            object-fit: cover;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            color: #aaa;
        }

        .summary-table td {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .summary-table td:last-child {
            text-align: right;
            color: white;
            font-weight: bold;
        }

        .vital-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .vital-label {
            display: block;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .vital-val {
            font-size: 1.8rem;
            font-family: var(--font-display);
            font-weight: bold;
        }

        .vital-val span {
            font-size: 1rem;
            color: #555;
            font-weight: normal;
        }

        .confirm-btn {
            width: 100%;
            padding: 1rem;
            background: var(--blood-bright);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: var(--font-display);
            margin-top: auto;
        }

        .confirm-btn:hover {
            box-shadow: 0 0 20px var(--blood-dim);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <div class="blood-canvas" id="bloodCanvas"></div>

    <div class="creation-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand-title">DEMON<br>SLAYER</div>
            <nav class="steps-nav">
                <div class="step-item active" id="nav-step-1" onclick="goToStep(1)">
                    <span class="step-num">01.</span>
                    <span>Caminho</span>
                    <i data-lucide="lock" class="lock-icon"></i>
                </div>
                <div class="step-item locked" id="nav-step-2" onclick="goToStep(2)">
                    <span class="step-num">02.</span>
                    <span>Kekkijutsu</span>
                    <i data-lucide="lock" class="lock-icon"></i>
                </div>
                <div class="step-item locked" id="nav-step-3" onclick="goToStep(3)">
                    <span class="step-num">03.</span>
                    <span>Particularidades</span>
                    <i data-lucide="lock" class="lock-icon"></i>
                </div>
                <div class="step-item locked" id="nav-step-4" onclick="goToStep(4)">
                    <span class="step-num">04.</span>
                    <span>Atributos</span>
                    <i data-lucide="lock" class="lock-icon"></i>
                </div>
                <div class="step-item locked" id="nav-step-5" onclick="goToStep(5)">
                    <span class="step-num">05.</span>
                    <span>Identidade</span>
                    <i data-lucide="lock" class="lock-icon"></i>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content-area">

            <!-- STEP 1: PATH -->
            <section id="step-1" class="step-section active">
                <h1 class="section-title">Escolha seu Destino</h1>
                <p class="section-desc">Você renasceu nas sombras. Como irá sustentar sua existência imortal?</p>

                <div class="options-grid">
                    <div class="bg-card selected" onclick="selectPath('blood', this)">
                        <img src="assets/criação_personagem/Oni-removebg-preview.png" class="card-img" alt="Oni Sangue"
                            style="object-fit:contain;">
                        <div class="card-content">
                            <h3 class="card-title"> <i data-lucide="droplet" style="color:red"></i> Caminho do Sangue
                            </h3>
                            <p class="card-text">O caminho tradicional. Consumir carne humana concede poder
                                incomensurável, regeneração rápida e força bruta. Mas a fome é uma fera indomável.</p>
                        </div>
                    </div>

                    <div class="bg-card" onclick="selectPath('flesh', this)">
                        <img src="assets/NezukoKamado.png" class="card-img" alt="Nezuko Style"
                            style="object-fit:contain;">
                        <div class="card-content">
                            <h3 class="card-title"> <i data-lucide="moon" style="color:cyan"></i> Retenção de Carne</h3>
                            <p class="card-text">Um caminho raro. Através do sono profundo e controle mental, você
                                rejeita a carne humana. Sua evolução é mais lenta, mas sua humanidade permanece.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 2: KEKKIJUTSU -->
            <section id="step-2" class="step-section">
                <h1 class="section-title">Arte Demoníaca</h1>
                <p class="section-desc">Seu sangue carrega poderes únicos. Qual elemento se manifesta em você?</p>

                <div class="options-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="bg-card selected" style="height:300px;" onclick="selectKekk('ice', this)">
                        <div
                            style="position:absolute; inset:0; background:linear-gradient(45deg, #00b4d8, transparent);">
                        </div>
                        <div class="card-content">
                            <h3 class="card-title"><i data-lucide="snowflake"></i> Criocinese</h3>
                            <p class="card-text">Gere e manipule gelo a partir do seu sangue e vapor d'água.</p>
                        </div>
                    </div>

                    <div class="bg-card locked-card" style="height:300px;">
                        <div
                            style="position:absolute; inset:0; background:#111; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;">
                            <i data-lucide="lock" size="48" style="color:#444;"></i>
                            <span style="font-family:var(--font-display); color:#666; font-size:1.2rem;">Fios (Nível
                                5)</span>
                        </div>
                    </div>

                    <div class="bg-card locked-card" style="height:300px;">
                        <div
                            style="position:absolute; inset:0; background:#111; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;">
                            <i data-lucide="lock" size="48" style="color:#444;"></i>
                            <span style="font-family:var(--font-display); color:#666; font-size:1.2rem;">Pântano (Nível
                                3)</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 3: PARTICULARITIES -->
            <section id="step-3" class="step-section">
                <h1 class="section-title">Dons Sobrenaturais</h1>
                <p class="section-desc">Selecione 2 características biológicas que definem seu corpo oni.</p>
                <div id="partCounter" style="color:var(--blood-bright); margin-bottom:1rem; font-weight:bold;">0 / 2
                    Selecionado(s)</div>
                <div class="part-grid" id="particularitiesRef">
                    <!-- JS Fill -->
                </div>
            </section>

            <!-- STEP 4: ATTRIBUTES -->
            <section id="step-4" class="step-section">
                <div
                    style="display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 2rem;">
                    <div>
                        <h1 class="section-title" style="border:none; margin:0; padding:0;">Atributos Base</h1>
                        <p class="section-desc" style="margin:0;">Defina suas capacidades demoníacas (27 Pontos).</p>
                    </div>
                    <div class="points-box">Pontos: <span id="pointsRemain">27</span></div>
                </div>

                <!-- BONUS SELECTION UI -->
                <div
                    style="margin-bottom:2rem; background:rgba(255,255,255,0.02); padding:1rem; border-radius:8px; border:1px solid rgba(255,255,255,0.05);">
                    <h4 style="margin-top:0; color:var(--blood-bright); margin-bottom:10px; font-size:1rem;">Bônus
                        Racial (+2) <span style="font-weight:400; color:#888; font-size:0.8rem;">(Escolha 2)</span></h4>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="bonus-toggle" data-attr="str" onclick="toggleBonus('str')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Força</button>
                        <button class="bonus-toggle" data-attr="dex" onclick="toggleBonus('dex')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Destreza</button>
                        <button class="bonus-toggle" data-attr="con" onclick="toggleBonus('con')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Constituição</button>
                        <button class="bonus-toggle" data-attr="int" onclick="toggleBonus('int')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Inteligência</button>
                        <button class="bonus-toggle" data-attr="wis" onclick="toggleBonus('wis')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Sabedoria</button>
                        <button class="bonus-toggle" data-attr="cha" onclick="toggleBonus('cha')"
                            style="padding:5px 10px; border:1px solid #333; background:rgba(255,255,255,0.05); color:#888; border-radius:4px; cursor:pointer;">Carisma</button>
                    </div>
                </div>

                <div style="max-width: 800px; margin: 0 auto;">
                    <!-- STR -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="swords" size="16" style="color:var(--blood-bright)"></i>
                            Força</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-str" min="6" max="18" step="2" value="8" style="--val:0%"
                                oninput="updateStat('str', this.value)">
                            <div class="attr-val-box" id="val-str">8</div>
                        </div>
                    </div>
                    <!-- DEX -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="wind" size="16" style="color:var(--blood-bright)"></i>
                            Destreza</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-dex" min="6" max="18" step="2" value="8"
                                oninput="updateStat('dex', this.value)">
                            <div class="attr-val-box" id="val-dex">8</div>
                        </div>
                    </div>
                    <!-- CON -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="shield" size="16" style="color:var(--blood-bright)"></i>
                            Constituição</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-con" min="6" max="18" step="2" value="8"
                                oninput="updateStat('con', this.value)">
                            <div class="attr-val-box" id="val-con">8</div>
                        </div>
                    </div>
                    <!-- INT -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="brain" size="16" style="color:var(--blood-bright)"></i>
                            Inteligência</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-int" min="6" max="18" step="2" value="8"
                                oninput="updateStat('int', this.value)">
                            <div class="attr-val-box" id="val-int">8</div>
                        </div>
                    </div>
                    <!-- WIS -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="eye" size="16" style="color:var(--blood-bright)"></i>
                            Sabedoria</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-wis" min="6" max="18" step="2" value="8"
                                oninput="updateStat('wis', this.value)">
                            <div class="attr-val-box" id="val-wis">8</div>
                        </div>
                    </div>
                    <!-- CHA -->
                    <div class="attr-row">
                        <div class="attr-label"><i data-lucide="smile" size="16" style="color:var(--blood-bright)"></i>
                            Carisma</div>
                        <div class="attr-input-group">
                            <input type="range" id="input-cha" min="6" max="18" step="2" value="8"
                                oninput="updateStat('cha', this.value)">
                            <div class="attr-val-box" id="val-cha">8</div>
                        </div>
                    </div>

                    <button onclick="openDiceModal()" style="
                        width:100%; 
                        max-width: 800px;
                        margin: 1.5rem auto 0 auto; 
                        padding:12px; 
                        background:rgba(255,255,255,0.05); 
                        border:1px dashed #555; 
                        color:#ccc; 
                        border-radius:8px; 
                        cursor:pointer; 
                        display:flex; 
                        align-items:center; 
                        justify-content:center; 
                        gap:10px; 
                        transition:0.3s;
                    " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='#999';"
                        onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='#555';">
                        <i data-lucide="dices" size="18"></i> Girar os Dados / Manual
                    </button>
                </div>
            </section>

            <!-- STEP 5: FINAL -->
            <section id="step-5" class="step-section">
                <h1 class="section-title">Renascimento</h1>
                <p class="section-desc">O último passo. Quem é você agora?</p>

                <div style="max-width: 600px;">
                    <div class="text-input-group">
                        <label style="display:block; color:#ddd; margin-bottom:10px;">Nome do Oni</label>
                        <input type="text" id="oniName" class="ds-input" placeholder="Ex: Akaza">
                    </div>

                    <div class="text-input-group">
                        <label style="display:block; color:#ddd; margin-bottom:10px;">Aparência / Detalhes</label>
                        <textarea id="oniDesc" class="ds-input" rows="5"
                            placeholder="Descreva suas marcas, chifres, cor da pele..."></textarea>
                    </div>

                    <div
                        style="margin-top:2rem; padding: 1rem; border: 1px dashed #444; border-radius:8px; color:#888; font-size:0.9rem;">
                        <i data-lucide="info" style="vertical-align:middle; width:16px;"></i> Ao clicar em "Aceitar o
                        Sangue", você será transportado para o seu painel de controle.
                    </div>
                </div>
            </section>

        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="sidebar-right">
            <div class="preview-header">
                <img src="assets/criação_personagem/Oni-removebg-preview.png" class="preview-avatar" id="previewImg">
                <div>
                    <div style="font-size:1.2rem; font-weight:bold; font-family:var(--font-display); color:white;"
                        id="previewName">Oni Desconhecido</div>
                    <div style="font-size:0.85rem; color:var(--blood-dim);" id="previewPath">Caminho do Sangue</div>
                </div>
            </div>

            <table class="summary-table">
                <tr>
                    <td>Raça</td>
                    <td>Oni</td>
                </tr>
                <tr>
                    <td>Rank</td>
                    <td>Oni Inferior</td>
                </tr>
                <tr>
                    <td>Kekkijutsu</td>
                    <td id="previewKekk">Gelo</td>
                </tr>
                <tr>
                    <td>Antecedente</td>
                    <td id="previewBg">-</td>
                </tr>
                <tr>
                    <td>Deslocamento</td>
                    <td id="previewSpeed">9m</td>
                </tr>
            </table>

            <div style="margin-top:1rem; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="vital-box">
                    <span class="vital-label">Vida Max</span>
                    <div class="vital-val" style="color:var(--blood-bright);" id="previewHP">15</div>
                </div>
                <div class="vital-box">
                    <span class="vital-label">Pontos de Sangue</span>
                    <div class="vital-val" style="color:#a855f7;" id="previewPE">1</div>
                </div>
            </div>

            <div style="margin-top:1.5rem;">
                <span class="vital-label" style="margin-bottom:10px;">Particularidades</span>
                <div id="previewParts"
                    style="display:flex; flex-direction:column; gap:8px; font-size:0.9rem; color:#ccc;">
                    <span style="opacity:0.5; font-style:italic;">Nenhuma selecionada</span>
                </div>
            </div>

            <button class="confirm-btn" onclick="finishCreation()">CONFIRMAR CRIAÇÃO</button>

        </aside>

        <!-- Navigation Buttons -->
        <footer class="bottom-nav">
            <button class="btn btn-text" id="prevBtn" onclick="prevStep()">Voltar</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Próximo <i
                    data-lucide="arrow-right"></i></button>
        </footer>
    </div>

    <!-- PARTICULARITY DETAIL MODAL -->
    <div id="partDetailModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; align-items:center; justify-content:center; backdrop-filter:blur(8px);">
        <div
            style="background:#111; width:600px; max-width:90%; border-radius:12px; border:1px solid #333; overflow:hidden; display:flex; flex-direction:column; max-height:85vh;">
            <!-- Header -->
            <div
                style="padding:1.5rem; background:#1a1a1a; display:flex; align-items:center; gap:15px; border-bottom:1px solid #333;">
                <div id="pdIcon"
                    style="width:50px; height:50px; background:var(--blood-dim); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white;">
                    <!-- Icon injected here -->
                </div>
                <h2 id="pdTitle" style="color:white; margin:0; font-family:var(--font-display); font-size:1.8rem;">
                    Título</h2>
            </div>

            <!-- Body -->
            <div style="padding:2rem; overflow-y:auto; color:#ccc; line-height:1.6; font-size:1.05rem;" id="pdContent">
                <!-- Text injected here -->
            </div>

            <!-- Footer -->
            <div
                style="padding:1.5rem; background:#1a1a1a; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="document.getElementById('partDetailModal').style.display='none'"
                    style="padding:10px 20px; background:transparent; border:1px solid #555; color:#aaa; border-radius:6px; cursor:pointer;">Fechar</button>
                <button id="pdSelectBtn"
                    style="padding:10px 25px; background:var(--blood-primary); border:none; color:white; border-radius:6px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:8px;">
                    SELECIONAR
                </button>
            </div>
        </div>
    </div>

    <!-- DICE ROLL MODAL (MANUAL INPUT) -->
    <div id="diceRollModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div
            style="background:#111; padding:2rem; border-radius:12px; border:1px solid #333; width:400px; text-align:center;">
            <h3 style="color:var(--blood-bright); margin-top:0; font-family:var(--font-display);">Atributos Manuais</h3>
            <p style="color:#888; font-size:0.9rem; margin-bottom:1.5rem;">Insira os valores rolados (ex: 4d6 drop
                lowest).
            </p>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:1.5rem;">
                <!-- Inputs -->
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">FOR</span>
                    <input type="number" id="manual-str" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">DES</span>
                    <input type="number" id="manual-dex" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">CON</span>
                    <input type="number" id="manual-con" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">INT</span>
                    <input type="number" id="manual-int" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">SAB</span>
                    <input type="number" id="manual-wis" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
                <div
                    style="display:flex; align-items:center; justify-content:space-between; background:#222; padding:8px; border-radius:4px;">
                    <span style="font-weight:bold; color:#ccc;">CAR</span>
                    <input type="number" id="manual-cha" value="10"
                        style="width:50px; background:#111; border:1px solid #444; color:white; text-align:center; padding:5px; border-radius:4px;">
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('diceRollModal').style.display='none'"
                    style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; cursor:pointer;">Cancelar</button>
                <button onclick="applyManualStats()"
                    style="flex:1; padding:10px; background:var(--blood-primary); border:none; color:white; border-radius:4px; cursor:pointer; font-weight:bold;">Aplicar</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- BACKGROUND ---
        function createParticles() {
            const canvas = document.getElementById('bloodCanvas');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = Math.random() * 6 + 2 + 'px';
                p.style.height = p.style.width;
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = Math.random() * 5 + 5 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                canvas.appendChild(p);
            }
        }
        createParticles();

        // --- LOGIC ---
        let currentStep = 1;
        const totalSteps = 6;

        // Define State
        let state = {
            path: 'blood',
            kekkijutsu: 'ice',
            particularities: [],
            background: 'criminal',
            stats: { str: 8, dex: 8, con: 8, int: 8, wis: 8, cha: 8 },
            bonuses: [],
            pointsMax: 27,
            pointsSpent: 0,
            manualMode: false,
            maxStep: 1
        };

        const PARTS = [
            {
                id: 'size', name: 'Alteração Corporal', icon: 'maximize',
                desc: 'Ação para diminuir (15cm) ou aumentar (5m).',
                full: 'Você possui a habilidade de alterar seu tamanho em diversas situações. Usando uma ação você pode diminuir para até 15 centímetros de altura ou aumentar para até 5 metros de altura. Ao diminuir para uma altura de 15 centímetros, você pode se tornar extremamente ágil e se infiltrar em espaços pequenos, passando despercebido. Já ao aumentar para 5 metros de altura, você se torna imponente e poderoso, capaz de intimidar e dominar o ambiente ao seu redor.'
            },
            {
                id: 'animal', name: 'Aparência Animalesca', icon: 'cat',
                desc: 'Adquire características de um animal. Requer aprovação.',
                full: 'Você tem a capacidade de assumir uma aparência muito semelhante à de um animal de sua escolha e adquirir algumas características relacionadas a ele. Por exemplo, se escolher se transformar em uma aranha, poderá aderir às paredes e tecer teias. No entanto, é importante conversar com seu mestre antes de fazer essa escolha, para determinar quais animais são permitidos para a sua transmutação. Além disso, é relevante considerar que você enfrentará um preconceito severo por conta dessas características, o que pode afetar suas interações com outras pessoas.'
            },
            {
                id: 'disturbing', name: 'Aparência Perturbadora', icon: 'ghost',
                desc: 'Vantagem em testes de Intimidação.',
                full: 'Você possui a habilidade de assumir uma forma assustadora, o que lhe permite intimidar criaturas com mais facilidade. Se você deseja intimidar uma criatura, você pode fazer um teste com vantagem para isso.'
            },
            {
                id: 'camo', name: 'Camuflagem Adaptativa', icon: 'eye-off',
                desc: '+2 em Furtividade. Mistura-se ao ambiente.',
                full: 'Você é capaz de se adaptar ao ambiente ao seu redor, alterando a textura da sua pele ou padrões corporais para se misturar perfeitamente com a paisagem, tornando-se quase invisível para observadores desatentos. Você ganha um bônus de +2 em testes de furtividade.'
            },
            {
                id: 'extend', name: 'Extensão de Membros', icon: 'chevrons-up',
                desc: 'Aumenta alcance de ataque corpo-a-corpo em 1,5m.',
                full: 'Você pode estender seus membros, como braços e pernas, para alcançar objetos distantes ou aumentar seu alcance em ataques físicos, permitindo que você lide com ameaças de longa distância com facilidade, você aumenta seu alcance de ataques em 1,5 metros.'
            },
            {
                id: 'charming', name: 'Forma Cativante', icon: 'heart',
                desc: 'Aparência atraente. Vantagem em Persuasão.',
                full: 'Você adquire uma aparência muito atraente aos outros, podendo assumir diferentes formas, como a de uma criança inocente ou de um rosto encantador. Isso lhe confere uma vantagem em testes de persuasão.'
            },
            {
                id: 'claws', name: 'Garra Laminada', icon: 'scissors',
                desc: 'Ataques desarmados causam dano cortante.',
                full: 'Suas garras são afiadas como lâminas, permitindo que você cause dano cortante em seus ataques corpo-a-corpo.'
            },
            {
                id: 'mimicry', name: 'Mimetismo', icon: 'mic',
                desc: 'Imita vozes e sons. CD 15 de Intuição.',
                full: 'Você tem a habilidade de imitar perfeitamente vozes que você escutou e sons de outras criaturas, você deve realizar um teste de intuição CD 15 para distinguir.'
            },
            {
                id: 'limbs', name: 'Múltiplos Membros', icon: 'users',
                desc: 'Aumenta dano desarmado para 1d10.',
                full: 'Você possui a capacidade de criar braços ou pernas adicionais, o que intensifica seus ataques desarmados, aumentando seu dano desarmado para 1d10.'
            },
            {
                id: 'steel_skin', name: 'Pele de Aço', icon: 'shield',
                desc: 'RD 2 contra corte e concussão.',
                full: 'Você possui uma pele de aço, reduzindo todo o dano cortante e concussão que você sofre em -2.'
            },
            {
                id: 'human_form', name: 'Transformação Humana', icon: 'user',
                desc: 'Transformação perfeita em humano.',
                full: 'Você possui a habilidade de se transformar completamente em humano, tornando-se indistinguível dos demais. Essa transformação apenas é perceptível por aqueles que possuem sentidos extrassensoriais.'
            },
            {
                id: 'water_breath', name: 'Respiração Aquática', icon: 'droplet',
                desc: 'Respira na água e superfície.',
                full: 'Você possui a capacidade de respirar tanto na água quanto na superfície, sem nenhuma dificuldade ou restrição.'
            },
            {
                id: 'darkvision', name: 'Visão Noturna', icon: 'eye',
                desc: 'Enxerga na escuridão (preto e branco).',
                full: 'Você possui a habilidade de enxergar perfeitamente no escuro, como se fosse plena luz do dia. Seus olhos se adaptam rapidamente a condições de pouca luz, permitindo que você veja detalhes sutis e se mova com facilidade em ambientes com iluminação inadequada. No entanto, essa habilidade não permite que você veja cores, apenas enxergando tudo em preto e branco.'
            }
        ];

        const COSTS = { 6: -2, 8: 0, 10: 2, 12: 4, 14: 7, 16: 12, 18: 17 };

        const backgroundData = {
            artista: {
                title: "Artista", icon: "palette",
                skills: ["Atuação", "Persuasão"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d6 x 1000", desc: "Ienes obtidos com sua arte.", weight: "0.5 kg" },
                    { name: "Pincel e Tintas", type: "item", desc: "Ferramentas de pintura.", weight: "1 kg" },
                    { name: "Roupa de Artista", type: "armor", ac: "11 + Des", props: "Leve", weight: "2 kg" },
                    { name: "Kit de Disfarce", type: "item", weight: "1.5 kg" }
                ],
                desc: "Dedicado à beleza e emoção. Visão única do mundo."
            },
            brigao: {
                title: "Brigão", icon: "skull",
                skills: ["Atletismo", "Intimidação"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Dinheiro de apostas.", weight: "0.5 kg" },
                    { name: "Porrete", type: "weapon", dmg: "1d4 concussão", props: "Simples, Leve", weight: "1 kg" }
                ],
                desc: "Nascido na rua ou arenas. Mestre em combate desarmado."
            },
            costureiro: {
                title: "Costureiro", icon: "scissors",
                skills: ["Enganação", "Furtividade"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Economias.", weight: "0.5 kg" },
                    { name: "Ferramentas de Costura", type: "item", desc: "Agulhas e linhas.", weight: "1 kg" },
                    { name: "Roupa de Costureiro", type: "armor", ac: "11 + Des", props: "Leve", weight: "2 kg" }
                ],
                desc: "Paixão por tecidos e moda. Cria uniformes e disfarces."
            },
            cozinheiro: {
                title: "Cozinheiro", icon: "utensils",
                skills: ["História", "Persuasão"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d12 x 1000", desc: "Lucros.", weight: "0.5 kg" },
                    { name: "Utensílios de Cozinheiro", type: "item", desc: "Panelas e facas.", weight: "2 kg" }
                ],
                desc: "Mestre dos sabores. Suas refeições curam e abrem portas."
            },
            estudioso: {
                title: "Estudioso", icon: "book",
                skills: ["História", "Intuição"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d12 x 1000", desc: "Fundos.", weight: "0.5 kg" },
                    { name: "Livros de Pesquisa", type: "item", desc: "Conhecimento.", weight: "3 kg" }
                ],
                desc: "Busca incansável pelo saber. Resolve enigmas."
            },
            ferreiro: {
                title: "Ferreiro", icon: "hammer",
                skills: ["História", "Percepção"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Dinheiro do ofício.", weight: "0.5 kg" },
                    { name: "Ferramentas de Ferreiro", type: "item", weight: "5 kg" }
                ],
                desc: "Mestre do metal e forja. Cria e repara as melhores lâminas."
            },
            ladrao: {
                title: "Ladrão", icon: "footprints",
                skills: ["Enganação", "Furtividade"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d12 x 1000", desc: "Dinheiro 'encontrado'.", weight: "0.5 kg" },
                    { name: "Ferramentas de Ladrão", type: "item", weight: "1 kg" }
                ],
                desc: "Vive nas sombras. Mestre do engano e da apropriação."
            },
            medico: {
                title: "Médico", icon: "activity",
                skills: ["Medicina", "Natureza"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Pagamentos.", weight: "0.5 kg" },
                    { name: "Kit de Primeiros Socorros", type: "consumable", props: "1d8+4", weight: "1 kg" },
                    { name: "Kit de Herbalismo", type: "item", weight: "1 kg" }
                ],
                desc: "Dedicação à cura. Salva vidas onde outros falham."
            },
            ninja: {
                title: "Ninja", icon: "ghost",
                skills: ["Acrobacia", "Furtividade"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Pagamento.", weight: "0.5 kg" },
                    { name: "Kunai (x5)", type: "weapon", dmg: "1d4 perfurante", props: "Arremesso" },
                    { name: "Bomba de Fumaça (x2)", type: "consumable", desc: "Escuridão." }
                ],
                desc: "Guerreiro das sombras. Mestre em infiltração."
            },
            orfao: {
                title: "Órfão", icon: "user",
                skills: ["Natureza", "Sobrevivência"],
                items: [
                    { name: "Bolsa de Ienes", type: "consumable", props: "3d10 x 1000", desc: "Esmolas.", weight: "0.5 kg" },
                    { name: "Adaga Velha", type: "weapon", dmg: "1d4 perfurante", props: "Leve" }
                ],
                desc: "Criado nas ruas frias. Resiliente e adaptável."
            },
            policial: {
                title: "Policial", icon: "shield",
                skills: ["Intuição", "Investigação"],
                items: [
                    { name: "Distintivo", type: "item", desc: "Identificação." },
                    { name: "Pistola", type: "weapon", dmg: "1d10 perfurante", props: "Distância" }
                ],
                desc: "Defensor da lei. Investigador nato."
            },
            religioso: {
                title: "Religioso", icon: "sun",
                skills: ["História", "Intuição"],
                items: [
                    { name: "Símbolo Sagrado", type: "item" },
                    { name: "Água Benta (x2)", type: "consumable" }
                ],
                desc: "Guiado pela fé e luz divina."
            },
            selvagem: {
                title: "Selvagem", icon: "tent",
                skills: ["Sobrevivência", "Natureza"],
                items: [
                    { name: "Armadilha de Urso", type: "item" },
                    { name: "Pele de Animal", type: "item" }
                ],
                desc: "Filho da natureza. Caçador primitivo."
            }
        };

        // Init Backgrounds
        const bgGrid = document.getElementById('bgGrid');
        Object.keys(backgroundData).forEach(key => {
            const bg = backgroundData[key];
            const el = document.createElement('div');
            el.className = `bg-card ${state.background === key ? 'selected' : ''}`;
            el.onclick = () => selectBg(key, el);
            el.innerHTML = `
                <div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:2rem; text-align:center;">
                    <i data-lucide="${bg.icon}" size="48" style="color:var(--blood-bright); margin-bottom:1rem;"></i>
                    <h3 style="color:white; font-family:var(--font-display); margin-bottom:0.5rem;">${bg.title}</h3>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:1rem;">${bg.desc}</p>
                    <div style="font-size:0.8rem; color:#666;">
                        <div><strong>Perícias:</strong> ${bg.skills.join(', ')}</div>
                    </div>
                </div>
            `;
            bgGrid.appendChild(el);
        });

        function selectBg(id, el) {
            state.background = id;
            document.querySelectorAll('#bgGrid .bg-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }



        // Init Parts
        const pContainer = document.getElementById('particularitiesRef');
        if (pContainer) {
            pContainer.innerHTML = '';
            PARTS.forEach(p => {
                const el = document.createElement('div');
                el.className = 'part-item';
                // CHANGE: onclick opens Modal now
                el.onclick = () => openPartDetails(p.id);
                el.id = `part-card-${p.id}`; // Add ID for selector ref
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px; color:white; font-weight:700;">
                        <i data-lucide="${p.icon}" style="width:18px;"></i> ${p.name}
                    </div>
                    <div style="font-size:0.85rem; color:#888;">${p.desc}</div>
                `;
                pContainer.appendChild(el);
            });
        }

        let tempPartId = null;

        function openPartDetails(pid) {
            tempPartId = pid;
            const part = PARTS.find(p => p.id === pid);
            if (!part) return;

            document.getElementById('pdTitle').innerText = part.name;
            document.getElementById('pdIcon').innerHTML = `<i data-lucide="${part.icon}" size="24"></i>`;
            document.getElementById('pdContent').innerText = part.full;

            // Update Button State
            const btn = document.getElementById('pdSelectBtn');
            const isSelected = state.particularities.includes(part.id);

            if (isSelected) {
                btn.innerHTML = `<i data-lucide="x"></i> REMOVER`;
                btn.style.background = "#333";
            } else {
                btn.innerHTML = `<i data-lucide="check"></i> SELECIONAR`;
                btn.style.background = "var(--blood-primary)";
            }

            lucide.createIcons();
            document.getElementById('partDetailModal').style.display = 'flex';
        }

        // Logic bound to the modal button
        document.getElementById('pdSelectBtn').onclick = function () {
            if (!tempPartId) return;

            const part = PARTS.find(p => p.id === tempPartId);

            // Toggle Logic
            if (state.particularities.includes(part.id)) {
                // Remove
                state.particularities = state.particularities.filter(x => x !== part.id);
                // Update UI Card
                document.getElementById(`part-card-${part.id}`).classList.remove('selected');
            } else {
                // Select (Check Limit)
                if (state.particularities.length >= 2) {
                    alert("Você já escolheu 2 particularidades.");
                    return;
                }
                state.particularities.push(part.id);
                document.getElementById(`part-card-${part.id}`).classList.add('selected');
            }

            document.getElementById('partCounter').innerText = `${state.particularities.length} / 2 Selecionado(s)`;

            // Close Modal or Update Button?
            // "Ao clicar... mostre tudo... Selecione" -> User likely wants to close after selection?
            // Or maybe toggle button state? Let's toggle button state to give feedback, then user closes manually or we close.
            // Let's close for smoother flow.
            document.getElementById('partDetailModal').style.display = 'none';

            updatePreview();
        };

        // --- ATTRIBUTE FUNCTIONS ---

        function toggleBonus(stat) {
            const index = state.bonuses.indexOf(stat);
            if (index > -1) {
                state.bonuses.splice(index, 1);
                document.querySelector(`button[data-attr="${stat}"]`).style.background = 'rgba(255,255,255,0.05)';
                document.querySelector(`button[data-attr="${stat}"]`).style.border = '1px solid #333';
            } else {
                if (state.bonuses.length >= 2) {
                    const first = state.bonuses.shift();
                    document.querySelector(`button[data-attr="${first}"]`).style.background = 'rgba(255,255,255,0.05)';
                    document.querySelector(`button[data-attr="${first}"]`).style.border = '1px solid #333';
                }
                state.bonuses.push(stat);
                document.querySelector(`button[data-attr="${stat}"]`).style.background = 'var(--blood-bright)';
                document.querySelector(`button[data-attr="${stat}"]`).style.border = '1px solid var(--blood-bright)';
            }
            // Recalculate if needed, but bonuses are separate here.
        }

        function openDiceModal() {
            document.getElementById('diceRollModal').style.display = 'flex';
        }

        function applyManualStats() {
            try {
                state.manualMode = true;
                ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
                    const input = document.getElementById('manual-' + stat);
                    let val = parseInt(input.value) || 10;
                    if (val > 20) val = 20; if (val < 1) val = 1;
                    state.stats[stat] = val;

                    const slider = document.getElementById('input-' + stat);
                    if (slider) slider.value = val;
                    const box = document.getElementById('val-' + stat);
                    if (box) box.innerText = val;
                });
                document.getElementById('pointsRemain').innerText = "Manual";
                document.getElementById('pointsRemain').style.color = "#aaa";
                document.getElementById('diceRollModal').style.display = 'none';
            } catch (e) {
                alert("Erro ao aplicar manual: " + e.message);
            }
        }

        function updateStat(stat, val) {
            try {
                val = parseInt(val);

                if (state.manualMode) {
                    state.stats[stat] = val;
                    document.getElementById('val-' + stat).innerText = val;
                    return;
                }

                if (typeof COSTS === 'undefined') { throw new Error("COSTS não definido"); }

                let usedPoints = 0;
                for (let key in state.stats) {
                    if (key !== stat) {
                        const sVal = state.stats[key];
                        const sCost = COSTS[sVal] !== undefined ? COSTS[sVal] : 0;
                        usedPoints += sCost;
                    }
                }

                const cost = COSTS[val] !== undefined ? COSTS[val] : 0;
                const newCost = usedPoints + cost;

                if (newCost > 27) {
                    const input = document.getElementById(`input-${stat}`);
                    if (input) input.value = state.stats[stat];

                    const ptLabel = document.getElementById('pointsRemain');
                    ptLabel.innerText = "SEM PONTOS!";
                    ptLabel.style.color = "red";
                    setTimeout(() => {
                        let currentUsed = 0;
                        for (let key in state.stats) {
                            const v = state.stats[key];
                            currentUsed += (COSTS[v] || 0);
                        }
                        ptLabel.innerText = 27 - currentUsed;
                        ptLabel.style.color = "";
                    }, 1000);
                    return;
                }

                state.stats[stat] = val;
                document.getElementById(`val-${stat}`).innerText = val;
                document.getElementById('pointsRemain').innerText = 27 - newCost;
                document.getElementById('pointsRemain').style.color = "";
            } catch (e) {
                console.error(e);
                alert("Erro no atributo: " + e.message);
            }
        }



        lucide.createIcons();


        function updateUI() {
            // Sections
            document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${currentStep}`).classList.add('active');

            // Sidebar
            document.querySelectorAll('.step-item').forEach((el, idx) => {
                const stepNum = idx + 1;

                // Active Class
                if (stepNum === currentStep) el.classList.add('active');
                else el.classList.remove('active');

                // Locked Class
                if (stepNum > state.maxStep) {
                    el.classList.add('locked');
                } else {
                    el.classList.remove('locked');
                }
            });

            // Buttons
            const btnNext = document.getElementById('nextBtn');
            const btnPrev = document.getElementById('prevBtn');

            btnPrev.style.visibility = currentStep === 1 ? 'hidden' : 'visible';

            if (currentStep === totalSteps) {
                btnNext.innerHTML = 'ACEITAR O SANGUE';
                btnNext.style.background = '#ff0000';
            } else {
                btnNext.innerHTML = 'PRÓXIMO <i data-lucide="arrow-right"></i>';
                btnNext.style.background = '#990000'; // Reset color
                lucide.createIcons();
            }
        }

        function nextStep() {
            if (currentStep === totalSteps) {
                finishCreation();
                return;
            }

            // Validation Logic (Optional, but user said "choice one... then press next to release")
            // We can assume pre-selected defaults (Blood, Ice) are valid.

            currentStep++;
            if (currentStep > state.maxStep) state.maxStep = currentStep;

            updateUI();
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        }

        function goToStep(s) {
            if (s > state.maxStep) return; // Prevent jumping ahead
            currentStep = s;
            updateUI();
        }

        function selectPath(id, el) {
            state.path = id;
            el.parentElement.querySelectorAll('.bg-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function selectKekk(id, el) {
            state.kekkijutsu = id;
            el.parentElement.querySelectorAll('.bg-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function finishCreation() {
            try {
                const selectedBg = state.background ? backgroundData[state.background] : null;
                // Safe access to items/skills
                const initialItems = (selectedBg && selectedBg.items) ? selectedBg.items.map(i => ({ ...i, id: Date.now() + Math.random() })) : [];
                const initialSkills = (selectedBg && selectedBg.skills) ? selectedBg.skills : [];

                // Apply Bonuses
                const finalAttributes = { ...state.stats };
                state.bonuses.forEach(b => {
                    if (finalAttributes[b] !== undefined) finalAttributes[b] += 2;
                });

                // Ensure PARTS is available
                if (typeof PARTS === 'undefined') throw new Error("PARTS data not found");

                const char = {
                    name: document.getElementById('oniName').value || 'Oni Desconhecido',
                    race: 'Oni',
                    oniPath: state.path,
                    kekkijutsu: state.kekkijutsu,
                    particularities: PARTS.filter(p => state.particularities.includes(p.id)).map(p => ({ name: p.name, effect: p.desc || p.full })),
                    attributes: finalAttributes,
                    bonuses: state.bonuses,
                    background: selectedBg ? selectedBg.title : 'Desconhecido',
                    proficiencies: initialSkills,
                    level: 1,
                    hp: 15 + Math.floor(((finalAttributes.con || 10) - 10) / 2),
                    currentHP: 15 + Math.floor(((finalAttributes.con || 10) - 10) / 2),
                    maxPE: 1,
                    currentPE: 1,
                    inventory: initialItems.length > 0 ? initialItems : [],
                    rank: 'Oni Inferior'
                };

                // Save to Save Slots
                let allChars = [];
                try {
                    const stored = localStorage.getItem('demonSlayerSaveSlots');
                    if (stored) allChars = JSON.parse(stored);
                } catch (e) {
                    console.error("Error reading slots", e);
                    allChars = [];
                }

                if (allChars.length >= 5) { alert("Limite de personagens atingido."); return; }

                allChars.push(char);
                localStorage.setItem('demonSlayerSaveSlots', JSON.stringify(allChars));
                localStorage.setItem('demonSlayerChar', JSON.stringify(char)); // Set active

                console.log("Character saved. Redirecting...");
                // Redirect
                window.location.href = 'oni-dashboard.html';
            } catch (err) {
                console.error(err);
                alert("Erro ao finalizar criação: " + err.message);
            }
        }

        window.onload = function () {
            updateUI();
        }
        function updatePreview() {
            // Name
            const nameInput = document.getElementById('oniName');
            const nameDisplay = document.getElementById('previewName');
            if (nameInput && nameDisplay) {
                nameDisplay.innerText = nameInput.value || "Oni Desconhecido";
            }

            // Path
            const pathDisplay = document.getElementById('previewPath');
            if (pathDisplay) pathDisplay.innerText = state.path === 'blood' ? 'Caminho do Sangue' : 'Retenção de Carne';

            // Kekkijutsu
            const kekkDisplay = document.getElementById('previewKekk');
            const kekkMap = { 'ice': 'Criocinese', 'swamp': 'Pântano', 'arrow': 'Vetores', 'sound': 'Ondas Sonoras', 'shadow': 'Sombras', 'blood_manip': 'Manipulação de Sangue' };
            if (kekkDisplay) kekkDisplay.innerText = kekkMap[state.kekkijutsu] || state.kekkijutsu;

            // Background
            const bgDisplay = document.getElementById('previewBg');
            const bgData = backgroundData ? backgroundData[state.background] : null;
            if (bgDisplay) bgDisplay.innerText = bgData ? bgData.title : '-';

            // HP Calculation
            // Base 15 + ((Con - 10) / 2) + Kekkijutsu Bonus? (Assuming no bonus for now unless specified)
            const con = state.stats.con || 10;
            const conMod = Math.floor((con - 10) / 2);
            let hp = 15 + conMod;
            const hpDisplay = document.getElementById('previewHP');
            if (hpDisplay) hpDisplay.innerText = hp;

            // Parts
            const partsDisplay = document.getElementById('previewParts');
            if (partsDisplay) {
                if (state.particularities.length === 0) {
                    partsDisplay.innerHTML = '<span style="opacity:0.5; font-style:italic;">Nenhuma selecionada</span>';
                } else {
                    partsDisplay.innerHTML = '';
                    state.particularities.forEach(pid => {
                        const part = PARTS.find(p => p.id === pid);
                        if (part) {
                            const div = document.createElement('div');
                            div.innerHTML = `<i data-lucide="${part.icon}" style="width:14px; margin-right:5px; vertical-align:middle;"></i> ${part.name}`;
                            partsDisplay.appendChild(div);
                        }
                    });
                    lucide.createIcons();
                }
            }

            // Speed
            // Default 9m. Can be modified by parts if we had speed parts.
            // Ex: If 'size' part selected (Alteração Corporal) implies speed change? (Desc says Agility/Stealth).
            // For now fixed 9m.
            const speedDisplay = document.getElementById('previewSpeed');
            if (speedDisplay) speedDisplay.innerText = "9m";

        }

        // Hook updatePreview into existing functions
        const originalUpdateStat = updateStat;
        updateStat = function (stat, val) {
            originalUpdateStat(stat, val);
            updatePreview();
        };

        const originalSelectPath = selectPath;
        selectPath = function (path, el) {
            originalSelectPath(path, el);
            updatePreview();
        }

        const originalSelectKekk = selectKekk;
        selectKekk = function (kekk, el) {
            originalSelectKekk(kekk, el);
            updatePreview();
        }

        const originalSelectBg = selectBg;
        selectBg = function (id, el) {
            originalSelectBg(id, el);
            updatePreview();
        }

        const originalTogglePart = togglePart;
        togglePart = function (id, el) {
            originalTogglePart(id, el);
            updatePreview();
        }

        // Init
        setTimeout(updatePreview, 500);

    </script>
</body>

</html>