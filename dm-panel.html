<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel do Mestre - Demon Slayer RPG</title>
    <!-- Use the same CSS file name as established -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* WISTERIA THEME - MINIMALIST */
            --primary: #a855f7;
            --primary-dark: #7e22ce;
            --primary-light: #d8b4fe;
            --bg-dark: #09090b;
            /* Pitch black */
            --surface-dark: transparent;
            /* Minimalist transparent */
            --border-dark: #27272a;
            /* Zinc-800 */
            --accent-purple: #c084fc;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            /* Zinc-400 */
            --danger: #ef4444;

            /* Status Colors */
            --hp-high: #22c55e;
            --hp-mid: #eab308;
            --hp-low: #ef4444;
            --blood-red: #b91c1c;

            /* Global */
            --font-display: 'Inter', sans-serif;
            /* Modern sans */
            --font-body: 'Inter', sans-serif;
        }

        [data-theme="wisteria"] {
            /* Keep overrides if needed, but aligning to minimalist */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- SPLIT VIEW LAYOUT --- */
        .wis-app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-dark);
        }

        /* LEFT SIDEBAR (NPC LIBRARY) */
        .wis-sidebar {
            width: 30%;
            min-width: 300px;
            max-width: 450px;
            background: var(--surface-dark);
            border-right: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            z-index: 20;
            /* No shadow requested */
        }

        .wis-sidebar-header {
            padding: 24px;
            /* Increased whitespace */
            border-bottom: 1px solid var(--border-dark);
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .wis-search-box {
            position: relative;
        }

        .wis-search-input {
            width: 100%;
            background: transparent;
            /* Transparent input */
            border: 1px solid var(--border-dark);
            padding: 10px 12px 10px 36px;
            border-radius: 8px;
            /* Softer transition */
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .wis-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .wis-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .wis-add-btn {
            background: transparent;
            /* Remove solid bg */
            color: var(--primary);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .wis-add-btn:hover {
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.05);
        }

        .wis-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* ACCORDION SYSTEM */
        .wis-accordion-item {
            margin-bottom: 8px;
            border: 1px solid transparent;
            /* Hidden by default */
            border-radius: 8px;
            background: transparent;
            overflow: hidden;
        }

        .wis-accordion-header {
            padding: 12px 16px;
            background: transparent;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .wis-accordion-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .wis-accordion-title {
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .wis-accordion-count {
            font-size: 0.75rem;
            color: #71717a;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .wis-accordion-body {
            display: none;
            /* Hidden by default */
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border-dark);
        }

        .wis-accordion-item.active .wis-accordion-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* FIX SELECT OPTION VISIBILITY */
        select.d-input option {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        select.d-input {
            background-color: transparent;
            color: #ffffff;
        }

        /* Specific override just in case */
        #newNpcStyle option {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        flex-direction: column;
        gap: 6px;
        }

        .wis-accordion-chevron {
            transition: transform 0.2s;
        }

        .wis-accordion-item.active .wis-accordion-chevron {
            transform: rotate(180deg);
        }

        /* NPC CARDS (In List) */
        .wis-npc-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wis-npc-card:hover {
            background: rgba(255, 255, 255, 0.02);
            border-color: var(--border-dark);
        }

        .wis-npc-card.selected {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid var(--primary);
            border-left: 4px solid var(--primary);
            /* Prominent active state */
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.1);
        }

        .wis-npc-avatar {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            /* Squircle */
            background: #27272a;
            object-fit: cover;
            border: 1px solid var(--border-dark);
        }

        .wis-npc-info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wis-npc-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wis-npc-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* RIGHT WORKSPACE */
        .wis-workspace {
            flex: 1;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Background Pattern for Workspace - Much subtler */
        .wis-workspace-bg {
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(circle at top right, rgba(168, 85, 247, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .wis-workspace-content {
            position: relative;
            z-index: 10;
            height: 100%;
            overflow-y: auto;
            padding: 32px;
            /* Increased padding */
        }

        /* EMPTY STATE / DASHBOARD */
        .wis-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .wis-empty-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        /* DM SHEET HEADER */
        .wis-sheet-header {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 40px;
            background: transparent;
            /* No background */
            padding: 0;
            /* Removing container padding */
            border: none;
            backdrop-filter: none;
        }

        .wis-sheet-avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            /* Squircle */
            border: 1px solid var(--border-dark);
            background: #27272a;
            object-fit: cover;
            /* No shadow */
        }

        .wis-sheet-title h1 {
            font-family: var(--font-display);
            margin: 0;
            font-size: 2.2rem;
            color: var(--text-main);
            line-height: 1.1;
        }

        .wis-sheet-subtitle {
            color: var(--primary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* SHEET STATS GRID */
        .wis-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .wis-stat-box {
            background: transparent;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .wis-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .wis-stat-mod {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .wis-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 600;
        }

        .wis-combat-sidebar {
            width: 300px;
            background: var(--surface-dark);
            /* Transparent */
            border-left: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            z-index: 15;
            transition: width 0.3s ease, transform 0.3s ease;
            backdrop-filter: blur(10px);
            /* Slight blur for sidebar overlay feel if needed */
        }

        .wis-combat-sidebar.collapsed {
            width: 0;
            transform: translateX(100%);
        }

        .wis-combat-header {
            padding: 16px;
            background: transparent;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- TREE VIEW STYLES (Windows-like) --- */
        .wis-tree-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 5px 0;
            width: 100%;
            min-height: 50px;
        }

        .wis-tree-folder {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .wis-tree-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            color: #e4e4e7;
            font-size: 0.9rem;
            transition: background 0.15s;
            user-select: none;
        }

        .wis-tree-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .wis-tree-header .icon-chevron {
            transition: transform 0.2s;
        }

        .wis-tree-folder.active>.wis-tree-header .icon-chevron {
            transform: rotate(90deg);
        }

        .wis-tree-children {
            display: none;
            flex-direction: column;
            gap: 1px;
            padding-left: 10px;
            /* Indentation */
            margin-left: 9px;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            /* Guide Line */
        }

        .wis-tree-folder.active>.wis-tree-children {
            display: flex;
        }

        .wis-tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #a1a1aa;
            transition: all 0.15s;
        }

        .wis-tree-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .wis-tree-item.selected {
            background: rgba(168, 85, 247, 0.15);
            color: var(--primary);
            border-left: 3px solid var(--primary);
            /* Accent mark */
        }

        .wis-tree-item-avatar {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            object-fit: cover;
            background: #333;
        }

        /* Hide old accordion styles if needed, or just overwrite usage */

        .wis-combat-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .combatant-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            position: relative;
            transition: all 0.2s;
        }

        .combatant-card.active-turn {
            border-color: var(--primary);
            box-shadow: none;
            /* Removed glow */
            background: rgba(168, 85, 247, 0.05);
            /* Very subtle tint */
            transform: scale(1.0);
            /* Removed scale */
        }

        .combatant-init-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-dark);
            min-width: 35px;
        }

        .init-val {
            font-weight: 600;
            color: var(--text-main);
        }

        .init-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .combatant-info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .combatant-name {
            font-weight: 600;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        /* Seamless Input Style */
        .ds-seamless-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: #fafafa;
            transition: all 0.2s;
            border-radius: 4px;
            padding: 4px;
        }

        .ds-seamless-input:hover {
            border-bottom-color: #52525b;
        }

        .ds-seamless-input:focus {
            background: #27272a;
            border-bottom-color: #a1a1aa;
            outline: none;
        }

        .ds-seamless-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: #ccc;
            /* Slightly dimmer for body text */
            transition: all 0.2s;
            border-radius: 4px;
            padding: 6px;
            font-family: inherit;
        }

        .ds-seamless-textarea:hover {
            border-bottom-color: #52525b;
        }

        .ds-seamless-textarea:focus {
            background: #27272a;
            border-bottom-color: #a1a1aa;
            outline: none;
            color: #fff;
        }

        /* Skills Section Styling */
        .wis-skill-group {
            margin-bottom: 8px;
        }

        .wis-skill-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #a1a1aa;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 6px;
        }

        .wis-skill-header i {
            color: var(--primary);
            opacity: 0.8;
        }

        .wis-skill-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wis-skill-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: default;
            border: 1px solid transparent;
        }

        .wis-skill-row:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .wis-skill-name-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wis-skill-dot {
            width: 4px;
            height: 4px;
            background: #444;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .wis-skill-row:hover .wis-skill-dot {
            background: var(--primary);
            box-shadow: 0 0 5px var(--primary);
        }

        .wis-skill-name {
            color: #d4d4d8;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }

        .wis-skill-name:hover {
            color: #fff;
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.2);
        }

        .wis-skill-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wis-skill-mod {
            font-size: 0.8rem;
            font-weight: 700;
            color: #71717a;
            background: rgba(0, 0, 0, 0.2);
            padding: 1px 6px;
            border-radius: 4px;
            min-width: 24px;
            text-align: center;
        }

        .wis-skill-row:hover .wis-skill-mod {
            color: #fff;
            background: rgba(0, 0, 0, 0.4);
        }

        .wis-skill-roll-btn {
            color: #a855f7;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .wis-skill-row:hover .wis-skill-roll-btn {
            opacity: 1;
            transform: scale(1);
        }

        .wis-skill-roll-btn:hover {
            color: #c084fc;
            transform: scale(1.2) rotate(15deg);
        }

        /* Scrollbar styling for cleanliness */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #18181b;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-main);
        }

        .combatant-hp {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .combat-dock {
            padding: 16px;
            border-top: 1px solid var(--border-dark);
            background: transparent;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Conditions Tags */
        .cond-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-dark);
            color: var(--text-muted);
            margin-right: 4px;
        }

        .noise-overlay {
            display: none;
            /* Removing noise overlay entirely as per request for cleanliness */
        }

        /* General UI */
        .btn {
            background: transparent;
            border: 1px solid var(--border-dark);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.05);
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            border: 1px solid var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-danger {
            border-color: var(--danger);
            background: transparent;
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .d-input {
            background: transparent;
            border: 1px solid var(--border-dark);
            color: var(--text-main);
            padding: 10px;
            border-radius: 8px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .d-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        /* DICE SYSTEM & TOAST */
        .dice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .dice-wrapper {
            perspective: 600px;
            width: 100px;
            height: 100px;
            margin-bottom: 50px;
        }

        .dice-cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: translateZ(-50px);
            transition: transform 1s;
        }

        .dice-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: var(--surface-dark);
            border: 2px solid var(--primary);
            color: white;
            font-size: 40px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5) inset;
        }

        .dice-face.front {
            transform: rotateY(0deg) translateZ(50px);
        }

        .dice-face.right {
            transform: rotateY(90deg) translateZ(50px);
        }

        .dice-face.back {
            transform: rotateY(180deg) translateZ(50px);
        }

        .dice-face.left {
            transform: rotateY(-90deg) translateZ(50px);
        }

        .dice-face.top {
            transform: rotateX(90deg) translateZ(50px);
        }

        .dice-face.bottom {
            transform: rotateX(-90deg) translateZ(50px);
        }

        #diceResultDisplay {
            font-size: 3rem;
            font-weight: 800;
            color: #fff;
            font-family: var(--font-display);
            text-shadow: 0 0 20px var(--primary);
            min-height: 60px;
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #18181b;
            border: 1px solid var(--border-dark);
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .token-hp-bar {
            width: 80px;
            height: 4px;
            background: #222;
            margin-top: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .token-hp-val {
            height: 100%;
            background: var(--hp-high);
            transition: width 0.3s;
        }

        .log-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--primary);
            padding: 12px;
            border-radius: 0 6px 6px 0;
            font-size: 0.85rem;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .creator-stat-box {
            background: transparent;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .creator-stat-box .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .creator-stat-box .stat-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-family: var(--font-display);
            font-size: 1.5rem;
            text-align: center;
            outline: none;
        }

        .creator-stat-box .mod {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
        }

        /* Responsive stack for smaller screens if needed (not implementing fully now but good practice) */

        .action-card {
            background: transparent;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .action-card.editing {
            border-color: var(--primary);
            background: rgba(168, 85, 247, 0.05);
        }

        .action-header {
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .action-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .action-body {
            padding: 16px;
            border-top: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: transparent;
        }

        .action-preview-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-dark);
            color: var(--text-muted);
            margin-left: 5px;
        }
    </style>
</head>

<body data-theme="wisteria">
    <div class="noise-overlay"></div>

    <div class="wis-app-layout">
        <!-- LEFT SIDEBAR: NPC LIBRARY -->
        <div class="wis-sidebar">
            <div class="wis-sidebar-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="wis-title">Biblioteca de NPCs</div>
                    <div style="display:flex; gap:8px;">
                        <button class="wis-add-btn" id="newFolderBtn" onclick="toggleNewFolderInput()"
                            title="Nova Pasta" style="padding:6px; background:rgba(255,255,255,0.05);">
                            <i data-lucide="folder-plus" size="14"></i>
                        </button>
                        <button class="wis-add-btn" onclick="window.location.href='create-character.html?mode=npc'"
                            title="Criar Full Sheet">
                            <i data-lucide="user-plus" size="14"></i>
                        </button>
                    </div>
                </div>

                <div id="newFolderInputContainer" style="display:none; margin-top:10px;">
                    <input type="text" id="newFolderInput" class="wis-search-input"
                        placeholder="Nome da pasta e Enter..." onkeydown="handleNewFolderKey(event)"
                        style="border-color:var(--primary);">
                </div>

                <div class="wis-search-box">
                    <i data-lucide="search" size="14" class="wis-search-icon"></i>
                    <input type="text" class="wis-search-input" placeholder="Buscar NPC..."
                        onkeyup="filterSidebar(this.value)">
                </div>

                <button class="wis-add-btn" onclick="openNpcCreator()" style="width:100%;">
                    <i data-lucide="plus-circle" size="16"></i> Criar NPC
                </button>
            </div>

            <div class="wis-sidebar-content" id="sidebarContent">
                <!-- ACCORDION ITEMS (Injected via JS) -->
            </div>
        </div>

        <!-- RIGHT WORKSPACE -->
        <div class="wis-workspace" id="workspaceArea">
            <div class="wis-workspace-bg"></div>

            <div class="wis-workspace-content" id="mainWorkspace">
                <!-- DEFAULT STATE: EMPTY -->
                <div id="sessionDashboardState"
                    style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:#555;">
                    <i data-lucide="user-search" size="48" style="margin-bottom:20px; opacity:0.3;"></i>
                    <h2 style="font-size:1.5rem; margin-bottom:10px; color:#ddd;">Nenhum NPC Selecionado</h2>
                    <p>Selecione um NPC na lista à esquerda ou crie um novo.</p>
                </div>

                <!-- DM SHEET STATE (Hidden by default) -->
                <div id="dmSheetState" style="display:none; height:100%; flex-direction:column;">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

        <!-- RIGHT COMBAT SIDEBAR -->
        <div class="wis-combat-sidebar collapsed" id="combatSidebar">
            <div class="wis-combat-header">
                <div class="wis-title" style="font-size:1rem;">Iniciativa</div>
                <button class="btn-icon" onclick="toggleCombatSidebar()"
                    style="background:none; border:none; color:#fff; cursor:pointer;">
                    <i data-lucide="x" size="18"></i>
                </button>
            </div>

            <div class="wis-combat-list" id="combatList">
                <div style="text-align:center; padding:20px; color:#555; font-size:0.8rem;">
                    Adicione combatentes pela lista de NPCs
                </div>
            </div>

            <div class="combat-dock">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="font-size:0.7rem; color:#777;">ROUND <span id="combatRound">1</span></div>
                    <button class="btn" onclick="nextTurn()" style="background:var(--primary); color:#fff; width:100%;">
                        Próximo Turno
                    </button>
                </div>
                <button class="btn" onclick="openConditionModal()"
                    style="width:100%; background:#27272a; border:1px solid #333;">
                    <i data-lucide="zap" size="14"></i> Add Condição
                </button>
                <div style="display:flex; gap:5px;">
                    <button class="btn" onclick="sortCombat()"
                        style="flex:1; font-size:0.75rem; padding:4px;">Ordenar</button>
                    <button class="btn btn-danger" onclick="clearCombat()"
                        style="flex:1; font-size:0.75rem; padding:4px;">Limpar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- NPC CREATOR MODAL (Detailed) -->
    <div id="npcCreatorModal" class="modal-overlay" onclick="if(event.target===this) closeNpcCreator()">
        <div
            style="background:#18181b; padding:25px; border-radius:12px; width:700px; max-height:90vh; overflow-y:auto; border:1px solid var(--border-dark); display:flex; flex-direction:column; gap:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 class="wis-title" style="font-size:1.4rem;">Novo NPC</h2>
                <button class="btn-icon" onclick="closeNpcCreator()"><i data-lucide="x"></i></button>
            </div>

            <!-- SECTION A: PERSONAL DATA -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label" style="display:block; margin-bottom:15px; font-size:1rem;">Dados
                    Pessoais</label>

                <!-- Name & Style -->
                <!-- Identity Grid (5 Columns: 2fr 1.5fr 1fr 1fr 1fr) -->
                <div style="display:grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
                    <div>
                        <label class="wis-stat-label">Nome *</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="newNpcName" class="d-input" style="flex:1;" placeholder="Nome do NPC"
                                required>
                            <button class="btn-icon" type="button" onclick="generateRandomNpcName()"
                                title="Gerar Nome Aleatório"
                                style="background:rgba(255,255,255,0.05); border:1px solid var(--border-dark); padding:0 10px; cursor:pointer; border-radius:8px;">
                                <i data-lucide="dices" size="16"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="wis-stat-label">Raça</label>
                        <select id="newNpcRace" class="d-input" style="width:100%;">
                            <option value="Humano">Humano</option>
                            <option value="Oni">Oni</option>
                            <option value="Animal">Animal</option>
                        </select>
                    </div>
                    <div>
                        <label class="wis-stat-label">Idade</label>
                        <input type="number" id="newNpcAge" class="d-input" style="width:100%;" placeholder="Ex: 25">
                    </div>
                    <div>
                        <label class="wis-stat-label">Altura</label>
                        <input type="text" id="newNpcHeight" class="d-input" style="width:100%;" placeholder="Ex: 1.75">
                    </div>
                    <div>
                        <label class="wis-stat-label">Peso</label>
                        <input type="text" id="newNpcWeight" class="d-input" style="width:100%;" placeholder="Ex: 70kg">
                    </div>
                </div>

                <!-- Breathing Style (Moved below Identity) -->
                <div style="margin-bottom:12px;">
                    <label class="wis-stat-label">Respiração</label>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <select id="newNpcStyle" class="d-input" style="width:100%;">
                            <option value="Água">Água</option>
                            <option value="Chamas">Chamas</option>
                            <option value="Trovão">Trovão</option>
                            <option value="Fera">Fera</option>
                            <option value="Som">Som</option>
                            <option value="Vento">Vento</option>
                            <option value="Lua">Lua</option>
                            <option value="Inseto">Inseto</option>
                            <option value="Flor">Flor</option>
                            <option value="Serpente">Serpente</option>
                            <option value="Amor">Amor</option>
                            <option value="Névoa">Névoa</option>
                            <option value="Pedra">Pedra</option>
                            <option value="Sol">Sol</option>
                            <option value="Nenhuma" selected>Nenhuma</option>
                            <option value="custom">Outra / Personalizada</option>
                        </select>
                        <div id="customStyleContainer" style="display:none; margin-top:8px;">
                            <input type="text" id="newNpcStyleCustom" class="d-input" style="width:100%;"
                                placeholder="Nome da Respiração">
                        </div>
                    </div>
                </div>

                <!-- Folder / Category -->
                <div style="margin-bottom:12px;">
                    <label class="wis-stat-label">Pasta / Categoria</label>
                    <select id="newNpcFolder" class="d-input" style="width:100%;">
                        <option value="">Sem Pasta (Raiz)</option>
                        <!-- Dynamic Options via JS -->
                    </select>
                </div>

                <!-- Hidden inputs for legacy compatibility if needed (Race/Class defaults) -->
                <!-- We'll treat them as hidden/defaults for now since user removed them from UI -->
                <input type="hidden" id="newNpcRace" value="Humano">
                <input type="hidden" id="newNpcClass" value="Desconhecido">
            </div>

            <!-- SECTION B: LEVEL & ENERGY -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label" style="display:block; margin-bottom:15px; font-size:1rem;">Nível &
                    Energia</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label class="wis-stat-label">Nível (1-20) *</label>
                        <input type="number" id="newNpcLevel" class="d-input" style="width:100%;" value="1" min="1"
                            max="20" oninput="autoFillPE()" required>
                    </div>
                    <div>
                        <label class="wis-stat-label">PE - Pontos de Energia</label>
                        <input type="number" id="newNpcPE" class="d-input" style="width:100%;" value="1"
                            placeholder="Auto-preenchido">
                        <small style="color:var(--text-muted); font-size:0.75rem;">Auto-preenchido igual ao
                            Nível</small>
                    </div>
                </div>
            </div>

            <!-- SECTION C: ATTRIBUTES & COMBAT -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label" style="display:block; margin-bottom:15px; font-size:1rem;">Atributos &
                    Combate</label>

                <!-- Attributes Row (Fixed 6 Fields) -->
                <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; margin-bottom:15px;">
                    <div class="creator-stat-box">
                        <div class="label">FOR</div>
                        <input type="number" id="attrStr" class="stat-input" value="10" oninput="updateMod('Str')">
                        <div class="mod" id="modStr">+0</div>
                    </div>
                    <div class="creator-stat-box">
                        <div class="label">DES</div>
                        <input type="number" id="attrDex" class="stat-input" value="10" oninput="updateMod('Dex')">
                        <div class="mod" id="modDex">+0</div>
                    </div>
                    <div class="creator-stat-box">
                        <div class="label">CON</div>
                        <input type="number" id="attrCon" class="stat-input" value="10" oninput="updateMod('Con')">
                        <div class="mod" id="modCon">+0</div>
                    </div>
                    <div class="creator-stat-box">
                        <div class="label">INT</div>
                        <input type="number" id="attrInt" class="stat-input" value="10" oninput="updateMod('Int')">
                        <div class="mod" id="modInt">+0</div>
                    </div>
                    <div class="creator-stat-box">
                        <div class="label">SAB</div>
                        <input type="number" id="attrWis" class="stat-input" value="10" oninput="updateMod('Wis')">
                        <div class="mod" id="modWis">+0</div>
                    </div>
                    <div class="creator-stat-box">
                        <div class="label">CAR</div>
                        <input type="number" id="attrCha" class="stat-input" value="10" oninput="updateMod('Cha')">
                        <div class="mod" id="modCha">+0</div>
                    </div>
                </div>

                <!-- Combat Stats Row -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label class="wis-stat-label">Vida Máxima (HP)</label>
                        <input type="number" id="newNpcHP" class="d-input" style="width:100%;" value="10"
                            placeholder="Pontos de Vida">
                    </div>
                    <div>
                        <label class="wis-stat-label">Classe de Armadura (CA)</label>
                        <input type="number" id="newNpcAC" class="d-input" style="width:100%;" value="10"
                            placeholder="Defesa">
                    </div>
                </div>
            </div>

            <!-- SECTION D: EQUIPMENT -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label"
                    style="display:block; margin-bottom:15px; font-size:1rem;">Equipamento</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <!-- Column 1: Weapon -->
                    <div>
                        <label class="wis-stat-label">Arma / Nichirin</label>
                        <select id="newNpcWeapon" class="d-input" style="width:100%; margin-bottom:8px;">
                            <option value="katana">Katana Padrão (1d8)</option>
                            <option value="dual_nichirin">Nichirin Dupla (1d6)</option>
                            <option value="axe_flail">Machadinha e Mangual (Gyomei)</option>
                            <option value="whip">Lâmina Chicote (Mitsuri)</option>
                            <option value="unarmed" selected>Desarmado / Garras (Oni)</option>
                        </select>
                        <input type="text" id="newNpcWeaponName" class="d-input" style="width:100%;"
                            placeholder="Nome da Arma (Opcional)">
                    </div>

                    <!-- Column 2: Armor -->
                    <div>
                        <label class="wis-stat-label">Traje</label>
                        <select id="newNpcArmor" class="d-input" style="width:100%;">
                            <option value="slayer_uniform">Uniforme Padrão (CA 12 + Des)</option>
                            <option value="haori">Haori Reforçado (CA 13 + Des)</option>
                            <option value="none" selected>Sem Armadura (CA 10 + Des)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION D: SKILLS -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label"
                    style="display:block; margin-bottom:15px; font-size:1rem;">Perícias</label>
                <div id="skillsGrid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                    <!-- Skill checkboxes -->
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Atletismo"> Atletismo
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Acrobacia"> Acrobacia
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Percepção"> Percepção
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Furtividade"> Furtividade
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Investigação"> Investigação
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Enganação"> Enganação
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Intimidação"> Intimidação
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Persuasão"> Persuasão
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; color:var(--text-main); font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" class="skill-checkbox" value="Sobrevivência"> Sobrevivência
                    </label>
                </div>
            </div>

            <!-- SECTION E: ACTIONS & ABILITIES -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <label class="wis-stat-label" style="font-size:1rem;">Ações e Habilidades</label>
                    <button class="btn btn-sm" onclick="addNewAction()" type="button">+ Nova Ação</button>
                </div>
                <div id="npcActionList" style="display:flex; flex-direction:column; gap:8px;">
                    <!-- Actions rendered here by JS -->
                </div>
            </div>

            <!-- NOTES / LORE -->
            <div style="background:transparent; padding:20px; border:1px solid var(--border-dark); border-radius:12px;">
                <label class="wis-stat-label" style="display:block; margin-bottom:8px;">Anotações / Lore</label>
                <textarea id="newNpcNotes" class="d-input" rows="3" style="width:100%; resize:vertical;"
                    placeholder="História, peculiaridades ou anotações do mestre..."></textarea>
            </div>





            <!-- COMBAT RESOURCES SECTION -->
            <div style="background:#202025; padding:15px; border-radius:8px;">
                <label class="wis-stat-label" style="margin-bottom:10px; display:block;">Recursos de Combate</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <!-- BP Energy -->
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label class="wis-stat-label">Pontos de Respiração (BP)</label>
                            <input type="number" id="newNpcBP" class="d-input" style="width:100%;" value="10">
                        </div>
                        <div style="flex:1;">
                            <label class="wis-stat-label">BP Atual</label>
                            <input type="number" id="newNpcBPCurr" class="d-input" style="width:100%;" value="10">
                        </div>
                    </div>
                    <!-- Save DC -->
                    <div>
                        <label class="wis-stat-label">CD (Save DC) <span
                                style="font-size:0.7em; color:#777;">(8+Prof+Attr)</span></label>
                        <input type="number" id="newNpcDC" class="d-input" style="width:100%;" value="12">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">
                    <!-- Passive Senses -->
                    <div>
                        <label class="wis-stat-label">Percepção Passiva</label>
                        <input type="number" id="newNpcPassivePerception" class="d-input" style="width:100%;"
                            value="10">
                    </div>
                    <div>
                        <label class="wis-stat-label">Intuição Passiva</label>
                        <input type="number" id="newNpcPassiveInsight" class="d-input" style="width:100%;" value="10">
                    </div>
                </div>
            </div>

            <!-- DERIVED STATS -->
            <div style="background:#202025; padding:15px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <label class="wis-stat-label">Estatísticas de Combate</label>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="checkbox" id="manualOverride" onchange="toggleManualOverride()">
                        <label for="manualOverride" style="font-size:0.8rem; color:#aaa;">Modo Manual</label>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px;">
                    <div>
                        <label class="wis-stat-label">HP Máximo</label>
                        <input type="number" id="derivHP" class="d-input" style="width:100%; text-align:center;"
                            value="10" disabled>
                    </div>
                    <div>
                        <label class="wis-stat-label">Classe de Armadura</label>
                        <input type="number" id="derivAC" class="d-input" style="width:100%; text-align:center;"
                            value="10" disabled>
                    </div>
                    <div>
                        <label class="wis-stat-label">Iniciativa</label>
                        <input type="number" id="derivInit" class="d-input" style="width:100%; text-align:center;"
                            value="0" disabled>
                    </div>
                    <div>
                        <label class="wis-stat-label">Deslocamento</label>
                        <input type="text" id="derivSpeed" class="d-input" style="width:100%; text-align:center;"
                            value="9m">
                    </div>
                </div>
            </div>

            <!-- MODAL FOOTER -->
            <div
                style="margin-top:24px; padding-top:20px; border-top:1px solid var(--border-dark); display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn"
                    style="background:transparent; border:1px solid var(--border-dark); color:var(--text-muted); padding:10px 24px;"
                    onclick="closeNpcCreator()">Cancelar</button>
                <button class="btn btn-primary" style="padding:10px 24px; font-weight:600;"
                    onclick="confirmNpcCreation()">Salvar NPC</button>
            </div>
        </div>
    </div>



    <!-- Dice Roll / Init Prompt -->
    <div id="initPromptModal" class="modal-overlay" onclick="if(event.target===this) closeInitPrompt()">
        <div
            style="background:#18181b; padding:20px; border-radius:12px; width:300px; border:1px solid var(--border-dark); text-align:center;">
            <h3 class="wis-title" style="margin-bottom:15px;">Iniciativa</h3>
            <div id="initPromptName" style="margin-bottom:15px; color:#ccc;">Nome do NPC</div>
            <input type="number" id="initInput" class="d-input"
                style="width:100px; text-align:center; font-size:1.5rem; margin-bottom:20px;" value="0">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1;" onclick="rollInitForPrompt()">Rolar d20</button>
                <button class="btn btn-primary" style="flex:1;" onclick="confirmAddToCombat()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- DICE OVERLAY -->
    <div id="diceOverlay" class="dice-overlay" onclick="if(event.target===this) toggleDiceOverlay()">
        <div class="dice-wrapper">
            <div class="dice-cube" id="diceCube">
                <div class="dice-face front">20</div>
                <div class="dice-face back">1</div>
                <div class="dice-face right">5</div>
                <div class="dice-face left">15</div>
                <div class="dice-face top">10</div>
                <div class="dice-face bottom">2</div>
            </div>
        </div>
        <div id="diceResultDisplay"></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">
        <i data-lucide="info" size="20" style="color:var(--primary);"></i>
        <span id="toastMsg">Notificação</span>
    </div>

    <!-- SCRIPTS -->
    <script src="campaign.js"></script>
    <script src="bestiary_db.js"></script>
    <script src="npc_creator.js"></script>
    <!-- We'll remove bestiary logic from here and make it just a DB loader if needed, but keeping it simple for now -->

    <script>
        // --- ICONS ---
        // --- ICONS ---
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        } else {
            console.warn("Global: Lucide icons not available.");
        }

        // --- STATE ---
        const urlParams = new URLSearchParams(window.location.search);
        window.CAMP_ID = urlParams.get('id'); // Explicit global
        const CAMP_ID = window.CAMP_ID; // Local alias for convenience
        let currentCamp = null;
        let activeEntityId = null; // For sheet view

        // COMBAT STATE (Runtime)
        let combatItems = []; // { id, name, init, hp, maxHP, isPlayer, conditions:[] }
        let turnIndex = 0;
        let round = 1;
        let pendingCombatAdd = null; // { id, isPlayer, name, ... }

        // --- INIT ---
        // --- INIT ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log("INIT: DOMContentLoaded fired.");
            try {
                if (!CAMP_ID) {
                    console.error("INIT: No CAMP_ID found.");
                    // alert("ID da campanha não encontrado!");
                    // window.location.href = 'campaign-hub.html';
                    return;
                }

                console.log("INIT: Loading Campaign Data...");
                loadCampaignData();

                // Render basic UI
                console.log("INIT: Rendering Sidebar...");
                renderSidebar();

                console.log("INIT: Rendering Scenes...");
                renderScenes();

                // Set Date
                const dateEl = document.getElementById('currentSessionDate');
                if (dateEl) {
                    dateEl.innerText = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
            } catch (err) {
                console.error("INIT: Critical Error during initialization:", err);
                // alert("Erro de inicialização: " + err.message);
            }
        });

        // Fallback Force Render on Load
        window.addEventListener('load', function () {
            console.log("INIT: Window Load fired (Fallback).");
            const sb = document.getElementById('sidebarContent');
            // Check if empty or just comment
            if (sb && (!sb.children.length || sb.innerHTML.trim().startsWith('<!--'))) {
                console.warn("INIT: Sidebar seems empty, forcing renderSidebar().");
                renderSidebar();
            }
        });

        function infoLog(msg) {
            console.log(msg);
        }

        function loadCampaignData() {
            currentCamp = window.CampaignSystem.getCampaignById(CAMP_ID);
            if (!currentCamp) {
                alert("Campanha não encontrada!");
                window.location.href = 'campaign-hub.html';
                return;
            }
            renderLogs();
        }

        // --- SIDEBAR LOGIC (TREE VIEW) ---
        // --- SIDEBAR LOGIC (TREE VIEW) ---
        function renderSidebar() {
            console.log("renderSidebar: Starting...");
            try {
                const container = document.getElementById('sidebarContent');
                if (!container) {
                    console.error("renderSidebar: Sidebar container not found!");
                    return;
                }
                container.innerHTML = '<div class="wis-tree-container"></div>';
                const treeRoot = container.firstElementChild;

                if (!currentCamp) {
                    console.error("renderSidebar: currentCamp is null. Call loadCampaignData() first.");
                    container.innerHTML = '<div style="padding:10px;">Carregando dados...</div>';
                    return;
                }

                console.log("renderSidebar: Camp loaded", currentCamp.id);
                console.log("renderSidebar: Monsters count", currentCamp.monsters?.length);

                const players = currentCamp.players || [];
                const monsters = currentCamp.monsters || [];
                const folders = currentCamp.folders || ["Aliados", "Luas Superiores", "Onis Menores", "Aldeões"];

                // 1. Players Section (Root Node)
                renderTreeNode(treeRoot, "Jogadores", players, true, true);

                // 2. Prepare Groups for Monsters
                const groups = {};
                groups["Todos"] = [];
                // Ensure folders exist in groups
                folders.forEach(f => groups[f] = []);

                monsters.forEach(m => {
                    let target = m.folderId || m.category;
                    // Fix: Check if target folder actually exists in our groups
                    if (!target || !groups.hasOwnProperty(target)) {
                        groups["Todos"].push(m);
                    } else {
                        groups[target].push(m);
                    }
                });

                // 3. Render 'Todos' (Root Node)
                renderTreeNode(treeRoot, "Todos", groups["Todos"], false, true);

                // 4. Render Custom Folders (Root Nodes)
                folders.forEach(folderName => {
                    if (folderName === "Todos") return;
                    const list = groups[folderName] || [];

                    // Fix: Auto-expand folder if it contains the active entity
                    const isActiveFolder = list.some(m => m.id === activeEntityId);

                    renderTreeNode(treeRoot, folderName, list, false, isActiveFolder);
                });

                console.log("renderSidebar: Tree constructed. Initializing icons...");

                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                } else {
                    console.warn("renderSidebar: Lucide icons not available.");
                }

                console.log("renderSidebar: Finished.");
            } catch (e) {
                console.error("Error rendering sidebar:", e);
                const container = document.getElementById('sidebarContent');
                if (container) container.innerHTML = '<div style="color:red; padding:10px;">Erro ao renderizar: ' + e.message + '</div>';
            }
        }

        function renderTreeNode(parent, title, list, isPlayerGroup, forceOpen = false) {
            // console.log(`renderTreeNode: ${title} (${list.length} items)`); // Debug log
            const isActive = (forceOpen || title === "Todos") ? "active" : "";

            // Icons
            const iconName = (title === 'Jogadores') ? 'users' : (title === 'Todos' ? 'globe' : 'folder');
            const color = (title === 'Todos' ? '#3b82f6' : (title === 'Jogadores' ? '#a855f7' : '#eab308'));

            const node = document.createElement('div');
            node.className = `wis-tree-folder ${isActive}`;

            // Check for list content to avoid map errors if list is weird (though it should be array)
            const safeList = Array.isArray(list) ? list : [];

            node.innerHTML = `
                <div class="wis-tree-header" onclick="toggleTreeFolder(this)">
                    <i data-lucide="chevron-right" size="14" class="icon-chevron" style="color:#71717a;"></i>
                    <i data-lucide="${iconName}" size="16" color="${color}" style="color:${color}"></i>
                    <span>${title}</span>
                    <span style="font-size:0.7em; color:#555; margin-left:auto;">${safeList.length}</span>
                </div>
                <div class="wis-tree-children">
                    ${safeList.map(entity => renderTreeItem(entity, isPlayerGroup)).join('')}
                    ${safeList.length === 0 ? '<div style="font-size:0.75rem; color:#555; padding:4px 0 4px 20px;">(Vazio)</div>' : ''}
                </div>
             `;
            parent.appendChild(node);
        }

        function renderTreeItem(entity, isPlayer) {
            if (!entity) return '';
            const id = isPlayer ? (entity.charId || 'unknown') : (entity.id || 'unknown');
            const avatar = entity.avatar || (isPlayer ? 'assets/default_slayer.png' : 'assets/default_oni.png');
            const name = entity.name || 'Sem Nome';
            const level = entity.level || 1;

            const clickAdd = `event.stopPropagation(); promptAddToCombat('${id}', ${isPlayer});`;
            const clickDup = `event.stopPropagation(); duplicateEntity('${id}', ${isPlayer});`;

            return `
                <div class="wis-tree-item ${activeEntityId === id ? 'selected' : ''}" onclick="selectEntity('${id}', ${isPlayer})">
                     <img src="${avatar}" class="wis-tree-item-avatar" onerror="this.src='https://via.placeholder.com/20'">
                     <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</span>
                     ${!isPlayer ? `<span style="font-size:0.7rem; color:#555; margin-right:4px;">Lv.${level}</span>` : ''}
                     
                     ${!isPlayer ? `
                     <button class="btn-icon" onclick="${clickDup}" title="Duplicar NPC" style="opacity:0.5; padding:2px; border:none; background:none; cursor:pointer; margin-right:4px;">
                        <i data-lucide="copy" size="12"></i>
                     </button>
                     ` : ''}

                     <button class="btn-icon" onclick="${clickAdd}" title="Add Combat" style="opacity:0.5; padding:0; border:none; background:none; cursor:pointer;">
                        <i data-lucide="swords" size="12"></i>
                     </button>
                </div>
            `;
        }

        function toggleAccordion(header) {
            header.parentElement.classList.toggle('active');
        }

        function toggleTreeFolder(header) {
            header.parentElement.classList.toggle('active');
        }

        function filterSidebar(query) {
            const term = query.toLowerCase();

            document.querySelectorAll('.wis-npc-card').forEach(card => {
                const name = card.querySelector('.wis-npc-name').innerText.toLowerCase();
                const match = name.includes(term);
                card.style.display = match ? 'flex' : 'none';
                if (match && term.length > 0) {
                    card.closest('.wis-accordion-item').classList.add('active');
                }
            });
        }

        // --- WORKSPACE LOGIC ---
        function selectEntity(id, isPlayer) {
            activeEntityId = id;
            renderSidebar();

            const entity = isPlayer
                ? currentCamp.players.find(p => p.charId === id)
                : currentCamp.monsters.find(m => m.id === id);

            if (!entity) return;

            document.getElementById('sessionDashboardState').style.display = 'none';
            document.getElementById('dmSheetState').style.display = 'flex';

            renderDMSheet(entity, isPlayer);
        }

        function renderDMSheet(entity, isPlayer) {
            const container = document.getElementById('dmSheetState');
            const avatar = entity.avatar || (isPlayer ? 'assets/default_slayer.png' : 'assets/default_oni.png');
            const stats = entity.stats || { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 };

            // Determine Title/Class field
            const subTitle = isPlayer ? (entity.rank || 'Caçador') : (entity.class || entity.race || 'Criatura');
            const subTitleField = isPlayer ? 'rank' : 'class'; // Map to correct property for editing

            // Normalize Skills (Migration: String -> Object)
            if (entity.skills && entity.skills.length > 0 && typeof entity.skills[0] === 'string') {
                entity.skills = entity.skills.map(s => ({ name: s, value: 2 })); // Default +2 if migrating
            }
            const skills = entity.skills || [];

            // HP Calculation for Dynamic Color
            const hpPct = Math.max(0, Math.min(100, (entity.currentHP / entity.maxHP) * 100));
            let hpColor = '#10b981'; // Green (> 60%)
            if (hpPct <= 60) hpColor = '#facc15'; // Yellow (30-60%)
            if (hpPct < 30) hpColor = '#ef4444'; // Red (< 30%)

            container.innerHTML = `
                <!-- HEADER EDITÁVEL (Compact) -->
                <div class="wis-sheet-header" style="background: linear-gradient(to right, #18181b, transparent); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; border:1px solid #333;">
                    <img src="${avatar}" class="wis-sheet-avatar-lg" style="width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border-dark); object-fit: cover;" onerror="this.src='https://via.placeholder.com/50'">
                    
                    <div style="flex: 1; display: flex; flex-direction: column; justify-content:center;">
                         <!-- Nome Editável -->
                         <input type="text" value="${entity.name}" 
                                class="ds-seamless-input"
                                style="font-size: 1.25rem; font-weight: bold; width: 100%; margin-bottom:2px;"
                                oninput="updateActiveEntityField('name', this.value)"
                                placeholder="Nome">
                        
                         <!-- Título/Classe Editável -->
                         <input type="text" value="${subTitle}" 
                                class="ds-seamless-input"
                                style="font-size: 0.85rem; color: #aaa; width: 100%;"
                                oninput="updateActiveEntityField('${subTitleField}', this.value)"
                                placeholder="Título/Classe">
                    </div>

                    <!-- Ações Rápidas (Compact) -->
                    <div style="display:flex; gap:5px;">
                        <button class="btn-icon" title="Combate" onclick="promptAddToCombat('${isPlayer ? entity.charId : entity.id}', ${isPlayer})" style="background:#222;">
                            <i data-lucide="swords" size="14"></i>
                        </button>
                        <button class="btn-icon" title="Excluir" onclick="deleteEntity('${isPlayer ? entity.charId : entity.id}', ${isPlayer})" style="background:#222; color:#ef4444;">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                        <button class="btn-icon" title="Fechar" onclick="closeSheet()" style="background:#222;">
                            <i data-lucide="x" size="14"></i>
                        </button>
                    </div>
                </div>

                <!-- HP MANAGER (Compact Single Line) -->
                <div style="background: #18181b; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-dark); margin-bottom: 10px; display:flex; align-items:center; gap:10px;">
                    <div style="font-size: 0.9rem; font-weight: bold; color: #fff; white-space:nowrap; display:flex; align-items:center; gap:5px;">
                        <span style="color:${hpColor}; transition:color 0.5s ease;">❤️</span> 
                        <input type="number" value="${entity.currentHP}" 
                               class="ds-seamless-input"
                               style="width:50px; text-align:right; font-weight:bold; -moz-appearance:textfield;"
                               onchange="updateActiveEntityHP(this.value, null)">
                        <span style="color:#555; font-weight:normal;">/</span>
                        <input type="number" value="${entity.maxHP}" 
                               class="ds-seamless-input"
                               style="color:#777; width:50px; text-align:left; -moz-appearance:textfield;"
                               onchange="updateActiveEntityHP(null, this.value)">
                    </div>

                    <!-- Bar -->
                    <div style="flex:1; height:6px; background:#333; border-radius:3px; overflow:hidden; position:relative;">
                        <div style="height:100%; background:${hpColor}; width:${hpPct}%; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;"></div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 4px;">
                        ${entity.race === 'Oni' ? `
                            <button class="btn-mini-heal" onclick="regenerateOni(${entity.level})" title="Regeneração Oni" style="background:#450a0a; color:#f87171; border:1px solid #7f1d1d; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:0.75rem; margin-right:4px;">
                                <i data-lucide="droplet" size="12"></i>
                            </button>
                        ` : ''}
                        <button class="btn-mini-dmg" onclick="adjustHP(-5)" style="background:#3a0b0b; color:#ff6b6b; border:1px solid #5c1414; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:0.75rem;">-5</button>
                        <button class="btn-mini-dmg" onclick="adjustHP(-1)" style="background:#3a0b0b; color:#ff6b6b; border:1px solid #5c1414; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:0.75rem;">-1</button>
                        <button class="btn-mini-heal" onclick="adjustHP(1)" style="background:#0b3a1a; color:#4ade80; border:1px solid #145c26; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:0.75rem;">+1</button>
                        <button class="btn-mini-heal" onclick="adjustHP(5)" style="background:#0b3a1a; color:#4ade80; border:1px solid #145c26; width:24px; height:24px; border-radius:4px; cursor:pointer; font-size:0.75rem;">+5</button>
                    </div>
                </div>

                <!-- STICKY NAVBAR -->
                <div style="position:sticky; top:0; z-index:99; background:rgba(24, 24, 27, 0.95); backdrop-filter:blur(4px); padding:8px 5px; border-bottom:1px solid #333; display:flex; justify-content:space-around; margin-bottom:15px; margin-top:-10px; border-radius:0 0 8px 8px;">
                    <button class="btn-clean" style="color:#aaa; font-size:0.8rem; font-weight:bold; cursor:pointer; background:none; border:none;" onclick="document.getElementById('sheet-sec-attributes').scrollIntoView({behavior: 'smooth', block: 'center'})">Atributos</button>
                    <button class="btn-clean" style="color:#aaa; font-size:0.8rem; font-weight:bold; cursor:pointer; background:none; border:none;" onclick="document.getElementById('sheet-sec-skills').scrollIntoView({behavior: 'smooth', block: 'start'})">Habilidades</button>
                    <button class="btn-clean" style="color:#aaa; font-size:0.8rem; font-weight:bold; cursor:pointer; background:none; border:none;" onclick="document.getElementById('sheet-sec-equipment').scrollIntoView({behavior: 'smooth', block: 'center'})">Equipamento</button>
                    <button class="btn-clean" style="color:#aaa; font-size:0.8rem; font-weight:bold; cursor:pointer; background:none; border:none;" onclick="document.getElementById('sheet-sec-lore').scrollIntoView({behavior: 'smooth', block: 'start'})">Histórico</button>
                </div>

                <!-- ATTRIBUTES & SKILLS -->
                <!-- ATTRIBUTES & SKILLS (Compact Row) -->
                 <div style="display:flex; flex-direction:column; gap:10px; margin-bottom: 20px;">
                    
                    <!-- ATTRIBUTES GRID (6 Cols) -->
                    <div id="sheet-sec-attributes" style="width:100%; scroll-margin-top: 60px;">
                        <div class="wis-stats-grid" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:6px;">
                            ${renderEditableStatBox('FOR', 'str', stats.str)}
                            ${renderEditableStatBox('DES', 'dex', stats.dex)}
                            ${renderEditableStatBox('CON', 'con', stats.con)}
                            ${renderEditableStatBox('INT', 'int', stats.int)}
                            ${renderEditableStatBox('SAB', 'wis', stats.wis)}
                            ${renderEditableStatBox('CAR', 'cha', stats.cha)}
                        </div>
                    </div>

                <!-- SKILLS (Grouped by Attribute) -->
                <div id="sheet-sec-skills" style="background:#18181b; padding:10px; border-radius:8px; border:1px solid var(--border-dark); margin-bottom: 20px; scroll-margin-top: 60px;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                         <h3 class="wis-title" style="margin:0; font-size:1rem;">Perícias</h3>
                         <button class="btn-icon" onclick="promptAddSkill()" title="Adicionar" style="background:#222; padding:2px;">
                            <i data-lucide="plus" size="14"></i>
                         </button>
                     </div>
                     
                     <div style="display:flex; flex-direction:column; gap:12px;">
                        ${(() => {
                    const SKILL_ATTR_MAP = {
                        'FOR': ['Atletismo', 'Esportes'],
                        'DES': ['Acrobacia', 'Furtividade', 'Prestidigitação', 'Ladinagem'],
                        'INT': ['História', 'Medicina', 'Natureza', 'Arcanismo', 'Religião', 'Investigação'],
                        'SAB': ['Intuição', 'Lidar com Animais', 'Percepção', 'Sobrevivência'],
                        'CAR': ['Blefar', 'Intimidação', 'Persuasão', 'Atuação', 'Enganação']
                    };

                    // Reverse map for easy lookup if needed, but iteration is fine
                    const ATTR_ICONS = {
                        'FOR': 'biceps-flexed', // fallback to dumbbell if biceps not in set
                        'DES': 'wind',
                        'INT': 'brain',
                        'SAB': 'eye', // owl not standard, eye is good for Wisdom
                        'CAR': 'message-circle'
                    };

                    // Group skills
                    const groups = {};
                    const otherSkills = [];

                    skills.forEach(s => {
                        let found = false;
                        for (const [attr, list] of Object.entries(SKILL_ATTR_MAP)) {
                            if (list.includes(s.name)) {
                                if (!groups[attr]) groups[attr] = [];
                                groups[attr].push(s);
                                found = true;
                                break;
                            }
                        }
                        if (!found) otherSkills.push(s);
                    });

                    let html = '';

                    // Render Groups (Polished)
                    for (const [attr, list] of Object.entries(groups)) {
                        html += `
                                    <div class="wis-skill-group">
                                        <div class="wis-skill-header">
                                            <i data-lucide="${ATTR_ICONS[attr] || 'circle'}" size="12"></i> ${attr}
                                        </div>
                                        <div class="wis-skill-list">
                                            ${list.map((s, i) => `
                                                <div class="wis-skill-row" onclick="promptEditSkill(${skills.indexOf(s)})">
                                                    <div class="wis-skill-name-container">
                                                        <div class="wis-skill-dot"></div>
                                                        <span class="wis-skill-name">${s.name}</span>
                                                    </div>
                                                    <div class="wis-skill-actions">
                                                        <span class="wis-skill-mod">${s.value >= 0 ? '+' : ''}${s.value}</span>
                                                        <i class="wis-skill-roll-btn" data-lucide="dices" size="14" onclick="event.stopPropagation(); rollSkill('${s.name}', ${s.value})" title="Rolar"></i>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                    }

                    // Render Others (Polished)
                    if (otherSkills.length > 0) {
                        html += `
                                    <div class="wis-skill-group">
                                        <div class="wis-skill-header">
                                            <i data-lucide="sparkles" size="12"></i> Outros
                                        </div>
                                        <div class="wis-skill-list">
                                            ${otherSkills.map((s, i) => `
                                                <div class="wis-skill-row" onclick="promptEditSkill(${skills.indexOf(s)})">
                                                    <div class="wis-skill-name-container">
                                                        <div class="wis-skill-dot"></div>
                                                        <span class="wis-skill-name">${s.name}</span>
                                                    </div>
                                                    <div class="wis-skill-actions">
                                                         <span class="wis-skill-mod">${s.value >= 0 ? '+' : ''}${s.value}</span>
                                                         <i class="wis-skill-roll-btn" data-lucide="dices" size="14" onclick="event.stopPropagation(); rollSkill('${s.name}', ${s.value})" title="Rolar"></i>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                    }

                    if (skills.length === 0) return '<div style="color:#555; font-size:0.85rem; padding:10px; font-style:italic;">Nenhuma perícia adicionada.</div>';

                    return html;
                })()}
                     </div>
                </div>

                <!-- COMBAT & ATTACKS (Compact) -->
                <div style="background:#18181b; padding:10px; border-radius:8px; border:1px solid var(--border-dark); margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                         <h3 class="wis-title" style="margin:0; font-size:1rem;">Ataques</h3>
                         <button class="btn-icon" onclick="openAttackModal()" title="Criar Ataque" style="background:#222; padding:2px;">
                            <i data-lucide="plus" size="14"></i>
                         </button>
                    </div>
                    
                    <div id="attacks-list-container" style="display:flex; flex-direction:column;">
                        ${(entity.attacks && entity.attacks.length > 0) ? entity.attacks.map((atk, i) => renderEditableAttackCard(atk, i)).join('') : '<div style="color:#555; font-style:italic; padding:5px; font-size:0.85rem;">Nenhum ataque.</div>'}
                    </div>

                    <button class="btn" style="width:100%; margin-top:5px; background:rgba(217, 4, 41, 0.1); border:1px dashed #444; color:#ef233c; font-weight:bold; font-size:0.85rem; padding:6px;" onclick="openAttackModal()">
                        <i data-lucide="sword" size="12"></i> Criar Novo Ataque
                    </button>
                </div>

                <!-- ACTIONS & TECHNIQUES (Compact) -->
                <div style="background:#18181b; padding:10px; border-radius:8px; border:1px solid var(--border-dark); margin-bottom: 10px;">
                    <h3 class="wis-title" style="margin-bottom:10px; font-size:1rem;">Técnicas</h3>
                    
                    <div id="actions-list-container" style="display:flex; flex-direction:column; gap:6px;">
                        ${(entity.actions && entity.actions.length > 0) ? entity.actions.map((act, i) => renderEditableActionCard(act, i)).join('') : '<div style="color:#555; font-style:italic; padding:5px; font-size:0.85rem;">Nenhuma técnica.</div>'}
                    </div>

                    <button class="btn" style="width:100%; margin-top:10px; background:rgba(255,255,255,0.05); border:1px dashed #444; color:#888; font-size:0.85rem; padding:6px;" onclick="addEmptyAction()">
                        <i data-lucide="plus" size="12"></i> Nova Técnica
                    </button>
                </div>

                <!-- EQUIPMENT SECTION -->
                <div id="sheet-sec-equipment" style="background:#18181b; padding:10px; border-radius:8px; border:1px solid var(--border-dark); margin-bottom: 10px; scroll-margin-top: 60px;">
                    <h3 class="wis-title" style="margin-bottom:10px; font-size:1rem;">Equipamento</h3>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:5px;">
                            <span style="color:#888; font-size:0.9rem;">Arma Principal</span>
                            <span style="color:#fff; font-weight:bold;">${entity.equipment?.weaponName ? entity.equipment.weaponName :
                    (entity.equipment?.weapon === 'katana' ? 'Katana Nichirin' : 'Desarmado')
                }</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; padding-top:5px;">
                            <span style="color:#888; font-size:0.9rem;">Armadura</span>
                            <span style="color:#fff;">${entity.equipment?.armor === 'slayer_uniform' ? 'Uniforme de Caçador' :
                    (entity.equipment?.armor === 'haori' ? 'Haori' : 'Nenhuma')
                }</span>
                        </div>
                    </div>
                </div>

                <!-- HISTORY & NOTES (Compact) -->
                <div id="sheet-sec-lore" style="scroll-margin-top: 60px;">
                     <h3 class="wis-title" style="margin-bottom:5px; font-size:1rem;">Histórico</h3>
                     <textarea class="wis-paper-textarea" 
                               placeholder="História, segredos..."
                               oninput="updateActiveEntityField('lore', this.value)"
                               style="width: 100%; min-height: 100px; background: #1e1e24; border: 1px solid #333; color: #ddd; padding: 10px; font-family: sans-serif; line-height: 1.5; border-radius: 8px; resize: vertical; outline: none; font-size:0.9rem;">${entity.lore || ''}</textarea>
                </div>

                <!-- LOOT & DROPS SECTION -->
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <h3 class="wis-title" style="margin:0; font-size:1rem;">Espólio & Drops</h3>
                        <button class="btn-icon" onclick="announceLoot()" title="Enviar para Chat" style="background:#222; color:var(--text-muted); padding:4px;">
                            <i data-lucide="send" size="14"></i>
                        </button>
                    </div>
                    <textarea class="wis-paper-textarea" 
                               placeholder="Itens que este NPC carrega (ex: Sangue de Lua Inferior, Nichirin...)"
                               oninput="updateActiveEntityLoot(this.value)"
                               style="width: 100%; min-height: 60px; background: #18181b; border: 1px solid #333; color: #aaa; padding: 10px; font-family: monospace; font-size:0.85rem; border-radius: 8px; resize: vertical; outline: none;">${entity.loot || ''}</textarea>
                </div>
            `;

            // Render Icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function renderEditableActionCard(action, index) {
            // Ensure action is object
            const name = action.name || '';
            const desc = action.desc || (typeof action === 'string' ? '' : ''); // Migration handle

            return `
                <div class="wis-action-card" style="background:#222; border:1px solid #333; border-radius:6px; padding:10px; display:flex; flex-direction:column; gap:5px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="text" value="${name}" placeholder="Nome da Técnica"
                               style="background:transparent; border:none; color:#ececec; font-weight:bold; font-size:1rem; width:100%; outline:none;"
                               oninput="updateActiveEntityAction(${index}, 'name', this.value)">
                        
                         <button class="btn-icon" onclick="removeAction(${index})" title="Excluir" style="color:#ef4444; opacity:0.7;">
                            <i data-lucide="trash-2" size="14"></i>
                         </button>
                    </div>
                    <textarea placeholder="Descrição do efeito, dano, custo..."
                              oninput="updateActiveEntityAction(${index}, 'desc', this.value)"
                              style="background:transparent; border:none; color:#aaa; font-size:0.9rem; width:100%; resize:vertical; outline:none; min-height:40px; font-family:sans-serif;">${desc}</textarea>
                </div>
            `;
        }

        function addEmptyAction() {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }

            if (ent) {
                if (!ent.actions) ent.actions = [];
                ent.actions.push({ name: "Nova Técnica", desc: "" });

                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    actions: ent.actions
                });
                renderDMSheet(ent, isPlayer);
            }
        }

        function removeAction(index) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }

            if (ent && ent.actions) {
                if (confirm("Excluir esta técnica?")) {
                    ent.actions.splice(index, 1);
                    window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                        actions: ent.actions
                    });
                    renderDMSheet(ent, isPlayer);
                }
            }
        }

        function updateActiveEntityAction(index, field, value) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }

            if (ent && ent.actions && ent.actions[index]) {
                // Determine if upgrading from string to object logic needed (migration on fly)
                if (typeof ent.actions[index] === 'string') {
                    ent.actions[index] = { name: ent.actions[index], desc: '' };
                }

                ent.actions[index][field] = value;

                // Debounced save could be better, but simpler here:
                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    actions: ent.actions
                });
            }
        }

        function updateActiveEntityField(field, value) {
            if (!activeEntityId || !currentCamp) return;

            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) {
                ent = currentCamp.players.find(p => p.charId === activeEntityId);
                isPlayer = true;
            }

            if (ent) {
                ent[field] = value;

                // Update Campaign System
                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    [field]: value
                });

                // Update Sidebar text if Title or Name changed
                if (field === 'name') {
                    renderSidebar();
                }
                // showToast("Atualizado: " + field);
            }
        }

        function renderEditableStatBox(label, key, val) {
            const mod = Math.floor((val - 10) / 2);
            const sign = mod >= 0 ? '+' : '';
            const color = val > 14 ? 'var(--primary)' : '#fff';

            return `
                <div class="wis-stat-box" style="position:relative; aspect-ratio: 1/1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <div class="wis-stat-label" style="font-size:0.75rem; color:#777; position:absolute; top:5px;">${label}</div>
                    
                    <input type="number" value="${val}" 
                           style="background:transparent; border:none; text-align:center; color:${color}; font-size:1.5rem; font-weight:bold; width:100%; outline:none; -moz-appearance:textfield;"
                           onchange="updateActiveEntityStat('${key}', this.value)">
                    
                    <div style="background:#333; color:#fff; font-size:0.75rem; padding:2px 6px; border-radius:4px; margin-top:0px;">
                        ${sign}${mod}
                    </div>
                </div>
                `;
        }

        function updateActiveEntityStat(key, valStr) {
            const val = parseInt(valStr) || 10;
            if (!activeEntityId || !currentCamp) return;

            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) {
                ent = currentCamp.players.find(p => p.charId === activeEntityId);
                isPlayer = true;
            }

            if (ent) {
                if (!ent.stats) ent.stats = {};
                ent.stats[key] = val;

                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    stats: ent.stats
                });

                renderDMSheet(ent, isPlayer);
            }
        }

        // --- SKILL MANAGEMENT ---
        function promptAddSkill() {
            const name = prompt("Nome da Perícia (ex: Furtividade):");
            if (!name) return;
            const val = prompt("Bônus (ex: 5):", "2");
            if (!val) return;

            updateActiveEntitySkill(null, { name: name, value: parseInt(val) || 0 });
        }

        function promptEditSkill(index) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent && currentCamp.players) ent = currentCamp.players.find(p => p.charId === activeEntityId);
            if (!ent || !ent.skills[index]) return;

            const s = ent.skills[index];
            const newVal = prompt(`Novo bônus para ${s.name}:`, s.value);

            if (newVal === null) return; // Cancel

            if (newVal.trim() === '') {
                if (confirm(`Remover perícia ${s.name}?`)) {
                    removeSkill(index);
                }
                return;
            }

            updateActiveEntitySkill(index, { name: s.name, value: parseInt(newVal) || 0 });
        }

        function removeSkill(index) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent && currentCamp.players) ent = currentCamp.players.find(p => p.charId === activeEntityId);

            if (ent && ent.skills) {
                ent.skills.splice(index, 1);
                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    skills: ent.skills
                });
                renderDMSheet(ent, isPlayer);
            }
        }

        function updateActiveEntitySkill(index, skillData) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) {
                ent = currentCamp.players.find(p => p.charId === activeEntityId);
                isPlayer = true;
            }

            if (ent) {
                if (!ent.skills) ent.skills = [];

                // Migration check just in case
                if (ent.skills.length > 0 && typeof ent.skills[0] === 'string') {
                    ent.skills = ent.skills.map(s => ({ name: s, value: 2 }));
                }

                if (index !== null && index >= 0) {
                    ent.skills[index] = skillData;
                } else {
                    ent.skills.push(skillData);
                }

                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    skills: ent.skills
                });
                renderDMSheet(ent, isPlayer);
            }
        }

        function closeSheet() {
            activeEntityId = null;
            document.getElementById('dmSheetState').style.display = 'none';
            document.getElementById('sessionDashboardState').style.display = 'flex';
            renderSidebar();
        }

        // --- SPECIAL COMBAT FEATURES ---
        function regenerateOni(level) {
            if (!activeEntityId || !currentCamp) return;
            const ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent || ent.race !== 'Oni') return;

            const healAmount = (level && level >= 10) ? 20 : 10;
            let newHP = (ent.currentHP || 0) + healAmount;
            if (newHP > ent.maxHP) newHP = ent.maxHP;

            updateActiveEntityHP(newHP, null);
            showToast("Regeneração de Demônio ativada! +" + healAmount + " HP");
        }

        function updateActiveEntityLoot(value) {
            if (!activeEntityId || !currentCamp) return;
            const ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) return;

            ent.loot = value;
            window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, false, {
                loot: value
            });
        }

        function announceLoot() {
            if (!activeEntityId || !currentCamp) return;
            const ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) return;

            const loot = ent.loot || "Nada de interessante.";
            showToast("O grupo encontrou: " + loot);
            // In a real chat system, this would push to the chat log array.
        }

        // --- COMBAT SYSTEM (New) ---
        function toggleCombatSidebar() {
            const sb = document.getElementById('combatSidebar');
            sb.classList.toggle('collapsed');
        }

        function promptAddToCombat(id, isPlayer) {
            // Find Entity
            const entity = isPlayer
                ? currentCamp.players.find(p => p.charId === id)
                : currentCamp.monsters.find(m => m.id === id);

            if (!entity) return;

            // Check if already in combat
            if (combatItems.find(c => c.id === id)) {
                showToast("Já está no combate!");
                // Just open sidebar
                document.getElementById('combatSidebar').classList.remove('collapsed');
                return;
            }

            pendingCombatAdd = {
                id: id,
                isPlayer: isPlayer,
                name: entity.name,
                hp: entity.currentHP, // Copy vals
                maxHP: entity.maxHP,
                avatar: entity.avatar
            };

            // Open Prompt
            document.getElementById('initPromptName').innerText = entity.name;
            document.getElementById('initInput').value = Math.floor(Math.random() * 20) + 1 + (Math.floor(((entity.stats?.dex || 10) - 10) / 2)); // Auto roll guess
            document.getElementById('initPromptModal').style.display = 'flex';
        }

        function closeInitPrompt() {
            document.getElementById('initPromptModal').style.display = 'none';
            pendingCombatAdd = null;
        }

        function rollInitForPrompt() {
            const roll = Math.floor(Math.random() * 20) + 1;
            document.getElementById('initInput').value = roll; // Ignore mod for quick roll logic
        }

        function confirmAddToCombat() {
            if (!pendingCombatAdd) return;
            const val = parseInt(document.getElementById('initInput').value) || 0;

            combatItems.push({
                ...pendingCombatAdd,
                init: val,
                conditions: []
            });

            closeInitPrompt();
            sortCombat();
            renderCombatList();

            document.getElementById('combatSidebar').classList.remove('collapsed');
            showToast("Combatente adicionado!");
        }

        function sortCombat() {
            combatItems.sort((a, b) => b.init - a.init);
            // If active index affected, we should track by ID, but simple reset for now is acceptable or keep index?
            // Usually sort happens before round start. If mid-round sort, index might point to wrong person.
            // Let's keep it simple: sorting resets active turn if we aren't careful.
            // For now, let's just re-render.
        }

        function renderCombatList() {
            const list = document.getElementById('combatList');
            list.innerHTML = '';

            if (combatItems.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#555;">Vazio</div>`;
                return;
            }

            combatItems.forEach((c, i) => {
                const isActive = (i === turnIndex);
                const isDead = c.hp <= 0;

                let condHtml = c.conditions.map(cond => `<span class="cond-tag">${cond}</span>`).join('');

                const html = `
                <div class="combatant-card ${isActive ? 'active-turn' : ''}" style="${isDead ? 'opacity:0.5; filter:grayscale(1);' : ''}">
                        <div class="combatant-init-box">
                            <span class="init-val">${c.init}</span>
                            <span class="init-label">INI</span>
                        </div>
                        <img src="${c.avatar || 'assets/default_slayer.png'}" style="width:32px; height:32px; border-radius:50%; object-fit:cover; margin-left:8px;" onerror="this.src='https://via.placeholder.com/32'">
                        <div class="combatant-info">
                            <div class="combatant-name">${c.name}</div>
                            <div class="combatant-hp">HP ${c.hp}/${c.maxHP} ${condHtml}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:2px;">
                             <button class="btn-icon" style="padding:2px; font-size:0.6rem;" onclick="removeCombatant(${i})">❌</button>
                        </div>
                    </div>
            `;
                list.insertAdjacentHTML('beforeend', html);
            });

            // Scroll active into view
            const activeEl = list.children[turnIndex];
            if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function nextTurn() {
            if (combatItems.length === 0) return;
            turnIndex++;
            if (turnIndex >= combatItems.length) {
                turnIndex = 0;
                round++;
                document.getElementById('combatRound').innerText = round;
                showToast(`Round ${round} Iniciado!`);
            }
            renderCombatList();
        }

        function removeCombatant(index) {
            combatItems.splice(index, 1);
            if (turnIndex >= index && turnIndex > 0) turnIndex--;
            renderCombatList();
        }

        function clearCombat() {
            if (!confirm("Limpar todo o combate?")) return;
            combatItems = [];
            turnIndex = 0;
            round = 1;
            renderCombatList();
        }


        // --- NPC CREATOR LOGIC ---
        // Moved to npc_creator.js


        function deleteEntity(id, isPlayer) {
            if (!confirm("Tem certeza que deseja remover este entidade?")) return;
            window.CampaignSystem.removeEntity(CAMP_ID, id, !isPlayer);
            loadCampaignData();
            renderSidebar();
            closeSheet();
            showToast("Removido com sucesso.");
        }

        function adjustHP(amount) {
            if (!activeEntityId) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) {
                ent = currentCamp.players.find(p => p.charId === activeEntityId);
                isPlayer = true;
            }

            if (ent) {
                ent.currentHP += amount;
                if (ent.currentHP > ent.maxHP) ent.currentHP = ent.maxHP;
                if (ent.currentHP < 0) ent.currentHP = 0;

                // Update Campaign
                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    currentHP: ent.currentHP
                });

                // Update UI
                renderDMSheet(ent, isPlayer);
                renderSidebar();

                // Update Combat List if present
                const combatant = combatItems.find(c => c.id === activeEntityId);
                if (combatant) {
                    combatant.hp = ent.currentHP;
                    renderCombatList();
                }

                addLog(`${ent.name} HP ${amount > 0 ? '+' : ''}${amount} (${ent.currentHP}/${ent.maxHP})`, amount > 0 ? 'heal' : 'dmg');
            }
        }


        function updateActiveEntityHP(currentVal, maxVal) {
            if (!activeEntityId || !currentCamp) return;

            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) {
                ent = currentCamp.players.find(p => p.charId === activeEntityId);
                isPlayer = true;
            }

            if (ent) {
                if (currentVal !== null) {
                    let v = parseInt(currentVal);
                    if (isNaN(v)) v = ent.currentHP;
                    ent.currentHP = v;
                }
                if (maxVal !== null) {
                    let v = parseInt(maxVal);
                    if (isNaN(v)) v = ent.maxHP;
                    ent.maxHP = v;
                }

                // Bounds Check (Current shouldn't exceed Max usually, but DM override allows it if needed? Let's cap it for safety unless DM wants "Overheal")
                // User asked for editable, usually manual edit implies "Force Set". I won't cap automatically on manual edit to allow flexibility, 
                // but the bar will look weird if >100%. That's fine.
                if (ent.currentHP < 0) ent.currentHP = 0;

                // Update Campaign
                window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                    currentHP: ent.currentHP,
                    maxHP: ent.maxHP
                });

                // Update UI (Full re-render to update bar widths etc)
                renderDMSheet(ent, isPlayer);
                renderSidebar();

                // Update Combat List if present
                const combatant = combatItems.find(c => c.id === activeEntityId);
                if (combatant) {
                    combatant.hp = ent.currentHP;
                    combatant.maxHP = ent.maxHP;
                    renderCombatList();
                }
            }
        }

        // --- SCENES & LOGS ---
        function renderLogs() {
            const container = document.getElementById('combatLog');
            if (!currentCamp.log) currentCamp.log = [];

            container.innerHTML = currentCamp.log.slice().reverse().map(l => `
                <div class="log-card">
                    <div style="font-weight:bold; margin-bottom:2px;">${l.msg}</div>
                    <div style="font-size:0.7rem; color:#777;">${l.time || ''}</div>
                </div>
                `).join('');
        }

        function addLog(msg, type = 'info') {
            window.CampaignSystem.addLog(CAMP_ID, msg, type);
            loadCampaignData();
            renderLogs();
        }

        function addQuickNote() {
            const val = document.getElementById('quickNoteInput').value;
            if (!val) return;
            addLog("Nota: " + val, "note");
            document.getElementById('quickNoteInput').value = '';
            showToast("Nota salva.");
        }

        function renderScenes() {
            const defaults = [
                { name: "Floresta Wisteria", img: "https://i.pinimg.com/originals/82/8a/92/828a92f02235e4d3c40a501538350162.jpg" },
                { name: "Castelo Infinito", img: "https://i.pinimg.com/736x/8f/3e/26/8f3e2646c2450373df9098921868427f.jpg" }
            ];
            const list = document.getElementById('scenesList');
            list.innerHTML = defaults.map(s => `
                <div style="display:flex; align-items:center; gap:10px; padding:6px; background:#111; border-radius:6px; cursor:pointer;" onclick="changeBackground('${s.img}')">
                    <img src="${s.img}" style="width:40px; height:24px; object-fit:cover; border-radius:4px;">
                        <span style="font-size:0.8rem;">${s.name}</span>
                    </div>
            `).join('');
        }

        function changeBackground(url) {
            const bg = document.querySelector('.wis-workspace-bg');
            bg.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${url}')`;
            bg.style.backgroundSize = 'cover';
            showToast("Cenário alterado");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function toggleDiceOverlay() {
            const el = document.getElementById('diceOverlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleNewFolderInput() {
            const container = document.getElementById('newFolderInputContainer');
            const input = document.getElementById('newFolderInput');
            const isHidden = container.style.display === 'none';
            container.style.display = isHidden ? 'block' : 'none';
            if (isHidden) input.focus();
        }

        function handleNewFolderKey(e) {
            if (e.key === 'Enter') {
                const val = e.target.value.trim();
                if (val) {
                    const success = window.CampaignSystem.addFolder(CAMP_ID, val);
                    if (success) {
                        showToast("Pasta criada!");
                        toggleNewFolderInput();
                        e.target.value = '';
                        loadCampaignData();
                        renderSidebar();
                    } else {
                        showToast("Pasta já existe ou erro.");
                    }
                }
            } else if (e.key === 'Escape') {
                toggleNewFolderInput();
            }
        }

        // --- ADVANCED COMBAT / ATTACK MODAL LOGIC ---
        let editingAttackIndex = -1;

        function openAttackModal() {
            const modal = document.getElementById('attackModal');
            if (modal) {
                modal.style.display = 'flex';
                editingAttackIndex = -1;

                // Reset Inputs
                document.getElementById('atkNameInput').value = '';
                document.getElementById('atkDmgInput').value = '';
                document.getElementById('atkTypeInput').value = '';
                document.getElementById('atkCritInput').value = '20';
                document.getElementById('atkMultInput').value = '2';
                document.getElementById('atkBonusInput').value = '0';
                document.getElementById('atkRangeInput').value = '';
                document.getElementById('extraDmgContainer').innerHTML = '';

                const btn = document.getElementById('btnConfirmAttack');
                if (btn) btn.innerText = "CRIAR ATAQUE";
            }
        }

        function closeAttackModal() {
            const modal = document.getElementById('attackModal');
            if (modal) modal.style.display = 'none';
            editingAttackIndex = -1;
        }

        function setAttackPreset(type) {
            if (type === 'katana') {
                document.getElementById('atkNameInput').value = "Espada Nichirin";
                document.getElementById('atkDmgInput').value = "1d8+2";
                document.getElementById('atkTypeInput').value = "Cortante";
            } else if (type === 'unarmed') {
                document.getElementById('atkNameInput').value = "Ataque Desarmado";
                document.getElementById('atkDmgInput').value = "1d4+1";
                document.getElementById('atkTypeInput').value = "Concussão";
            } else if (type === 'bow') {
                document.getElementById('atkNameInput').value = "Arco Longo";
                document.getElementById('atkDmgInput').value = "1d8+2";
                document.getElementById('atkTypeInput').value = "Perfurante";
                document.getElementById('atkRangeInput').value = "Longo";
            }
        }

        function addExtraDmgRow(dmgVal = '', typeVal = '') {
            const container = document.getElementById('extraDmgContainer');
            const div = document.createElement('div');
            div.className = 'extra-dmg-row';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1fr 1fr auto';
            div.style.gap = '10px';
            div.style.alignItems = 'center';
            div.style.background = '#111';
            div.style.padding = '10px';
            div.style.borderRadius = '6px';
            div.style.border = '1px solid #333';

            div.innerHTML = `
            <input type="text" class="ds-input extra-dmg-val" value="${dmgVal}" placeholder="Ex: 1d6" style="background:#0a0a0a; border:1px solid #333; color:white; padding:8px; border-radius:4px; width:100%;">
            <select class="ds-input extra-type-val" style="background:#0a0a0a; border:1px solid #333; color:white; padding:8px; border-radius:4px; width:100%; cursor:pointer;">
                <option value="" disabled ${!typeVal ? 'selected' : ''}>Tipo...</option>
                <optgroup label="Físicos Padrão">
                    <option value="Cortante" ${typeVal === 'Cortante' ? 'selected' : ''}>Cortante</option>
                    <option value="Concussão" ${typeVal === 'Concussão' ? 'selected' : ''}>Concussão</option>
                    <option value="Perfurante" ${typeVal === 'Perfurante' ? 'selected' : ''}>Perfurante</option>
                    <option value="Balístico" ${typeVal === 'Balístico' ? 'selected' : ''}>Balístico</option>
                </optgroup>
                <optgroup label="Elementais & Especiais">
                    <option value="Ácido" ${typeVal === 'Ácido' ? 'selected' : ''}>Ácido</option>
                    <option value="Elétrico" ${typeVal === 'Elétrico' ? 'selected' : ''}>Elétrico</option>
                    <option value="Fogo" ${typeVal === 'Fogo' ? 'selected' : ''}>Fogo</option>
                    <option value="Frio" ${typeVal === 'Frio' ? 'selected' : ''}>Frio</option>
                    <option value="Necrótico" ${typeVal === 'Necrótico' ? 'selected' : ''}>Necrótico</option>
                    <option value="Psíquico" ${typeVal === 'Psíquico' ? 'selected' : ''}>Psíquico</option>
                    <option value="Primordial" ${typeVal === 'Primordial' ? 'selected' : ''}>Primordial</option>
                    <option value="Trovejante" ${typeVal === 'Trovejante' ? 'selected' : ''}>Trovejante</option>
                    <option value="Veneno" ${typeVal === 'Veneno' ? 'selected' : ''}>Veneno</option>
                    <option value="Radiante" ${typeVal === 'Radiante' ? 'selected' : ''}>Radiante</option>
                </optgroup>
            </select>
            <button onclick="this.parentElement.remove()" style="background:#d90429; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">X</button>
        `;
            container.appendChild(div);
        }

        function confirmAddAttack() {
            if (!activeEntityId || !currentCamp) return;

            // Find Entity
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }
            if (!ent) return;

            // Gather Data
            const name = document.getElementById('atkNameInput').value;
            const dmg = document.getElementById('atkDmgInput').value;
            const type = document.getElementById('atkTypeInput').value;
            const critThreshold = parseInt(document.getElementById('atkCritInput').value) || 20;
            const critMult = parseInt(document.getElementById('atkMultInput').value) || 2;
            const atkBonus = parseInt(document.getElementById('atkBonusInput').value) || 0;
            const range = document.getElementById('atkRangeInput').value;

            // Extra Dmg
            const extraRows = document.querySelectorAll('.extra-dmg-row');
            const extraDmg = [];
            extraRows.forEach(row => {
                const d = row.querySelector('.extra-dmg-val').value;
                const t = row.querySelector('.extra-type-val').value;
                if (d && t) extraDmg.push({ damage: d, type: t });
            });

            if (!name || !dmg || !type) {
                alert("Preencha Nome, Dano e Tipo!");
                return;
            }

            if (!ent.attacks) ent.attacks = [];

            const atkObj = {
                name, damage: dmg, type,
                critThreshold, critMult, atkBonus, range,
                extraDmg
            };

            if (editingAttackIndex >= 0) {
                ent.attacks[editingAttackIndex] = atkObj;
            } else {
                ent.attacks.push(atkObj);
            }

            // Save
            window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                attacks: ent.attacks
            });

            renderDMSheet(ent, isPlayer);
            closeAttackModal();
        }

        function promptEditAttack(index) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }

            if (ent && ent.attacks && ent.attacks[index]) {
                const atk = ent.attacks[index];
                openAttackModal();
                editingAttackIndex = index;

                document.getElementById('atkNameInput').value = atk.name;
                document.getElementById('atkDmgInput').value = atk.damage;
                document.getElementById('atkTypeInput').value = atk.type;
                document.getElementById('atkCritInput').value = atk.critThreshold || 20;
                document.getElementById('atkMultInput').value = atk.critMult || 2;
                document.getElementById('atkBonusInput').value = atk.atkBonus || 0;
                document.getElementById('atkRangeInput').value = atk.range || '';

                // Extras
                const container = document.getElementById('extraDmgContainer');
                container.innerHTML = '';
                if (atk.extraDmg && Array.isArray(atk.extraDmg)) {
                    atk.extraDmg.forEach(e => addExtraDmgRow(e.damage, e.type));
                }

                const btn = document.getElementById('btnConfirmAttack');
                if (btn) btn.innerText = "SALVAR ALTERAÇÃO";
            }
        }

        function removeAttack(index) {
            if (!activeEntityId || !currentCamp) return;
            let isPlayer = false;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) { ent = currentCamp.players.find(p => p.charId === activeEntityId); isPlayer = true; }

            if (ent && ent.attacks) {
                if (confirm("Excluir este ataque?")) {
                    ent.attacks.splice(index, 1);
                    window.CampaignSystem.updateEntity(CAMP_ID, activeEntityId, !isPlayer, {
                        attacks: ent.attacks
                    });
                    renderDMSheet(ent, isPlayer);
                }
            }
        }


        function renderEditableStatBox(label, key, val) {
            const mod = Math.floor((val - 10) / 2);
            const sign = mod >= 0 ? '+' : '';
            const color = val > 14 ? 'var(--primary)' : '#ccc';

            return `
                <div class="wis-stat-box-compact" style="position:relative; background:#222; border:1px solid #333; border-radius:6px; padding:4px; display:flex; flex-direction:column; align-items:center;">
                    <button onclick="rollSkill('${label}', ${mod})" 
                            title="Rolar Teste de ${label}"
                            style="position:absolute; top:2px; right:2px; width:12px; height:12px; border:none; background:transparent; color:#555; cursor:pointer; padding:0;">
                        <i data-lucide="dices" size="10"></i>
                    </button>
                    <div class="wis-stat-label" style="font-size:0.65rem; color:#777; margin-bottom:2px;">${label}</div>
                    
                    <input type="number" value="${val}" 
                           class="ds-seamless-input"
                           style="text-align:center; color:${color}; font-size:1.1rem; font-weight:bold; width:100%; -moz-appearance:textfield; padding:0; height:auto; background:transparent !important;"
                           onchange="updateActiveEntityStat('${key}', this.value)">
                    
                    <div style="background:#333; color:#fff; font-size:0.7rem; padding:0px 4px; border-radius:3px; margin-top:0px; cursor:pointer;" onclick="rollSkill('${label}', ${mod})">
                        ${sign}${mod}
                    </div>
                </div>
                `;
        }

        function renderEditableActionCard(action, index) {
            // Ensure action is object
            const name = action.name || '';
            const desc = action.desc || (typeof action === 'string' ? '' : ''); // Migration handle

            return `
                <div class="wis-action-card" style="background:#222; border:1px solid #333; border-radius:6px; padding:10px; display:flex; flex-direction:column; gap:5px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="text" value="${name}" placeholder="Nome da Técnica"
                               class="ds-seamless-input"
                               style="font-weight:bold; font-size:1rem; width:100%;"
                               oninput="updateActiveEntityAction(${index}, 'name', this.value)">
                        
                         <button class="btn-icon" onclick="removeAction(${index})" title="Excluir" style="color:#ef4444; opacity:0.7; background:transparent;">
                            <i data-lucide="trash-2" size="14"></i>
                         </button>
                    </div>
                    <textarea placeholder="Descrição do efeito, dano, custo..."
                              class="ds-seamless-textarea"
                              oninput="updateActiveEntityAction(${index}, 'desc', this.value)"
                              style="font-size:0.9rem; width:100%; min-height:40px;">${desc}</textarea>
                </div>
            `;
        }

        // ... (renderEditableActionCard remains unchanged) ...

        function renderEditableAttackCard(atk, index) {
            return `
                <div class="wis-action-card" style="background:#222; border:1px solid #333; border-radius:6px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:#fff; display:flex; align-items:center; gap:8px;">
                            <i data-lucide="sword" size="14" style="color:#777;"></i> ${atk.name}
                        </div>
                        <div style="font-size:0.8rem; color:#888; margin-top:2px;">
                            <span style="color:#ccc;">${atk.damage}</span> • ${atk.type}
                        </div>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center;">
                         <button class="btn-primary" onclick="rollActiveEntityAttack(${index})" title="Rolar Ataque" style="padding:4px 8px; font-size:0.75rem; display:flex; align-items:center; gap:4px;">
                            <i data-lucide="dices" size="12"></i> Rolar
                         </button>
                         <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                         <button class="btn-icon" onclick="promptEditAttack(${index})" title="Editar" style="color:#00b4d8;">
                            <i data-lucide="pencil" size="14"></i>
                         </button>
                         <button class="btn-icon" onclick="removeAttack(${index})" title="Excluir" style="color:#ef4444;">
                            <i data-lucide="trash-2" size="14"></i>
                         </button>
                    </div>
                </div>
            `;
        }

        // --- DICE ROLLING SYSTEM (Ported) ---

        function getDamageTypeClass(type) {
            if (!type) return '';
            const t = type.toLowerCase();
            if (t.includes('fogo')) return 'dmg-type-fogo';
            if (t.includes('frio') || t.includes('gelo')) return 'dmg-type-frio';
            if (t.includes('elétrico')) return 'dmg-type-elétrico';
            if (t.includes('veneno') || t.includes('ácido')) return 'dmg-type-veneno';
            if (t.includes('radiante')) return 'dmg-type-radiante';
            if (t.includes('necrótico')) return 'dmg-type-necrótico';
            if (t.includes('psíquico')) return 'dmg-type-psíquico';
            if (t.includes('cortante')) return 'dmg-type-cortante';
            if (t.includes('perfurante')) return 'dmg-type-perfurante';
            if (t.includes('concussão')) return 'dmg-type-concussão';
            return 'dmg-type-concussão';
        }

        function parseAndRoll(str, extraType, diceMult = 1) {
            const regex = /(\d+)d(\d+)(?:\s*([+-])\s*(\d+))?/;
            const match = str.match(regex);
            let total = 0;
            let details = [];
            let expr = str;
            let type = extraType || "";

            if (match) {
                const count = parseInt(match[1]) * diceMult;
                const sides = parseInt(match[2]);
                const modSign = match[3];
                const modVal = match[4] ? parseInt(match[4]) : 0;

                for (let i = 0; i < count; i++) {
                    const r = Math.floor(Math.random() * sides) + 1;
                    total += r;
                    details.push(r);
                }
                if (modSign === '+') total += modVal;
                if (modSign === '-') total -= modVal;

                let modStr = "";
                if (modSign && modVal) modStr = ` ${modSign} ${modVal}`;
                const detailsStr = details.length > 5 ? `[${details.slice(0, 5).join(', ')}...]` : `[${details.join(', ')}]`;
                expr = `${count}d${sides}${modStr} ${detailsStr}`;
            } else {
                const flat = parseInt(str);
                if (!isNaN(flat)) total = flat;
            }

            if (!type) {
                const remain = str.replace(regex, '').trim();
                if (remain.length > 1) type = remain;
            }

            return { total, expr, type };
        }

        function showCombatResult(title, data) {
            const m = document.getElementById('combatResultModal');
            if (!m) return;

            document.getElementById('combatTitle').textContent = title;
            document.getElementById('combatRollTotal').textContent = data.total;

            let html = `<div style="color:#ccc;">${data.expr}</div>`;
            if (data.type) html += `<div style="margin-top:5px; color:#888; text-transform:uppercase; font-size:0.75rem; letter-spacing:1px; border:1px solid #333; display:inline-block; padding:2px 8px; border-radius:4px;">${data.type}</div>`;

            if (data.isAttack) {
                let hitColor = '#fff';
                if (data.hit === 20) hitColor = '#ffd700';
                if (data.hit === 1) hitColor = '#d90429';

                html += `<div style="margin-top:20px; border-top:1px solid #333; padding-top:15px; width:100%;">
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">TESTE DE ACERTO (d20)</div>
                <div style="font-size:2rem; color:${hitColor}; font-weight:700;">${data.hit}</div>
            </div>`;
            }

            document.getElementById('combatDetails').innerHTML = html;
            m.style.display = 'flex';
        }

        function closeCombatModal() {
            const m = document.getElementById('combatResultModal');
            if (m) m.style.display = 'none';
        }

        // --- ROLL ACTIONS ---

        function rollSkill(skillName, bonus) {
            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + bonus;

            showCombatResult(skillName.toUpperCase(), {
                total: total,
                expr: `d20 (${d20}) ${bonus >= 0 ? '+' : ''} ${bonus}`,
                type: "PERÍCIA / ATRIBUTO",
                isAttack: false
            });
        }

        function rollActiveEntityAttack(index) {
            if (!activeEntityId || !currentCamp) return;
            let ent = currentCamp.monsters.find(m => m.id === activeEntityId);
            if (!ent) ent = currentCamp.players.find(p => p.charId === activeEntityId);
            if (!ent || !ent.attacks || !ent.attacks[index]) return;

            const atk = ent.attacks[index];

            // 1. Hit Roll
            const bonus = atk.atkBonus || 0;
            const d20 = Math.floor(Math.random() * 20) + 1;
            const hitTotal = d20 + bonus;

            // 2. Crit Check
            const threshold = atk.critThreshold || 20;
            const isCrit = d20 >= threshold;
            const mult = isCrit ? (atk.critMult || 2) : 1;

            // 3. Damage Roll
            const baseRes = parseAndRoll(atk.damage, atk.type, mult);
            let totalDmg = baseRes.total;

            let fullExpr = `<div style="display:flex; flex-direction:column; gap:8px; width:100%; text-align:left;">`;

            if (isCrit) {
                fullExpr += `<div style="background:linear-gradient(90deg, #d90429, #ef233c); color:white; font-weight:bold; text-align:center; padding:5px; border-radius:4px; margin-bottom:10px;">CRÍTICO! (x${mult})</div>`;
            }

            fullExpr += `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:5px;">
                <div><strong style="color:white;">Base</strong> <span style="font-size:0.75rem; color:#aaa;">${baseRes.type}</span></div>
                <div style="text-align:right;">
                    <div style="color:white; font-weight:bold;">${baseRes.total}</div>
                    <div style="color:#666; font-size:0.75rem;">${baseRes.expr}</div>
                </div>
            </div>
        `;

            if (atk.extraDmg && Array.isArray(atk.extraDmg)) {
                atk.extraDmg.forEach(extra => {
                    const extRes = parseAndRoll(extra.damage, extra.type, mult);
                    totalDmg += extRes.total;
                    fullExpr += `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #222; padding-bottom:5px;">
                        <div><span style="color:#aaa;">Extra</span> <span style="font-size:0.75rem;">${extRes.type}</span></div>
                        <div style="text-align:right;">
                            <div style="color:#ccc; font-weight:bold;">+${extRes.total}</div>
                            <div style="color:#555; font-size:0.75rem;">${extRes.expr}</div>
                        </div>
                    </div>
                `;
                });
            }
            fullExpr += `</div>`;

            showCombatResult(atk.name, {
                total: totalDmg,
                expr: fullExpr,
                type: "DANO TOTAL",
                isAttack: true,
                hit: hitTotal
            });
        }
    </script>
    <!-- ATTACK MODAL (Ported from Dashboard) -->
    <div id="attackModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div class="modal-content"
            style="background:#141418; padding:2rem; width:450px; border:1px solid #333; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.8);">

            <h2
                style="margin-top:0; font-family:'Cinzel', serif; color:white; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:20px;">
                <i data-lucide="sword" style="margin-right:10px; color:#d90429;"></i>Criar Ataque
            </h2>

            <!-- Presets -->
            <div style="margin-bottom:20px;">
                <label
                    style="display:block; color:#888; margin-bottom:8px; font-size:0.8rem; text-transform:uppercase;">Predefinições
                    Rápidas</label>
                <div style="display:flex; gap:10px;">
                    <button onclick="setAttackPreset('katana')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">🗡️
                        Katana</button>
                    <button onclick="setAttackPreset('unarmed')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">👊
                        Punhos</button>
                    <button onclick="setAttackPreset('bow')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">🏹
                        Arco</button>
                </div>
            </div>

            <div style="margin-bottom:15px;">
                <label style="color:#aaa; display:block; margin-bottom:5px;">Nome do Ataque</label>
                <input type="text" id="atkNameInput" class="ds-input" placeholder="Ex: Corte Vertical"
                    style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; outline:none;">
            </div>

            <!-- ROW 2: Base Damage & Stats -->
            <div style="display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Dano Base*</label>
                    <input type="text" id="atkDmgInput" class="ds-input" placeholder="Ex: 1d8+2"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; outline:none;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Crítico*</label>
                    <input type="number" id="atkCritInput" class="ds-input" value="20"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; outline:none;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Mult.*</label>
                    <input type="number" id="atkMultInput" class="ds-input" value="2"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; outline:none;">
                </div>
            </div>

            <!-- ROW 3: Bonus, Type, Range -->
            <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Atk Bônus</label>
                    <input type="number" id="atkBonusInput" class="ds-input" value="0"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; outline:none;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Tipo Base</label>
                    <select id="atkTypeInput" class="ds-input"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; cursor:pointer; outline:none;">
                        <option value="" disabled selected>Selecione...</option>
                        <optgroup label="Físicos Padrão">
                            <option value="Cortante">Cortante</option>
                            <option value="Concussão">Concussão</option>
                            <option value="Perfurante">Perfurante</option>
                            <option value="Balístico">Balístico</option>
                        </optgroup>
                        <optgroup label="Elementais & Especiais">
                            <option value="Ácido">Ácido</option>
                            <option value="Elétrico">Elétrico</option>
                            <option value="Fogo">Fogo</option>
                            <option value="Frio">Frio</option>
                            <option value="Necrótico">Necrótico</option>
                            <option value="Psíquico">Psíquico</option>
                            <option value="Primordial">Primordial</option>
                            <option value="Trovejante">Trovejante</option>
                            <option value="Veneno">Veneno</option>
                            <option value="Radiante">Radiante</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Alcance</label>
                    <select id="atkRangeInput" class="ds-input"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; cursor:pointer; outline:none;">
                        <option value="" disabled selected>Selecione...</option>
                        <option value="Toque">Toque</option>
                        <option value="Curto">Curto (1.5m)</option>
                        <option value="Médio">Médio (9m)</option>
                        <option value="Longo">Longo (30m+)</option>
                    </select>
                </div>
            </div>

            <!-- EXTRA DAMAGE SECTION -->
            <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="color:#fff; font-weight:bold;">Dano Extra:</label>
                    <button type="button" onclick="addExtraDmgRow()"
                        style="background:#702963; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; font-weight:bold;">
                        Adicionar
                    </button>
                </div>
                <div id="extraDmgContainer" style="display:flex; flex-direction:column; gap:10px;">
                    <!-- Rows injected here -->
                </div>
            </div>

            <div
                style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; border-top:1px solid #222; padding-top:20px;">
                <button onclick="closeAttackModal()"
                    style="padding:10px 20px; background:transparent; color:#888; border:1px solid #333; border-radius:6px; cursor:pointer; font-weight:bold;">Cancelar</button>
                <button id="btnConfirmAttack" onclick="confirmAddAttack()"
                    style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow:0 0 15px rgba(217, 4, 41, 0.2);">CRIAR
                    ATAQUE</button>
            </div>
        </div>
    </div>
    <!-- COMBAT RESULT MODAL (Ported from Dashboard) -->
    <div id="combatResultModal" style="display:none;" class="modal-overlay">
        <div class="combat-modal-content"
            style="background:#141418; padding:2rem; width:400px; border:1px solid #333; border-radius:12px; box-shadow:0 0 50px rgba(0,0,0,0.9); text-align:center;">
            <div class="combat-header" style="justify-content:center; position:relative; margin-bottom:20px;">
                <h2 id="combatTitle" style="margin:0; font-family:'Cinzel', serif; color:#fff;">Técnica Executada</h2>
                <div class="close-combat" onclick="closeCombatModal()"
                    style="cursor:pointer; position:absolute; right:0; top:0; color:#666;">
                    <i data-lucide="x"></i>
                </div>
            </div>
            <div class="combat-body">
                <div class="combat-roll-container">
                    <span id="combatRollTotal" class="roll-total"
                        style="font-size:4rem; font-weight:800; color:#fff; text-shadow:0 0 20px rgba(255,255,255,0.5); display:block;">0</span>
                    <div id="combatRollExpr" class="roll-expr" style="font-size:1rem; color:#888; margin-top:5px;">...
                    </div>
                </div>
                <!-- Logic for details injection -->
                <div class="combat-details" id="combatDetails"
                    style="margin-top:20px; font-size:1rem; color:#aaa; border-top:1px solid #333; padding-top:15px;">
                </div>
            </div>
        </div>
    </div>
</body>

</html>