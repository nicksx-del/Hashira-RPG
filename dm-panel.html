<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel do Mestre - Demon Slayer RPG</title>
    <!-- Use the same CSS file name as established -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* WISTERIA THEME */
            --primary: #a855f7;
            --primary-dark: #7e22ce;
            --primary-light: #d8b4fe;
            --bg-dark: #0f0e13;
            --surface-dark: #18181b;
            --border-dark: #27272a;
            --accent-purple: #c084fc;
            --danger: #ef4444;
            --glass-bg: rgba(24, 24, 27, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);

            /* Status Colors */
            --hp-high: #22c55e;
            --hp-mid: #eab308;
            --hp-low: #ef4444;
            --blood-red: #b91c1c;

            /* Global */
            --font-display: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        [data-theme="wisteria"] {
            --primary: #70d6ff;
            --primary-light: #a8e6cf;
            --accent: #ff97b7;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-dark);
            color: #e4e4e7;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* WISTERIA LAYOUT UTILS */
        .wis-layout {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .wis-sidebar {
            width: 320px;
            background: var(--surface-dark);
            border-right: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            z-index: 20;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }

        .wis-sidebar.right {
            border-right: none;
            border-left: 1px solid var(--border-dark);
        }

        .wis-header {
            height: 60px;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--surface-dark);
        }

        .wis-title {
            font-family: var(--font-display);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: #a1a1aa;
        }

        .wis-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* WISTERIA CARDS (Log/Iniciativa) */
        .wis-card {
            background: rgba(31, 31, 35, 0.5);
            border: 1px solid var(--border-dark);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            position: relative;
            transition: all 0.2s;
        }

        .wis-card:hover {
            border-color: var(--primary);
            background: rgba(31, 31, 35, 0.8);
        }

        /* WISTERIA ARENA CENTER */
        .wis-arena-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #0a0a0c;
            overflow: hidden;
        }

        .wis-arena-bg {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(168, 85, 247, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(168, 85, 247, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
        }

        .wis-arena-radial {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        /* TOKENS (Updated Wisteria Style) */
        .wis-token {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 20px;
            z-index: 10;
        }

        .wis-token:hover {
            transform: scale(1.05);
            z-index: 50;
        }

        .wis-token.active {
            transform: scale(1.1);
            z-index: 40;
        }

        .wis-token-img-box {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--border-dark);
            background: #111;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wis-token.active .wis-token-img-box {
            border-color: var(--primary);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.6), 0 0 80px rgba(168, 85, 247, 0.3);
            animation: pulse-aura 2s infinite;
        }

        @keyframes pulse-aura {
            0% {
                box-shadow: 0 0 40px rgba(168, 85, 247, 0.6);
            }

            50% {
                box-shadow: 0 0 60px rgba(168, 85, 247, 0.9);
            }

            100% {
                box-shadow: 0 0 40px rgba(168, 85, 247, 0.6);
            }
        }

        .wis-token-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
        }

        .wis-token-bar {
            width: 90px;
            height: 6px;
            background: #111;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
            border: 1px solid #333;
            position: relative;
        }

        .wis-token-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .wis-token-name {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: -12px;
            /* Overlap bottom of token */
            z-index: 2;
            font-weight: 700;
        }

        /* ACTION DOCK (Floating) */
        .wis-dock {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: #18181b;
            padding: 8px;
            border-radius: 16px;
            border: 1px solid var(--border-dark);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            z-index: 100;
        }

        .wis-dock-btn {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background: #27272a;
            color: #a1a1aa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .wis-dock-btn:hover {
            background: #3f3f46;
            color: #fff;
            transform: translateY(-2px);
        }

        .wis-dock-btn.primary {
            background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
            color: #fff;
            height: 80px;
            width: 80px;
            margin-top: -30px;
            /* Pop up */
            box-shadow: 0 10px 20px rgba(168, 85, 247, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .wis-dock-btn.primary:hover {
            transform: translateY(-5px) scale(1.05);
            filter: brightness(1.1);
        }

        .wis-dock-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* HEADER & NAV */
        .dm-nav {
            height: 50px;
            background: var(--surface-dark);
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 20px;
            z-index: 50;
        }

        .nav-tab {
            color: #71717a;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            cursor: pointer;
            height: 50px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #d4d4d8;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* --- NAVIGATION --- */
        .dm-nav {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: rgba(10, 10, 15, 0.9);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            padding: 0 20px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            padding: 10px 24px;
            border-radius: 8px;
            color: #888;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }

        .nav-tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: #fff;
            background: rgba(157, 78, 221, 0.15);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.2);
        }

        /* --- VIEWS --- */
        .view-section {
            flex: 1;
            display: none;
            /* Hidden by default */
            overflow: hidden;
            width: 100%;
            height: calc(100vh - 60px);
            position: relative;
        }

        .view-section.active {
            display: flex;
            /* Flex to keep column layout working */
            flex-direction: column;
            animation: fadeInView 0.3s ease;
        }

        @keyframes fadeInView {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- VISUALS --- */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.04;
        }

        /* --- LAYOUT OVERRIDES FOR TABS --- */
        .col-left,
        .col-right,
        .col-center {
            width: 100%;
            height: 100%;
            border: none;
            /* Remove borders in full view */
            background: transparent;
            /* Let background show through */
        }

        /* Adjust Log Feed to fit new full width nicely */
        .col-left {
            max-width: 800px;
            margin: 0 auto;
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }

        /* Adjust Inspector to fit new full width nicely */
        .col-right {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            /* Example split for Personagens tab? Or stay column? */
            /* Actually, user wanted tabs. Let's keep existing internal structure but centered */
            display: flex;
            max-width: 900px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
        }

        .col-center {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* --- HEADERS --- */
        .panel-header {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            letter-spacing: 1px;
            color: #fff;
        }

        .panel-header i {
            color: var(--primary);
            margin-right: 10px;
        }

        .page-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: #fff;
            margin: 0;
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.5);
        }

        .combat-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 20, 25, 0.6);
        }

        /* --- LOG FEED --- */
        .log-feed {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .log-item,
        .log-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid var(--primary);
            padding: 12px;
            border-radius: 0 6px 6px 0;
            font-size: 0.85rem;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .log-card.crit {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .log-card.fail {
            border-color: var(--blood-red);
            background: rgba(220, 20, 60, 0.05);
        }

        /* --- VISUAL COMBAT ARENA --- */

        /* 1. TOP RAIL (TIMELINE) */
        .combat-rail {
            height: 100px;
            background: rgba(10, 10, 15, 0.8);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 40px;
            gap: 20px;
            overflow-x: auto;
            position: relative;
            backdrop-filter: blur(5px);
            z-index: 20;
        }

        .rail-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #333;
            background-size: cover;
            background-position: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            opacity: 0.5;
            filter: grayscale(0.8);
            flex-shrink: 0;
        }

        .rail-avatar.active {
            width: 80px;
            height: 80px;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
            opacity: 1;
            filter: grayscale(0);
            z-index: 10;
        }

        .rail-avatar.next {
            opacity: 0.8;
            filter: grayscale(0.3);
            border-color: #666;
        }

        .rail-connector {
            height: 2px;
            background: #333;
            flex: 1;
            min-width: 20px;
            display: none;
            /* Simplification: Just avatars for now */
        }

        /* 2. THE STAGE (GRID) */
        .combat-stage {
            flex: 1;
            background-color: #050508;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Center the tokens for now, pseudo-positioning */
        }

        /* Spotlight & Dimming */
        .combat-stage.spotlight-mode .token-group:not(.active) {
            opacity: 0.4;
            filter: grayscale(0.6) blur(1px);
            transform: scale(0.95);
        }

        .combat-stage.spotlight-mode .token-group.active {
            z-index: 100;
            filter: drop-shadow(0 0 30px rgba(0, 0, 0, 0.8));
        }

        /* MOVE MODE: Disable token interactions so clicks hit the stage */
        .wis-arena-container.move-mode .wis-token {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Cursor Highlight Box */
        .cursor-highlight {
            position: absolute;
            width: 64px;
            height: 64px;
            background: rgba(168, 85, 247, 0.3);
            border: 2px solid var(--primary);
            pointer-events: none;
            z-index: 5;
            display: none;
            box-shadow: 0 0 15px var(--primary);
            transition: all 0.05s linear;
        }

        /* Token Styles override/additions */
        .token-group {
            position: relative;
            /* Changed from absolute to relative for flex layout */
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            margin: 15px;
            /* Better spacing */
        }

        .token-group:hover {
            z-index: 50;
            transform: translateY(-5px);
        }

        /* Token Quick Actions Overlay */
        .token-quick-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: 0.2s;
            backdrop-filter: blur(2px);
        }

        .token-group:hover .token-quick-overlay {
            opacity: 1;
        }

        .token-btn-mini {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .token-btn-mini:hover {
            transform: scale(1.1);
            background: #fff;
            color: #000;
        }

        .token-btn-mini.heal:hover {
            background: var(--hp-high);
            color: #fff;
            border-color: var(--hp-high);
        }

        .token-btn-mini.dmg:hover {
            background: var(--hp-low);
            color: #fff;
            border-color: var(--hp-low);
        }

        .token-ring {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            padding: 4px;
            /* Gap for ring */
            background: conic-gradient(var(--hp-high) 0% 100%);
            /* Dynamic HP fill */
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
            transition: transform 0.3s;
        }

        .token-ring[data-hp-state="low"] {
            background: conic-gradient(var(--hp-low) 0% 100%);
        }

        .token-ring[data-hp-state="mid"] {
            background: conic-gradient(var(--hp-mid) 0% 100%);
        }

        .token-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: #111;
            border: 3px solid #000;
        }

        .token-active-glow {
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            opacity: 0;
            animation: pulse-ring 2s infinite;
            pointer-events: none;
        }

        .token-group.active .token-active-glow {
            opacity: 1;
        }

        .token-group.active .token-ring {
            transform: scale(1.1);
        }

        .token-name {
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #fff;
            font-weight: 600;
            border: 1px solid #333;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
            /* Let clicks pass to token */
        }

        .token-hp-bar {
            width: 80px;
            height: 4px;
            background: #222;
            margin-top: 4px;
            border-radius: 2px;
            overflow: hidden;
        }

        .token-hp-val {
            height: 100%;
            background: var(--hp-high);
            transition: width 0.3s;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0;
                box-shadow: 0 0 0 0 rgba(157, 78, 221, 0.7);
            }

            50% {
                opacity: 1;
                box-shadow: 0 0 20px 10px rgba(157, 78, 221, 0);
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* 3. BOTTOM DOCK */
        .combat-dock {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(15, 15, 20, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .dock-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #2a2a35, #1a1a20);
            border: 1px solid #444;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .dock-btn svg {
            margin-bottom: 2px;
        }

        .dock-btn:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            color: var(--primary-light);
            background: linear-gradient(135deg, #3a3a45, #2a2a30);
        }

        .dock-btn.main-action {
            background: linear-gradient(135deg, var(--primary), #5b21b6);
            border: none;
            box-shadow: 0 0 15px var(--primary-glow);
            width: 60px;
            height: 60px;
            margin-top: -10px;
            /* Pop out */
        }

        .dock-btn.main-action:hover {
            transform: translateY(-8px) scale(1.05);
            filter: brightness(1.2);
        }

        /* Floating Damage Text */
        .damage-number {
            position: absolute;
            font-size: 2rem;
            font-weight: 800;
            animation: floatUp 1.2s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            z-index: 200;
        }

        .damage-number.heal {
            color: #4ade80;
            text-shadow: 0 0 10px #4ade80;
        }

        .damage-number.dmg {
            color: #ef4444;
            text-shadow: 0 0 10px #ef4444;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 1;
                transform: translateY(-20px) scale(1.2);
            }

            100% {
                transform: translateY(-80px) scale(1);
                opacity: 0;
            }
        }

        /* Turn Announcer Banner */
        .turn-announcer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid var(--primary);
            padding: 20px 60px;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .turn-announcer.show {
            animation: announcePop 2.5s ease-in-out forwards;
        }

        @keyframes announcePop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            15% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }

            20% {
                transform: translate(-50%, -50%) scale(1);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.2);
                filter: blur(10px);
            }
        }

        /* Token Legibility Boost */
        .token-name {
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.95rem;
            /* Larger */
            color: #fff;
            font-weight: 800;
            /* Bolder */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            text-shadow: 0 2px 4px #000;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
            z-index: 20;
        }

        /* --- INSPECTOR --- */
        .inspector-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #777;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .tab-btn:hover {
            color: #ccc;
            background: rgba(255, 255, 255, 0.02);
        }

        .tab-btn.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary);
            background: rgba(157, 78, 221, 0.05);
        }

        .inspector-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .profile-card {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: #333;
            object-fit: cover;
            border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .profile-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .profile-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            font-family: 'Cinzel', serif;
        }

        .profile-class {
            color: var(--primary);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .attr-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .attr-box {
            background: #1a1a20;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .attr-val {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fff;
        }

        .attr-label {
            font-size: 0.7rem;
            color: #777;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Conditions Grid */
        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .cond-badge {
            font-size: 0.7rem;
            padding: 4px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            text-align: center;
            color: #777;
            cursor: pointer;
            transition: 0.2s;
        }

        .cond-badge:hover {
            border-color: #555;
            color: #ddd;
        }

        .cond-badge.active {
            background: rgba(220, 20, 60, 0.2);
            border-color: var(--blood-red);
            color: var(--blood-red);
            font-weight: 700;
        }

        /* Bestiary Grid */
        .bestiary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            padding: 10px 0;
        }

        .mob-card {
            background: #1a1a20;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .mob-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            background: #222;
        }

        .mob-card-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #000;
            margin-bottom: 8px;
            object-fit: cover;
            border: 2px solid #333;
        }

        .mob-card-name {
            font-weight: 700;
            font-size: 0.85rem;
            color: #fff;
            margin-bottom: 4px;
        }

        .mob-card-meta {
            font-size: 0.7rem;
            color: #777;
        }

        .mob-card-add {
            margin-top: 8px;
            width: 100%;
            background: #333;
            border: none;
            color: #fff;
            font-size: 0.75rem;
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            transition: 0.2s;
        }

        .mob-card-add:hover {
            background: var(--primary);
        }

        /* General UI */
        .btn {
            background: linear-gradient(135deg, rgba(39, 39, 50, 0.9) 0%, rgba(30, 30, 40, 0.8) 100%);
            border: 1px solid rgba(157, 78, 221, 0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
        }

        .btn-danger {
            border-color: var(--blood-red);
            background: rgba(220, 20, 60, 0.1);
            color: var(--blood-red);
        }

        .ordem-bar-row {
            display: flex;
            background: #111;
            height: 32px;
            border-radius: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .ordem-bar-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px #000;
        }

        .ordem-bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            z-index: 0;
            transition: width 0.3s;
        }

        .bar-red {
            background: var(--blood-red);
        }

        .bar-purple {
            background: #7c3aed;
        }

        .text-overlay {
            position: relative;
            z-index: 1;
        }

        .ordem-bar-btn {
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            color: #aaa;
            font-size: 10px;
        }

        .ordem-bar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .acc-item {
            margin-bottom: 8px;
            background: #222;
            border-radius: 6px;
            overflow: hidden;
        }

        .acc-header {
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .acc-header:hover {
            background: #333;
        }

        .d-input {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        .d-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        /* DICE SYSTEM & TOAST (Restored) */
        .dice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .dice-wrapper {
            perspective: 600px;
            width: 100px;
            height: 100px;
            margin-bottom: 50px;
        }

        .dice-cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: translateZ(-50px);
            transition: transform 1s;
        }

        .dice-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: var(--surface-dark);
            border: 2px solid var(--primary);
            color: white;
            font-size: 40px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5) inset;
        }

        .dice-face.front {
            transform: rotateY(0deg) translateZ(50px);
        }

        .dice-face.right {
            transform: rotateY(90deg) translateZ(50px);
        }

        .dice-face.back {
            transform: rotateY(180deg) translateZ(50px);
        }

        .dice-face.left {
            transform: rotateY(-90deg) translateZ(50px);
        }

        .dice-face.top {
            transform: rotateX(90deg) translateZ(50px);
        }

        .dice-face.bottom {
            transform: rotateX(-90deg) translateZ(50px);
        }

        #diceResultDisplay {
            font-size: 3rem;
            font-weight: 800;
            color: #fff;
            font-family: var(--font-display);
            text-shadow: 0 0 20px var(--primary);
            min-height: 60px;
        }

        #diceAttackInfo {
            font-size: 1.2rem;
            color: #aaa;
            margin-top: 10px;
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #18181b;
            border: 1px solid var(--border-dark);
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body data-theme="blood-moon">
    <div class="noise-overlay"></div>

    <!-- NAVIGATION BAR -->
    <nav class="dm-nav">
        <div class="nav-tab active" onclick="switchView('combat')">Combate</div>
        <div class="nav-tab" onclick="switchView('chars')">Personagens</div>
        <div class="nav-tab" onclick="switchView('story')">História</div>
        <div style="margin-left:auto; display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="window.location.href='campaign-hub.html'"
                style="padding:4px 10px; font-size:0.8rem;">Sair</button>
        </div>
    </nav>

    <!-- VIEW: HISTORY (Log) -->
    <div id="view-story" class="view-section">
        <div class="col-left">
            <div class="panel-header">
                <span><i data-lucide="scroll-text"></i> Histórico</span>
                <span style="font-size:0.8rem; opacity:0.6;">Chat & Logs</span>
            </div>
            <div class="log-feed" id="logFeed">
                <div class="log-item">
                    <span class="log-time">10:00</span>
                    <span>Bem-vindo ao Demon Slayer RPG.</span>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Enviar mensagem ou comando (/roll 1d20)...">
                <button class="btn-send" onclick="sendChat()"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>

    <!-- VIEW: COMBAT (Wisteria Master Dashboard Layout) -->
    <div id="view-combat" class="view-section active" style="height: calc(100vh - 50px); padding: 0;">
        <div class="wis-layout">

            <!-- LEFT SIDEBAR: LOG/RESULTS -->
            <div class="wis-sidebar">
                <div class="wis-header">
                    <span class="wis-title">Resultados</span>
                    <button class="btn-icon" onclick="clearLog()" title="Limpar"><i data-lucide="trash-2"
                            size="16"></i></button>
                </div>
                <div class="wis-scroll" id="logFeed">
                    <!-- Log Cards Injected Here -->
                    <div style="text-align:center; padding:20px; color:#555;">
                        <i data-lucide="history" size="48" style="opacity:0.2;"></i>
                    </div>
                </div>
            </div>

            <!-- CENTER: ARENA STAGE -->
            <div class="wis-arena-container">
                <div class="wis-arena-bg" style="
                    background-image: 
                        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
                    background-size: 64px 64px;
                    background-position: center;
                    position: absolute; inset: 0; pointer-events: none; z-index: 0;
                "></div>
                <div class="wis-arena-radial" style="position: absolute; inset: 0; pointer-events: none; z-index: 1;">
                </div>

                <!-- Arena Header / Turn Info -->
                <div
                    style="position:absolute; top:20px; left:50%; transform:translateX(-50%); z-index:20; display:flex; align-items:center; gap:20px;">
                    <div class="flex-col center">
                        <span
                            style="font-size:0.65rem; color:#71717a; text-transform:uppercase; letter-spacing:0.1em;">ROUND</span>
                        <span style="font-family:'Cinzel'; font-size:1.5rem; font-weight:700; color:#fff;"
                            id="roundDisplay">1</span>
                    </div>
                    <div class="flex center"
                        style="background:rgba(24,24,27,0.8); border:1px solid #3f3f46; border-radius:30px; padding:4px 20px; height:50px;">
                        <span style="font-size:0.8rem; color:#a1a1aa; margin-right:10px;">TURNO ATUAL</span>
                        <div id="turnDisplay"
                            style="color:#d8b4fe; font-weight:700; font-family:'Cinzel'; font-size:1.1rem;">-</div>
                    </div>
                </div>

                <!-- Floating Damage/Heal Container -->
                <div id="damageLayer" style="position:absolute; inset:0; pointer-events:none; z-index:200;"></div>

                <!-- THE STAGE (Tokens) -->
                <!-- THE STAGE (Tokens) -->
                <div id="combatStage" style="position:absolute; inset:0; z-index:10;"
                    ondragover="event.preventDefault();" ondrop="handleStageDrop(event)"
                    onclick="handleStageClick(event)" onmousemove="handleStageMouseMove(event)">
                    <div id="cursorHighlight" class="cursor-highlight"></div>
                    <!-- Tokens Injected Here -->
                </div>

                <!-- ACTION DOCK -->
                <div class="wis-dock">
                    <div class="wis-dock-btn" onclick="toggleMoveMode()" title="Mover Token (Turno)">
                        <i data-lucide="move" size="24"></i>
                        <span class="wis-dock-label">Mover</span>
                    </div>
                    <div class="wis-dock-btn primary" onclick="nextTurn()">
                        <i data-lucide="chevrons-right" size="32"></i>
                        <span class="wis-dock-label">Turno</span>
                    </div>
                    <div class="wis-dock-btn" onclick="rollInitiativeAll()" title="Rolar Iniciativa">
                        <i data-lucide="dices" size="24"></i>
                        <span class="wis-dock-label">Inic.</span>
                    </div>
                    <div class="wis-dock-btn" onclick="clearCombat()" title="Limpar Combate">
                        <i data-lucide="trash-2" size="24"></i>
                        <span class="wis-dock-label">Limpar</span>
                    </div>
                </div>

                <!-- Bottom Left Tools (Combat Control) -->
                <div
                    style="position:absolute; bottom:20px; left:20px; display:flex; flex-direction:column; gap:10px; z-index:50;">
                    <div class="wis-dock-btn" style="width:40px; height:40px; border-radius:50%; color:var(--hp-high);"
                        onclick="startCombat()" title="Iniciar Combate">
                        <i data-lucide="swords" size="18"></i>
                    </div>
                    <div class="wis-dock-btn" style="width:40px; height:40px; border-radius:50%; color:#c084fc;"
                        onclick="rollInitiativeAll()" title="Rolar Iniciativa (NPCs)">
                        <i data-lucide="dices" size="18"></i>
                    </div>
                    <div class="wis-dock-btn" style="width:40px; height:40px; border-radius:50%; color:var(--danger);"
                        onclick="endCombat()" title="Encerrar Combate">
                        <i data-lucide="stop-circle" size="18"></i>
                    </div>
                </div>

            </div>

            <!-- RIGHT SIDEBAR: INSPECTOR -->
            <div class="wis-sidebar right" id="inspectorSidebar">
                <!-- Sidebar Tabs Header -->
                <div class="wis-header" style="padding:0; gap:0;">
                    <div id="sbTabInspector" class="nav-tab active"
                        style="flex:1; justify-content:center; border-radius:0; height:60px;"
                        onclick="switchSidebarTab('inspector')">
                        INSPETOR
                    </div>
                    <div id="sbTabBestiary" class="nav-tab"
                        style="flex:1; justify-content:center; border-radius:0; height:60px;"
                        onclick="switchSidebarTab('bestiary')">
                        BESTIÁRIO
                    </div>
                </div>

                <!-- Inspector Content -->
                <div id="sidebarInspector" class="wis-scroll">
                    <div id="inspector">
                        <div style="text-align:center; color:#555; margin-top:40px;">Selecione um token</div>
                    </div>
                </div>

                <!-- Bestiary Content (Hidden by Default) -->
                <div id="sidebarBestiary" class="wis-scroll" style="display:none;">
                    <div style="padding:10px;">
                        <input type="text" id="sbMobSearch" placeholder="Buscar..." class="d-input"
                            style="width:100%; border-radius:20px; padding:8px 15px; margin-bottom:15px; background:#0a0a0c; border-color:#333;"
                            onkeyup="renderSidebarBestiary()">

                        <div id="sbBestiaryList" style="display:flex; flex-direction:column; gap:8px;">
                            <!-- Sidebar Mobs Injected Here -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- VIEW: CHARACTERS (Inspector) -->
    <div id="view-chars" class="view-section">
        <div class="col-right">
            <div class="inspector-tabs">
                <div class="tab-btn active" onclick="switchInspectorTab('sheet', this)">Ficha</div>
                <div class="tab-btn" onclick="switchInspectorTab('bestiary', this)">Bestiário</div>
            </div>

            <div id="inspectorContainer" class="inspector-content">
                <div id="inspector">
                    <div style="text-align:center; color:#555; margin-top:50px;">
                        <i data-lucide="user-search" size="48" style="opacity:0.2; margin-bottom:10px;"></i>
                        <br>Selecione um personagem na aba Combate para ver detalhes aqui.
                        <br><br>
                        <!-- Maybe add a search/list here too? -->
                    </div>
                </div>
            </div>

            <!-- Bestiary List Hidden by Default -->
            <div id="bestiaryContainer" class="inspector-content" style="display:none;">
                <input type="text" id="mobSearch" placeholder="Buscar criatura..." class="d-input"
                    style="margin-bottom:10px; width:100%; border-radius:10px; text-align:left;"
                    onkeyup="renderBestiaryTab()">
                <div id="bestiaryList" style="display:flex; flex-direction:column; gap:5px;"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="diceOverlay" class="dice-overlay" onclick="closeDiceOverlay()">
        <div class="dice-wrapper">
            <div id="diceCube" class="dice-cube">
                <div class="dice-face front">20</div>
                <div class="dice-face back">1</div>
                <div class="dice-face right">5</div>
                <div class="dice-face left">15</div>
                <div class="dice-face top">10</div>
                <div class="dice-face bottom">2</div>
            </div>
        </div>
        <div id="diceResultDisplay"></div>
        <div id="diceAttackInfo"></div>
    </div>

    <!-- ADD CREATURE MODAL -->
    <div id="addCreatureModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-family:'Cinzel', serif; margin-top:0;">Adicionar Criatura</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-primary" style="flex:1;"
                    onclick="switchRightTab('bestiary'); closeModal('addCreatureModal')">Do Bestiário</button>
                <button class="btn" style="flex:1;" onclick="openCustomMobModal(); closeModal('addCreatureModal')">Criar
                    Nova</button>
            </div>
            <button class="btn btn-danger" onclick="closeModal('addCreatureModal')"
                style="width:100%;">Cancelar</button>
        </div>
    </div>

    <!-- CUSTOM MOB MODAL -->
    <div id="customMobModal" class="modal-overlay" style="z-index:110;">
        <div class="modal-box" style="width:600px; max-width:95%;">
            <h2 style="font-family:'Cinzel', serif; margin-top:0;">Criar Monstro Personalizado</h2>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label>Nome</label>
                    <input type="text" id="cmName" class="d-input" style="width:100%;">
                </div>
                <div>
                    <label>CR (Desafio)</label>
                    <input type="text" id="cmCR" class="d-input" style="width:100%;">
                </div>
                <div>
                    <label>HP Máximo</label>
                    <input type="number" id="cmHP" class="d-input" style="width:100%;">
                </div>
                <div>
                    <label>CA (Defesa)</label>
                    <input type="number" id="cmAC" class="d-input" style="width:100%;">
                </div>
            </div>

            <div style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">Ataques / Ações</div>
            <div id="cmAttacksList" style="max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
            <button class="btn" onclick="addCustomAttackRow()"
                style="margin-bottom:20px; width:100%; border-style:dashed;">+ Adicionar Ataque</button>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-danger"
                    onclick="document.getElementById('customMobModal').style.display='none'">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCustomMob()">Salvar & Adicionar</button>
            </div>
        </div>
    </div>


    <div id="toast" class="toast">
        <div id="toastMsg">Notificação</div>
    </div>

    <!-- SERVER STATUS INDICATOR -->
    <div id="serverStatus" title="Offline"
        style="position:fixed; bottom:20px; right:20px; width:12px; height:12px; background:#ef4444; border-radius:50%; box-shadow:0 0 5px #ef4444; z-index:9999; transition:0.3s; cursor:help;">
    </div>

    <script src="breathing_db.js"></script>
    <script src="breathing_class_db.js"></script>
    <script src="bestiary_db.js"></script>
    <script src="campaign.js"></script>
    <script>
        const CAMP_ID = new URLSearchParams(window.location.search).get('id');
        let currentCamp = null;
        let selectedId = null;

        window.onload = function () {
            if (!CAMP_ID) {
                alert("ID da campanha não fornecido!");
                window.location.href = 'campaign-hub.html';
                return;
            }

            // Connect WS
            // Note: window.CampaignSystem might need campaign.js to be fully loaded
            if (window.CampaignSystem && window.CampaignSystem.connectServer) {
                window.CampaignSystem.connectServer(CAMP_ID);
            }

            loadData();

            // Initialize Tabs
            renderBestiaryTab();
            switchView('combat');

            // --- LISTENERS FOR REAL-TIME SYNC ---
            window.addEventListener('server-status', (e) => {
                const ind = document.getElementById('serverStatus');
                if (e.detail === 'online') {
                    ind.style.background = '#2ecc71';
                    ind.style.boxShadow = '0 0 5px #2ecc71';
                    ind.title = "Online";
                    showToast('Servidor Conectado');
                } else {
                    ind.style.background = '#ef4444';
                    ind.style.boxShadow = '0 0 5px #ef4444';
                    ind.title = "Offline";
                }
            });

            window.addEventListener('character-synced', (e) => {
                // Determine update source
                const update = e.detail;
                if (!currentCamp) return;

                // 1. Try to find in players
                let p = currentCamp.players.find(x => x.charId === update.id);
                if (p) {
                    // Update Local Data
                    Object.assign(p, update);
                    // Force a save to keep sync
                    window.CampaignSystem.saveCampaigns(window.CampaignSystem.getCampaigns());

                    renderCombatList();
                    // If selected, re-render
                    if (selectedId === update.id) renderInspector(p);
                    showToast(`Sync: ${p.name}`);
                }
            });

            if (window.lucide) lucide.createIcons();
        };


        function loadData() {
            if (!window.CampaignSystem) return;
            currentCamp = window.CampaignSystem.getCampaignById(CAMP_ID);
            if (!currentCamp) return;

            // const cn = document.getElementById('campaignName');
            // if (cn) cn.innerText = currentCamp.name.toUpperCase();

            renderCombatList();
            // renderAgentGrid(); // Not using agent grid in this layout for now

            // If selection exists, re-render inspector
            if (selectedId) {
                const ent = getEntity(selectedId);
                if (ent) renderInspector(ent);
            }

            updateLog(); // Initial log render
            // updateReactionStatus(); 
        }

        // --- RENDERERS ---

        // --- RENDERERS (Wisteria Adapted) ---

        function renderCombatList() {
            // Target the Wisteria Stage
            const stage = document.getElementById('combatStage');
            const turnDisplay = document.getElementById('turnDisplay');
            if (!stage) return;
            stage.innerHTML = "";

            // Logic: Determine order...
            let entities = getAllEntities();
            if (!currentCamp.combat.active) {
                // If combat not active, just sort by init descending
                entities.sort((a, b) => (b.initiative || 0) - (a.initiative || 0));
                if (turnDisplay) turnDisplay.innerText = "COMBATE PAUSADO";
                if (turnDisplay) turnDisplay.style.color = "#71717a";
            } else {
                // Use combat order
                const ordered = [];
                currentCamp.combat.order.forEach(id => {
                    const e = entities.find(x => (x.id === id || x.charId === id));
                    if (e) ordered.push(e);
                });
                entities.forEach(e => {
                    if (!ordered.find(x => (x.id || x.charId) === (e.id || e.charId))) ordered.push(e);
                });
                entities = ordered;

                // Update Turn Header
                const activeId = currentCamp.combat.order[currentCamp.combat.turnIndex];
                const activeEnt = getEntity(activeId);
                if (turnDisplay && activeEnt) {
                    turnDisplay.innerText = activeEnt.name.toUpperCase();
                    turnDisplay.style.color = "#d8b4fe"; // Primary focus
                }
            }

            // Render Tokens into the center stage
            // We use ABSOLUTE positioning now (Visual Map)

            // Set Stage Handlers
            stage.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "copy";
            };
            stage.ondrop = (e) => {
                e.preventDefault();
                handleStageDrop(e);
            };

            stage.innerHTML = ""; // Clear
            // We don't use 'grid' container anymore, just stage as relative parent

            entities.forEach(e => {
                const id = e.id || e.charId;
                const isTurn = currentCamp.combat.active && currentCamp.combat.order[currentCamp.combat.turnIndex] === id;
                const isSelected = selectedId === id;
                const hpPct = e.maxHP ? (e.currentHP / e.maxHP) * 100 : 0;

                // Color Logic
                let barColor = "var(--hp-high)";
                if (hpPct <= 50) barColor = "var(--hp-mid)";
                if (hpPct <= 25) barColor = "var(--hp-low)";

                // Position
                const posX = e.x || (stage.clientWidth / 2 - 40); // Default Center
                const posY = e.y || (stage.clientHeight / 2 - 40);

                const token = document.createElement('div');
                token.className = `wis-token ${isTurn ? 'active' : ''}`;

                // Absolute Styling
                token.style.position = 'absolute';
                token.style.left = posX + 'px';
                token.style.top = posY + 'px';
                token.style.margin = '0'; // Remove grid margin
                token.style.zIndex = isSelected ? 100 : 10;

                if (isSelected) {
                    token.style.transform = "scale(1.15)";
                    token.style.filter = "brightness(1.2)";
                }

                // Make Token Draggable (Reposition)
                token.draggable = true;
                token.ondragstart = (ev) => {
                    ev.dataTransfer.setData("type", "move");
                    ev.dataTransfer.setData("id", id);
                    ev.dataTransfer.setData("offsetX", ev.clientX - token.getBoundingClientRect().left);
                    ev.dataTransfer.setData("offsetY", ev.clientY - token.getBoundingClientRect().top);
                    ev.stopPropagation();
                };

                token.onclick = (ev) => { ev.stopPropagation(); selectEntity(id); };

                token.innerHTML = `
                    <div class="wis-token-img-box">
                        <div class="wis-token-img" style="background-image: url('https://ui-avatars.com/api/?name=${e.name}&background=random')"></div>
                        ${isTurn ? `<div style="position:absolute; inset:-5px; border-radius:50%; border:2px solid var(--primary); animation:pulse-slow 2s infinite;"></div>` : ''}
                    </div>
                    
                    <div class="wis-token-name">${e.name}</div>
                    
                    <div class="wis-token-bar">
                        <div class="wis-token-bar-fill" style="width:${hpPct}%; background-color:${barColor};"></div>
                    </div>

                    <!-- Quick Actions Overlay (Hidden until hover) -->
                    <div class="token-quick-overlay">
                         <div class="token-btn-mini dmg" onclick="event.stopPropagation(); modStat('${id}', 'hp', -5, event)" title="-5 HP">-</div>
                         <div class="token-btn-mini heal" onclick="event.stopPropagation(); modStat('${id}', 'hp', 5, event)" title="+5 HP">+</div>
                    </div>
                `;

                stage.appendChild(token);
            });

            if (window.lucide) lucide.createIcons();
            // Check for turn announcement if implemented
            if (typeof checkForTurnAnnouncement === 'function') checkForTurnAnnouncement();
        }

        // --- COMBAT HELPERS ---

        let lastAnnouncedTurnId = null;

        function modStat(id, stat, delta, event) {
            if (!currentCamp) return;
            const ent = getEntity(id);
            if (!ent) return;

            // Visual feedback
            if (stat === 'hp' && event) {
                showFloatingNumber(event.clientX, event.clientY, delta);
            }

            if (stat === 'hp') {
                let newHP = (ent.currentHP || 0) + delta;
                if (newHP > ent.maxHP) newHP = ent.maxHP;
                if (newHP < 0) newHP = 0;
                ent.currentHP = newHP;
            }

            // Sync
            if (ent.isNPC) {
                // Update mob in campaign
                const mobIdx = currentCamp.monsters.findIndex(m => m.id === id);
                if (mobIdx >= 0) currentCamp.monsters[mobIdx] = ent;
                window.CampaignSystem.saveCampaigns();
                window.CampaignSystem.sendUpdate(CAMP_ID, { type: 'combat-update' });
            } else {
                // Update player
                window.CampaignSystem.updateEntity(CAMP_ID, id, ent);
            }
            renderCombatList(); // Optimistic update
            if (selectedId === id) renderInspector(ent);
        }

        function showFloatingNumber(x, y, val) {
            const el = document.createElement('div');
            el.className = `damage-number ${val > 0 ? 'heal' : 'dmg'}`;
            el.textContent = val > 0 ? `+${val}` : val;

            // Adjust position slightly random
            const rx = x + (Math.random() * 40 - 20);
            const ry = y + (Math.random() * 40 - 20);

            el.style.left = rx + 'px';
            el.style.top = ry + 'px';

            // Ensure appended to damageLayer if exists, else body
            const layer = document.getElementById('damageLayer');
            if (layer) layer.appendChild(el);
            else document.body.appendChild(el);

            setTimeout(() => el.remove(), 1200);
        }

        function checkForTurnAnnouncement() {
            if (!currentCamp.combat.active) return;
            const currentId = currentCamp.combat.order[currentCamp.combat.turnIndex];
            if (currentId && currentId !== lastAnnouncedTurnId) {
                lastAnnouncedTurnId = currentId;
                const ent = getEntity(currentId);
                if (ent) announceTurn(ent.name);
            }
        }

        // --- COMBAT CONTROL ---

        function startCombat() {
            if (!currentCamp) return;
            currentCamp.combat.active = true;
            currentCamp.combat.turnIndex = 0;
            currentCamp.combat.round = 1;

            // Re-calc order based on initiative
            let entities = getAllEntities();
            entities.sort((a, b) => (b.initiative || 0) - (a.initiative || 0));
            currentCamp.combat.order = entities.map(e => e.id || e.charId);

            window.CampaignSystem.saveCampaigns();
            window.CampaignSystem.sendUpdate(CAMP_ID, { type: 'combat-start' });
            renderCombatList();
            showToast("Combate Iniciado!");
        }

        function endCombat() {
            if (!currentCamp) return;
            if (!confirm("Encerrar combate?")) return;
            currentCamp.combat.active = false;
            currentCamp.combat.order = [];
            currentCamp.combat.turnIndex = 0;

            window.CampaignSystem.saveCampaigns();
            window.CampaignSystem.sendUpdate(CAMP_ID, { type: 'combat-end' });
            renderCombatList();
            showToast("Combate Finalizado");
        }

        function nextTurn() {
            if (!currentCamp || !currentCamp.combat.active) return;

            // Ensure order exists
            if (!currentCamp.combat.order || currentCamp.combat.order.length === 0) {
                showToast("Ordem de combate vazia!");
                return;
            }

            // Logic handled by CampaignSystem, but let's double check here or just call it
            window.CampaignSystem.nextTurn(CAMP_ID);

            // Reload local data to reflect changes
            loadData();

            // Visual FEEDBACK
            const activeId = currentCamp.combat.order[currentCamp.combat.turnIndex];
            const ent = getEntity(activeId);
            if (ent) {
                announceTurn(ent.name);
                showToast(`Turno de: ${ent.name}`);
            }
        }

        function rollInitiativeAll() {
            if (!currentCamp) return;
            let entities = getAllEntities();
            entities.forEach(e => {
                if (e.isNPC) {
                    // Simple DnD roll: d20 + generic mod (let's say +2 for mobs if no stat)
                    const mod = Math.floor(((e.stats?.dex || 10) - 10) / 2); // if stats exist
                    e.initiative = Math.floor(Math.random() * 20) + 1 + (mod || 0);
                }
                // Players usually roll their own, but DM can auto-roll for them if needed
                // For now, only roll NPCs to avoid overwriting player inputs
            });
            window.CampaignSystem.saveCampaigns();
            renderCombatList();
            showToast("Iniciativa Rolada (NPCs)");
        }

        function announceTurn(name) {
            const el = document.getElementById('turnAnnouncer');
            const nameEl = document.getElementById('announcerName');
            if (!el || !nameEl) return;

            nameEl.textContent = name;

            // Re-trigger animation
            el.classList.remove('show');
            void el.offsetWidth; // trigger reflow
            el.classList.add('show');
        }

        function updateInit(id, val, isNPC) {
            if (!currentCamp) return;
            const ent = getEntity(id);
            if (!ent) return;
            ent.initiative = parseInt(val) || 0;

            if (ent.isNPC) {
                const mobIdx = currentCamp.monsters.findIndex(m => m.id === id);
                if (mobIdx >= 0) currentCamp.monsters[mobIdx] = ent;
                window.CampaignSystem.saveCampaigns();
            } else {
                window.CampaignSystem.updateEntity(CAMP_ID, id, ent);
            }
            // Debounced sync or just save? Usually init changes happen in batch.
            // visual update
            // renderCombatList(); // Maybe don't re-render on every keystroke, let onchange handle it
        }

        // Helper for small dot indicator of conditions
        function renderConditionDot(conds) {
            if (!conds || conds.length === 0) return "";
            return `<span style="display:inline-block; width:6px; height:6px; background:#ef4444; border-radius:50%; margin-left:4px; box-shadow:0 0 5px #ef4444;" title="${conds.join(', ')}"></span>`;
        }

        function renderInspector(e) {
            const box = document.getElementById('inspector');
            if (!box) return;

            if (!e) {
                box.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Selecione um token</div>';
                return;
            }

            const hpPct = e.maxHP ? (e.currentHP / e.maxHP) * 100 : 0;
            const pePct = e.maxPE ? (e.currentPE / e.maxPE) * 100 : 0; // Assuming PE support

            // Wisteria Sidebar Content
            box.innerHTML = `
                <div style="padding:16px;">
                    <!-- HEADER -->
                    <div style="display:flex; align-items:center; gap:16px; margin-bottom:24px;">
                        <div style="width:64px; height:64px; border-radius:50%; border:2px solid var(--primary); background:url('https://ui-avatars.com/api/?name=${e.name}&background=random'); background-size:cover;"></div>
                        <div>
                            <div style="font-family:var(--font-display); font-size:1.1rem; font-weight:700; color:#fff;">${e.name}</div>
                            <div style="font-size:0.75rem; color:var(--primary-light); background:rgba(168, 85, 247, 0.1); display:inline-block; padding:2px 8px; border-radius:4px; margin-top:4px;">Lvl ${e.level || 1} ${e.race || 'Humano'}</div>
                        </div>
                    </div>

                    <!-- BARS -->
                    <div style="margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#a1a1aa; margin-bottom:4px;">
                            <span>VIDA</span>
                            <span style="color:#fff;">${e.currentHP || 0} / ${e.maxHP || 0}</span>
                        </div>
                        <div style="height:8px; background:#27272a; border-radius:4px; overflow:hidden;">
                            <div style="width:${hpPct}%; height:100%; background:linear-gradient(90deg, #16a34a, #4ade80);"></div>
                        </div>
                    </div>

                    <div style="margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#a1a1aa; margin-bottom:4px;">
                            <span>FÔLEGO / PE</span>
                            <span style="color:#fff;">${e.currentPE || 0} / ${e.maxPE || 0}</span>
                        </div>
                        <div style="height:8px; background:#27272a; border-radius:4px; overflow:hidden;">
                            <div style="width:${pePct}%; height:100%; background:#3b82f6;"></div>
                        </div>
                    </div>

                    <!-- STATS GRID -->
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1px; background:var(--border-dark); border:1px solid var(--border-dark); border-radius:8px; overflow:hidden; margin-bottom:24px;">
                        <div style="background:var(--surface-dark); padding:10px; text-align:center;">
                            <div style="font-size:0.6rem; color:#71717a; font-weight:700;">DEFESA</div>
                            <div style="font-size:1.1rem; color:#fff; font-weight:700;">${e.ac || 10}</div>
                        </div>
                        <div style="background:var(--surface-dark); padding:10px; text-align:center;">
                            <div style="font-size:0.6rem; color:#71717a; font-weight:700;">DESL.</div>
                            <div style="font-size:1.1rem; color:#fff; font-weight:700;">9m</div>
                        </div>
                        <div style="background:var(--surface-dark); padding:10px; text-align:center;">
                            <div style="font-size:0.6rem; color:#71717a; font-weight:700;">INIC.</div>
                            <div style="font-size:1.1rem; color:#fff; font-weight:700;">${e.initiative > 0 ? '+' + e.initiative : e.initiative}</div>
                        </div>
                    </div>

                    <!-- ACTIONS / CONDITIONS -->
                    <div style="margin-bottom:20px;">
                         <div style="font-size:0.75rem; color:#71717a; font-weight:700; margin-bottom:8px; text-transform:uppercase;">Condições</div>
                         <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            ${(e.conditions && e.conditions.length > 0) ? e.conditions.map(c => `<span style="background:#ef4444; color:#fff; font-size:0.7rem; padding:2px 8px; border-radius:4px;">${c}</span>`).join('') : '<span style="color:#52525b; font-size:0.8rem;">Nenhuma</span>'}
                         </div>
                    </div>

                    <div>
                         <div style="font-size:0.75rem; color:#71717a; font-weight:700; margin-bottom:8px; text-transform:uppercase;">Ações Rápidas</div>
                         <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <button style="padding:8px; background:#27272a; border:1px solid #3f3f46; color:#ef4444; border-radius:6px; font-weight:700;" onclick="modStat('${e.id || e.charId}', 'hp', -5, event)">-5 HP</button>
                            <button style="padding:8px; background:#27272a; border:1px solid #3f3f46; color:#22c55e; border-radius:6px; font-weight:700;" onclick="modStat('${e.id || e.charId}', 'hp', 5, event)">+5 HP</button>
                         </div>
                    </div>
                </div>

    <!-- ATTACKS LIST -->
    <div style="margin-top:10px;">
        <div style="font-size:0.8rem; color:#777; margin-bottom:5px;">Ataques e Ações</div>
        <div id="inspectorAttacks"></div>
    </div>

    <!-- REMOVE BUTTON -->
    <div style="margin-top:20px; padding-top:15px; border-top:1px solid #333;">
        <button class="btn btn-danger" style="width:100%;"
            onclick="removeEntityFromCombat('${e.id || e.charId}', ${e.isNPC})">
            <i data-lucide="trash-2" size="14"></i> Remover do Combate
        </button>
    </div>
    `;

            const list = document.getElementById('inspectorAttacks');
            if (isNPC && e.actions) {
                e.actions.forEach(act => {
                    const row = document.createElement('div');
                    row.className = 'acc-item';
                    row.innerHTML = `
                            <div class="acc-header"
                                onclick="performAttack('${e.name}', '${act.name}', ${act.bonus || 0}, '${act.damage}')">
                                <div style="display:flex; flex-direction:column;">
                                    <span style="font-weight:700; color:#fff;">${act.name}</span>
                                    <span style="font-size:0.75rem; color:#a855f7;">Dano: ${act.damage || "?"}</span>
                                </div>
                                <i data-lucide="dices" color="#fff"></i>
                            </div>
                            `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML = "<div style='font-size:0.8rem; color:#555;'>Ficha de jogador. Ações gerenciadas pelo jogador.</div>";
            }
            if (window.lucide) lucide.createIcons();
        }

        // --- TABS ---
        function switchRightTab(tab) {
            document.getElementById('tabStats').className = tab === 'inspector' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabBestiary').className = tab === 'bestiary' ? 'tab-btn active' : 'tab-btn';

            document.getElementById('inspector').style.display = tab === 'inspector' ? 'block' : 'none';
            document.getElementById('bestiaryContainer').style.display = tab === 'bestiary' ? 'block' : 'none';
        }


        // --- ACTIONS ---
        function selectEntity(id) {
            selectedId = id;
            // switchRightTab('inspector'); // Old logic for 'chars' view

            // New Logic: If we are in combat view, ensure Inspector Tab is open
            if (document.getElementById('view-combat').classList.contains('active')) {
                switchSidebarTab('inspector');
            }

            const ent = getEntity(id);
            if (ent) {
                renderInspector(ent);
            }
            renderCombatList();
        }

        function openCharacterSheet(charId) {
            const raw = localStorage.getItem('demonSlayerSaveSlots');
            if (!raw) return;
            const chars = JSON.parse(raw);
            const char = chars.find(c => c.id === charId);
            if (!char) return;
            localStorage.setItem('demonSlayerChar', JSON.stringify(char));
            window.open('dashboard.html', '_blank');
        }

        // --- UNIVERSAL UPDATE (PLAYERS & MONSTERS) ---
        function updateStat(id, type, val, isMax = false) {
            if (!window.CampaignSystem) return;
            const c = window.CampaignSystem.getCampaignById(CAMP_ID);
            if (!c) return;

            let target = c.players.find(p => p.charId === id);
            let isPlayer = !!target;
            if (!target) {
                target = c.monsters.find(m => m.id === id);
            }

            if (!target) return;

            // Update Value
            if (type === 'hp') {
                if (isMax) target.maxHP = Math.max(1, target.maxHP + val);
                else target.currentHP = Math.max(0, Math.min(target.maxHP, target.currentHP + val));
            } else if (type === 'pe') {
                if (isMax) target.maxPE = Math.max(0, target.maxPE + val);
                else target.currentPE = Math.max(0, Math.min(target.maxPE, target.currentPE + val));
            }

            // Save
            window.CampaignSystem.saveCampaigns(window.CampaignSystem.getCampaigns());

            // NOTIFY SERVER (Only for players)
            if (isPlayer) {
                window.CampaignSystem.sendUpdate(CAMP_ID, id, {
                    currentHP: target.currentHP,
                    maxHP: target.maxHP,
                    currentPE: target.currentPE,
                    maxPE: target.maxPE
                }, true);
            }

            // Refresh data and re-render inspector
            currentCamp = window.CampaignSystem.getCampaignById(CAMP_ID); // Re-fetch

            renderCombatList(); // Re-render logic
            if (selectedId === id || (isPlayer && selectedId === target.id)) {
                // Check if the updated entity is currently selected
                renderInspector(getEntity(id));
            }
        }

        function modStat(id, type, delta) {
            updateStat(id, type, delta, false);
        }

        function updateInit(id, val, isNPC) {
            const newVal = parseInt(val) || 0;
            window.CampaignSystem.updateEntity(CAMP_ID, id, isNPC, { initiative: newVal });
            currentCamp = window.CampaignSystem.getCampaignById(CAMP_ID);
        }

        function removeEntityFromCombat(id, isNPC) {
            if (!confirm('Remover esta entidade do combate?')) return;
            window.CampaignSystem.removeEntity(CAMP_ID, id, isNPC);
            selectedId = null;
            loadData();
            showToast('Entidade removida!');
        }

        function performAttack(attackerName, attackName, bonus, dmgStr) {
            // Roll the d20
            const d20 = Math.floor(Math.random() * 20) + 1;
            const total = d20 + bonus;
            const isCrit = d20 === 20;
            const isFail = d20 === 1;

            // Calculate damage
            let dmgVal = 0;
            try {
                // Simple parsing: NdS + M or just NdS
                const parts = dmgStr.toLowerCase().split('+');
                const dicePart = parts[0].trim().split('d');
                if (dicePart.length === 2) {
                    const n = parseInt(dicePart[0]) || 1;
                    const s = parseInt(dicePart[1]) || 6;
                    for (let i = 0; i < n; i++) dmgVal += Math.floor(Math.random() * s) + 1;
                }
                const flat = parts[1] ? parseInt(parts[1]) : 0;
                dmgVal += flat;

                if (isCrit) dmgVal *= 2;
            } catch (e) {
                console.error("Error calculating damage:", e);
                dmgVal = 0; // Fallback
            }

            // Show the premium dice overlay
            showPremiumDice(d20, total, dmgVal, attackerName, attackName, dmgStr, isCrit, isFail);

            // Log the attack
            const msg = `${attackerName} usa ${attackName}: <strong>${total}</strong> (Dano: ${dmgVal}${isCrit ? ' CRÍTICO!' : ''})`;
            window.CampaignSystem.addLog(CAMP_ID, msg);
            updateLog();
        }

        function showPremiumDice(roll, total, damage, attackerName, attackName, damageFormula, isCrit, isFail) {
            const overlay = document.getElementById('diceOverlay');
            const cube = document.getElementById('diceCube');
            const result = document.getElementById('diceResultDisplay');
            const info = document.getElementById('diceAttackInfo');

            // Set all faces to show the roll value
            document.querySelectorAll('.dice-face').forEach(face => {
                face.textContent = roll;
            });

            // Show overlay and start rolling animation
            overlay.classList.add('show');
            cube.classList.add('rolling');
            result.className = '';
            result.textContent = '';
            info.innerHTML = '';

            // After rolling animation, show result
            setTimeout(() => {
                cube.classList.remove('rolling');

                // Show result with appropriate class
                result.textContent = total;
                result.classList.add('show');
                if (isCrit) result.classList.add('crit');
                if (isFail) result.classList.add('fail');

                // Show attack info
                info.innerHTML = `
                            <div class="attacker-name">${attackerName}</div>
                            <div>${attackName} • Rolou <span
                                    style="color:${isCrit ? '#ffd60a' : isFail ? '#ef4444' : '#a855f7'}">${roll}</span>
                                + ${total - roll}</div>
                            <div class="damage-display">${damage} de dano${isCrit ? ' 🔥' : ''}</div>
                        `;
            }, 1200);
        }

        function closeDiceOverlay() {
            const overlay = document.getElementById('diceOverlay');
            const cube = document.getElementById('diceCube');
            const result = document.getElementById('diceResultDisplay');

            overlay.classList.remove('show');
            cube.classList.remove('rolling');
            result.className = '';
        }

        function updateLog() {
            if (!currentCamp || !currentCamp.log) return;
            const feed = document.getElementById('logFeed');
            if (!feed) return; // Might not exist if view changed
            feed.innerHTML = "";

            currentCamp.log.slice().reverse().forEach(l => {
                const card = document.createElement('div');
                card.className = 'wis-card';
                if (l.msg.includes("CRÍTICO")) card.style.borderColor = "var(--hp-mid)";

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="font-size:0.65rem; color:#71717a; text-transform:uppercase; font-weight:700;">LOG</span>
                        <span style="font-size:0.65rem; color:#52525b;">${l.time}</span>
                    </div>
                    <div style="font-size:0.8rem; color:#d4d4d8; line-height:1.4;">${l.msg}</div>
                `;
                feed.appendChild(card);
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- BESTIARY & HELPERS ---
        function openAddCreatureModal() {
            document.getElementById('addCreatureModal').style.display = 'flex';
            renderBestiaryTab();
        }

        function openCustomMobModal() {
            document.getElementById('customMobModal').style.display = 'flex';
            document.getElementById('cmAttacksList').innerHTML = "";
            addCustomAttackRow();
        }

        function addCustomAttackRow() {
            const div = document.createElement('div');
            div.style.cssText = "display:grid; grid-template-columns: 2fr 1fr 1fr 30px; gap:5px; margin-bottom: 5px;";
            div.innerHTML = `
                            <input type="text" placeholder="Nome Ataque" class="d-input atk-name">
                            <input type="number" placeholder="Bonus" class="d-input atk-bonus">
                            <input type="text" placeholder="Dano (ex: 1d6+2)" class="d-input atk-dmg">
                            <button class="btn btn-danger" onclick="this.parentElement.remove()">x</button>
                            `;
            document.getElementById('cmAttacksList').appendChild(div);
        }

        function saveCustomMob() {
            const name = document.getElementById('cmName').value;
            const hp = parseInt(document.getElementById('cmHP').value) || 10;
            const ac = parseInt(document.getElementById('cmAC').value) || 10;
            const cr = document.getElementById('cmCR').value || "-";

            if (!name) return alert("Nome é obrigatório!");

            const actions = [];
            const rows = document.querySelectorAll('#cmAttacksList > div');
            rows.forEach(r => {
                const n = r.querySelector('.atk-name').value;
                const b = parseInt(r.querySelector('.atk-bonus').value) || 0;
                const d = r.querySelector('.atk-dmg').value;
                if (n) actions.push({ name: n, bonus: b, damage: d, type: 'melee' });
            });

            const newMob = {
                id: 'custom_' + Date.now(),
                name: name,
                hp: hp,
                maxHP: hp,
                ac: ac,
                cr: cr,
                actions: actions,
                custom: true
            };

            const existing = JSON.parse(localStorage.getItem('customBestiary') || "[]");
            existing.push(newMob);
            localStorage.setItem('customBestiary', JSON.stringify(existing));

            document.getElementById('customMobModal').style.display = 'none';
            closeModal('addCreatureModal');
            // Directly add? Or just let user pick from list
            const addedMob = window.CampaignSystem.addMonster(CAMP_ID, newMob);

            if (addedMob) {
                // POS & INIT FIX
                const stage = document.getElementById('combatStage');
                const centerX = stage ? stage.clientWidth / 2 : 100;
                const centerY = stage ? stage.clientHeight / 2 : 100;

                const gridSize = 64;
                const finalX = Math.round((centerX - 32) / gridSize) * gridSize;
                const finalY = Math.round((centerY - 32) / gridSize) * gridSize;

                // Auto-Roll Initiative
                const init = Math.floor(Math.random() * 20) + 1; // Basic D20 for custom mob

                // Update
                window.CampaignSystem.updateEntity(CAMP_ID, addedMob.id, true, {
                    initiative: init,
                    x: finalX,
                    y: finalY
                });

                // Add to Combat Order if Active
                if (currentCamp && currentCamp.combat && currentCamp.combat.active) {
                    let entities = getAllEntities();
                    const me = entities.find(e => e.id === addedMob.id);
                    if (me) me.initiative = init;
                    entities.sort((a, b) => (b.initiative || 0) - (a.initiative || 0));
                    currentCamp.combat.order = entities.map(e => e.id || e.charId);
                    window.CampaignSystem.saveCampaigns();
                }
            }

            loadData();
            showToast('Monstro criado e adicionado!');
        }

        function renderBestiaryTab() {
            const list = document.getElementById('bestiaryList');
            if (!list) return;
            const search = document.getElementById('mobSearch').value.toLowerCase();
            list.innerHTML = "";

            // Use grid class
            list.className = 'bestiary-grid';
            list.style.display = 'grid';

            const customs = JSON.parse(localStorage.getItem('customBestiary') || "[]");
            const fullDB = [...customs, ...(window.BestiaryDB || [])];

            const filtered = fullDB.filter(m => m.name.toLowerCase().includes(search));

            filtered.forEach(m => {
                const el = document.createElement('div');
                el.className = 'mob-card';
                el.onclick = () => spawnMobById(m.id);
                el.innerHTML = `
                    <div class="mob-card-img" style="background-image: url('https://ui-avatars.com/api/?name=${m.name}&background=random')"></div>
                    <div class="mob-card-name">${m.name}</div>
                    <div class="mob-card-meta">CR ${m.cr} • HP ${m.hp}</div>
                    <button class="mob-card-add" onclick="event.stopPropagation(); spawnMobById('${m.id}')">+ Adicionar</button>
                `;
                list.appendChild(el);
            });
        }

        function spawnMobById(id) {
            const customs = JSON.parse(localStorage.getItem('customBestiary') || "[]");
            let t = customs.find(x => x.id === id);
            if (!t && window.BestiaryDB) t = window.BestiaryDB.find(x => x.id === id);

            if (t) {
                // 1. Add Monster
                const newMob = window.CampaignSystem.addMonster(CAMP_ID, t);
                if (!newMob) return;

                // 2. Default Position (Center & Grid Snapped)
                const stage = document.getElementById('combatStage');
                const centerX = stage ? stage.clientWidth / 2 : 100;
                const centerY = stage ? stage.clientHeight / 2 : 100;

                const gridSize = 64;
                const finalX = Math.round((centerX - 32) / gridSize) * gridSize;
                const finalY = Math.round((centerY - 32) / gridSize) * gridSize;

                newMob.x = finalX;
                newMob.y = finalY;

                // 3. Auto-Roll Initiative
                const dex = newMob.stats ? (newMob.stats.dex || 10) : 10;
                const mod = Math.floor((dex - 10) / 2);
                const init = Math.floor(Math.random() * 20) + 1 + mod;
                newMob.initiative = init;

                // 4. Update init & coord
                window.CampaignSystem.updateEntity(CAMP_ID, newMob.id, true, {
                    initiative: init,
                    x: finalX,
                    y: finalY
                });

                // 5. If Combat Active, Insert into Order
                if (currentCamp && currentCamp.combat && currentCamp.combat.active) {
                    let entities = getAllEntities();
                    const me = entities.find(e => e.id === newMob.id);
                    if (me) me.initiative = init;
                    entities.sort((a, b) => (b.initiative || 0) - (a.initiative || 0));
                    currentCamp.combat.order = entities.map(e => e.id || e.charId);
                    window.CampaignSystem.saveCampaigns();
                }

                closeModal('addCreatureModal');
                loadData();
                showToast(`Criatura adicionada! (Inic: ${init})`);
            }
        }

        function rollInitiativeAll() {
            // Standard logic to roll for everyone without initiative
            if (!currentCamp) return;

            // Update players? Usually players roll themselves.
            // Let's roll for all monsters at least.
            currentCamp.monsters.forEach(m => {
                const dex = 0; // simplified for now
                const roll = Math.floor(Math.random() * 20) + 1 + dex;
                window.CampaignSystem.updateEntity(CAMP_ID, m.id, true, { initiative: roll });
            });

            // Optionally roll for players if they have 0
            currentCamp.players.forEach(p => {
                if (!p.initiative) {
                    const s = p.stats || {};
                    const dex = s.dex || 0; // mod?
                    const roll = Math.floor(Math.random() * 20) + 1 + Math.floor((dex - 10) / 2);
                    window.CampaignSystem.updateEntity(CAMP_ID, p.charId, false, { initiative: roll });
                }
            });

            loadData();
            showToast('Iniciativa Rolada!');
        }

        function nextTurn() {
            if (window.CampaignSystem) {
                window.CampaignSystem.nextTurn(CAMP_ID);
                loadData();
            }
        }

        function clearCombat() {
            if (!confirm("Limpar todo o combate?")) return;
            if (window.CampaignSystem) {
                window.CampaignSystem.clearCombat(CAMP_ID);
                loadData();
            }
        }

        function renderConditionIcons(conds) {
            if (!conds || conds.length === 0) return "";
            return conds.map(c => `[${c}]`).join(" ");
        }

        // --- TOAST HELPER ---
        function showToast(msg) {
            const el = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            if (el && msgEl) {
                msgEl.innerText = msg;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3000);
            }
        }

        // --- HELPERS ---
        function getAllEntities() {
            if (!currentCamp) return [];
            const players = currentCamp.players || [];
            const monsters = currentCamp.monsters || [];
            return [
                ...players.map(p => ({ ...p, isNPC: false })),
                ...monsters.map(m => ({ ...m, isNPC: true }))
            ];
        }
        function getEntity(id) {
            return getAllEntities().find(e => (e.id === id || e.charId === id));
        }

        // --- SIDEBAR TABS LOGIC ---
        function switchSidebarTab(tab) {
            // Update Tab UI
            document.getElementById('sbTabInspector').classList.toggle('active', tab === 'inspector');
            document.getElementById('sbTabBestiary').classList.toggle('active', tab === 'bestiary');

            // Show Content
            document.getElementById('sidebarInspector').style.display = tab === 'inspector' ? 'block' : 'none';
            document.getElementById('sidebarBestiary').style.display = tab === 'bestiary' ? 'block' : 'none';

            if (tab === 'bestiary') {
                renderSidebarBestiary();
            }
        }

        function renderSidebarBestiary() {
            const list = document.getElementById('sbBestiaryList');
            if (!list) return;

            const searchInput = document.getElementById('sbMobSearch');
            const search = searchInput ? searchInput.value.toLowerCase() : "";

            list.innerHTML = "";

            const customs = JSON.parse(localStorage.getItem('customBestiary') || "[]");
            const fullDB = [...customs, ...(window.BestiaryDB || [])];

            // Sort by CR (Desafio) then Name
            fullDB.sort((a, b) => (a.cr || 0) - (b.cr || 0));

            const filtered = fullDB.filter(m => m.name.toLowerCase().includes(search));

            if (filtered.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#444; margin-top:20px;'>Nenhuma criatura encontrada.</div>";
                return;
            }

            filtered.forEach(m => {
                const item = document.createElement('div');
                // Compact "Card-Row" style
                item.style.cssText = `
                    display: flex; 
                    align-items: center; 
                    gap: 10px; 
                    padding: 8px; 
                    background: #18181b; 
                    border: 1px solid #27272a; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    transition: all 0.2s;
                `;

                // DRAG & DROP SUPPORT
                item.setAttribute('draggable', 'true');
                item.ondragstart = (e) => {
                    e.dataTransfer.setData("type", "new");
                    e.dataTransfer.setData("mobId", m.id);
                    e.dataTransfer.effectAllowed = "copy";
                };

                item.onmouseenter = () => {
                    item.style.background = "#27272a";
                    item.style.borderColor = "#a855f7";
                };
                item.onmouseleave = () => {
                    item.style.background = "#18181b";
                    item.style.borderColor = "#27272a";
                };

                // Main Click
                item.onclick = () => {
                    spawnMobById(m.id);
                };

                item.innerHTML = `
                    <div style="width:32px; height:32px; border-radius:50%; background:url('https://ui-avatars.com/api/?name=${m.name}&background=random'); background-size:cover; border:1px solid #444; flex-shrink:0;"></div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:700; color:#e4e4e7; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name}</div>
                        <div style="font-size:0.7rem; color:#71717a;">CR ${m.cr} • HP ${m.hp}</div>
                    </div>
                    <div class="add-btn" style="
                        width:24px; height:24px; 
                        border-radius:6px; 
                        background:#27272a; 
                        color:#a855f7; 
                        display:flex; align-items:center; justify-content:center;
                        font-weight:bold; font-size:1.1rem;
                        transition:0.2s;
                    " onclick="event.stopPropagation(); spawnMobById('${m.id}')">+</div>
                `;

                list.appendChild(item);
            });
        }

        // --- NEW VIEW SWITCHER ---
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
            });
            // Deselect tabs
            document.querySelectorAll('.nav-tab').forEach(el => {
                el.classList.remove('active');
            });

            // Show target
            const targetView = document.getElementById('view-' + viewName);
            if (targetView) targetView.classList.add('active');

            // Find tab logic (simple match text or index)
            // Hardcoded for simplicity
            const tabs = document.querySelectorAll('.nav-tab');
            // Note: The new sidebar tabs also have .nav-tab class, so we need to be careful with indexing if we use generic selector
            // Better to iterate or check content. 
            // The top nav bar has specific onClick logic. We can just rely on that.

            // Re-assert specific top nav tabs active state
            // Let's assume the top nav are the first 3 .nav-tab
            // This is fragile but existing code was doing it. 
            const topNavTabs = document.querySelector('.dm-nav').querySelectorAll('.nav-tab');
            if (viewName === 'combat') topNavTabs[0].classList.add('active');
            if (viewName === 'chars') topNavTabs[1].classList.add('active');
            if (viewName === 'story') topNavTabs[2].classList.add('active');

            // If switching to chars, ensure icons are rendered
            if (window.lucide) lucide.createIcons();
        }
        // --- VISUAL MAP LOGIC ---
        let isMoveMode = false;

        function toggleMoveMode() {
            if (!currentCamp || !currentCamp.combat.active) return showToast("Combate não iniciado.");
            isMoveMode = !isMoveMode;

            const stage = document.getElementById('combatStage');
            const container = document.querySelector('.wis-arena-container');
            const highlighter = document.getElementById('cursorHighlight');

            if (isMoveMode) {
                container.classList.add('move-mode');
                stage.style.cursor = "crosshair";
                highlighter.style.display = 'block';
                showToast("Selecione o destino no mapa...");
            } else {
                container.classList.remove('move-mode');
                stage.style.cursor = "default";
                highlighter.style.display = 'none';
                showToast("Modo mover cancelado.");
            }
        }

        function handleStageMouseMove(e) {
            if (!isMoveMode) return;
            const highlighter = document.getElementById('cursorHighlight');
            const rect = document.getElementById('combatStage').getBoundingClientRect();

            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // Snap Math.floor for box selection
            const gridSize = 64;
            x = Math.floor(x / gridSize) * gridSize;
            y = Math.floor(y / gridSize) * gridSize;

            highlighter.style.left = x + 'px';
            highlighter.style.top = y + 'px';
        }

        function handleStageClick(e) {
            if (!isMoveMode) return;

            // Get Active Entity
            const activeId = currentCamp.combat.order[currentCamp.combat.turnIndex];
            if (!activeId) return;

            const rect = document.getElementById('combatStage').getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // Snap Math.floor (Consistent with Highlight)
            const gridSize = 64;
            x = Math.floor(x / gridSize) * gridSize;
            y = Math.floor(y / gridSize) * gridSize;

            // Boundary
            const stage = document.getElementById('combatStage');
            if (x < 0) x = 0;
            if (y < 0) y = 0;
            if (x > stage.clientWidth - gridSize) x = stage.clientWidth - gridSize;
            if (y > stage.clientHeight - gridSize) y = stage.clientHeight - gridSize;

            // Move
            moveEntity(activeId, x, y);

            // Exit Mode
            toggleMoveMode();
            showToast("Movimento realizado!");
        }

        function handleStageDrop(e) {
            const type = e.dataTransfer.getData("type");
            const stage = document.getElementById('combatStage');
            const rect = stage.getBoundingClientRect();

            // Raw Drop Coords
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // GRID SNAPPING (64px)
            const gridSize = 64;

            if (type === "move") {
                const id = e.dataTransfer.getData("id");
                const offX = parseFloat(e.dataTransfer.getData("offsetX")) || 0;
                const offY = parseFloat(e.dataTransfer.getData("offsetY")) || 0;

                // Adjust to top-left of token based on grab offset
                let finalX = x - offX;
                let finalY = y - offY;

                // Snap to Grid
                finalX = Math.round(finalX / gridSize) * gridSize;
                finalY = Math.round(finalY / gridSize) * gridSize;

                // BOUNDARY CHECKS
                // Ensure inside stage
                if (finalX < 0) finalX = 0;
                if (finalY < 0) finalY = 0;
                if (finalX > stage.clientWidth - gridSize) finalX = stage.clientWidth - gridSize;
                if (finalY > stage.clientHeight - gridSize) finalY = stage.clientHeight - gridSize;

                moveEntity(id, finalX, finalY);
            } else if (type === "new") {
                const mobId = e.dataTransfer.getData("mobId");

                // Snap new spawns too
                x = Math.round((x - 32) / gridSize) * gridSize; // center offset approx
                y = Math.round((y - 32) / gridSize) * gridSize;

                if (x < 0) x = 0;
                if (y < 0) y = 0;
                if (x > stage.clientWidth - gridSize) x = stage.clientWidth - gridSize;
                if (y > stage.clientHeight - gridSize) y = stage.clientHeight - gridSize;

                spawnMobAt(mobId, x, y);
            }
        }

        function mouseCoordsToStage(e) {
            const rect = document.getElementById('combatStage').getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function spawnMobAt(id, x, y) {
            try {
                const Customs = JSON.parse(localStorage.getItem('customBestiary') || "[]");
                let t = Customs.find(x => x.id === id);
                if (!t && window.BestiaryDB) t = window.BestiaryDB.find(x => x.id === id);

                if (t) {
                    // Snap if not already snapped (failsafe)
                    const gridSize = 64;
                    x = Math.round(x / gridSize) * gridSize;
                    y = Math.round(y / gridSize) * gridSize;

                    // 1. Add Monster
                    const newMob = window.CampaignSystem.addMonster(CAMP_ID, t);
                    if (!newMob) return;

                    newMob.x = x;
                    newMob.y = y;

                    // 2. Auto-Roll Init
                    const dex = newMob.stats ? (newMob.stats.dex || 10) : 10;
                    const mod = Math.floor((dex - 10) / 2);
                    newMob.initiative = Math.floor(Math.random() * 20) + 1 + mod;

                    // 3. Update init & coord
                    window.CampaignSystem.updateEntity(CAMP_ID, newMob.id, true, {
                        initiative: newMob.initiative,
                        x: x,
                        y: y
                    });

                    // 4. Combat Order
                    if (currentCamp && currentCamp.combat && currentCamp.combat.active) {
                        let entities = getAllEntities();
                        const me = entities.find(e => e.id === newMob.id);
                        if (me) me.initiative = newMob.initiative;
                        entities.sort((a, b) => (b.initiative || 0) - (a.initiative || 0));
                        currentCamp.combat.order = entities.map(e => e.id || e.charId);
                        window.CampaignSystem.saveCampaigns();
                    }

                    loadData();
                    showToast(`Criatura adicionada!`);
                }
            } catch (e) { console.error(e); }
        }

        function moveEntity(id, x, y) {
            // Check if NPC or Player
            const ent = getEntity(id);
            if (!ent) return;

            window.CampaignSystem.updateEntity(CAMP_ID, id, ent.isNPC, { x, y });

            // Optimistic update
            ent.x = x;
            ent.y = y;
            renderCombatList();
        }

    </script>
</body>

</html>