<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Ca√ßador | Portal do Ca√ßador RPG</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="oni-dashboard.css">
    <link rel="stylesheet" href="nichirin_forge.css">
    <link rel="stylesheet" href="breathing.css">
    <link rel="stylesheet" href="mobile.css">
    <link rel="stylesheet" href="ultra-dice.css">

    <style>
        :root {
            --accent-primary: #00b4d8;
            --accent-glow: #0077b6;
        }

        .nav-item.active {
            border-right: 3px solid var(--accent-primary);
            background: linear-gradient(90deg, rgba(0, 180, 216, 0.1), transparent);
        }

        .sec-title {
            color: white;
            text-shadow: 0 0 10px rgba(0, 180, 216, 0.5);
        }

        #wisteria-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(circle at 50% 20%, rgba(157, 78, 221, 0.15), transparent 60%);
        }

        .petal {
            position: absolute;
            background: #e0aaff;
            border-radius: 100% 0 100% 0;
            opacity: 0.6;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translate(0, -10vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            100% {
                transform: translate(20px, 110vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Hunter Specifics */
        .lvl-btn {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
        }

        .lvl-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Basic form card fallbacks if CSS fails loading */
        .form-card {
            background: #111;
            border: 1px solid #333;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .form-use-btn {
            width: 100%;
            background: rgba(0, 180, 216, 0.2);
            border: 1px solid var(--accent-primary);
            color: white;
            padding: 5px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .form-use-btn:hover {
            background: var(--accent-primary);
        }

        .attack-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #16161a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid #333;
        }

        .atk-info {
            display: flex;
            flex-direction: column;
        }

        .atk-name {
            font-weight: bold;
            color: white;
        }

        .atk-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .roll-atk-btn {
            background: #d90429;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .del-atk-btn {
            background: #333;
            color: #888;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="wisteria-bg"></div>

    <aside class="sidebar-left">
        <div class="app-logo">
            <i data-lucide="sword" color="#00b4d8"></i>
            <span>PORTAL DO<br>CA√áADOR</span>
        </div>

        <nav class="nav-steps">
            <div class="nav-item active" id="nav-overview" onclick="showSection('overview')">
                <i data-lucide="layout-dashboard"></i>
                <span>Vis√£o Geral</span>
            </div>
            <div class="nav-item" id="nav-inventory" onclick="showSection('inventory')">
                <i data-lucide="backpack"></i>
                <span>Invent√°rio</span>
            </div>
            <div class="nav-item" id="nav-skills" onclick="showSection('skills')">
                <i data-lucide="sparkles"></i>
                <span>Habilidades</span>
            </div>
            <div class="nav-item" id="nav-attacks" onclick="showSection('attacks')">
                <i data-lucide="swords" color="#d90429"></i>
                <span>Combate</span>
            </div>
            <div class="nav-item" id="nav-forge" onclick="showSection('forge')">
                <i data-lucide="hammer" color="#ffd700"></i>
                <span style="color:#ffd700;">Forja Nichirin</span>
            </div>
            <div class="nav-item" id="nav-store" onclick="showSection('store')">
                <i data-lucide="shopping-bag" color="#e0aaff"></i>
                <span style="color:#e0aaff;">Loja Premium</span>
            </div>
        </nav>

        <div style="margin-top:auto">
            <button class="devour-btn" onclick="window.location.href='index.html'"
                style="text-align:center; border-color:#333;">
                <i data-lucide="log-out"></i> SAIR
            </button>
        </div>
    </aside>

    <main class="main-content">

        <!-- SECTION: OVERVIEW -->
        <section id="overview" class="dashboard-section active-tab">
            <div class="user-meta">
                <h2 id="charNameDisplay">Tanjiro Kamado</h2>
                <div class="user-rank" id="charRankDisplay">Mizunoto</div>
                <div id="serverStatus" title="Desconectado"
                    style="width:8px; height:8px; background:#ef4444; border-radius:50%; margin-top:5px; transition:0.3s; opacity:0.8;">
                </div>
            </div>

            <!-- Page Content -->
            <div id="page-content" style="padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%;">

                <style>
                    .avatar-circle:hover .avatar-overlay {
                        opacity: 1 !important;
                    }
                </style>

                <!-- CHARACTER HEADER -->
                <div class="char-header-panel"
                    style="background: #16161a; border: 1px solid #333; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; flex-direction: column; gap: 15px;">

                    <!-- TOP ROW: Name, Rank, Level -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="avatar-circle" onclick="changeAvatar()"
                                style="width: 60px; height: 60px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent-primary); overflow:hidden; cursor:pointer; position:relative;"
                                title="Alterar Imagem">
                                <i id="avatarIcon" data-lucide="user" size="32" color="#fff"></i>
                                <img id="avatarImg" src=""
                                    style="width:100%; height:100%; object-fit:cover; display:none;">
                                <input type="file" id="avatarUpload" accept="image/*" style="display:none;"
                                    onchange="handleAvatarUpload(this)">

                                <!-- Hover Overlay -->
                                <div class="avatar-overlay"
                                    style="position:absolute; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.2s;">
                                    <i data-lucide="camera" size="20" color="#fff"></i>
                                </div>
                            </div>
                            <div>
                                <h2 id="dispName" contenteditable="true" onblur="updateCharName(this.innerText)"
                                    style="margin: 0; font-size: 1.5rem; color: #fff; cursor: text; border-bottom: 1px dashed #444;"
                                    title="Clique para editar">Ca√ßador</h2>
                                <span id="dispRank"
                                    style="font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">MIZUNOTO</span>
                            </div>
                        </div>

                        <div style="position: relative;">
                            <div style="text-align: right; cursor: pointer;" onclick="toggleLevelSelector()">
                                <span
                                    style="display: block; font-size: 0.75rem; color: #666; font-weight: 600;">N√çVEL</span>
                                <span id="dispLevel"
                                    style="font-size: 2.5rem; color: var(--accent-primary); font-weight: 800; line-height: 1;">1</span>
                            </div>
                            <!-- Level Dropdown (Hidden) -->
                            <div id="levelSelector"
                                style="display: none; position: absolute; top: 100%; right: 0; background: #111; border: 1px solid #444; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; padding: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                                <!-- JS Generated 1-20 -->
                            </div>
                        </div>
                    </div>

                    <!-- NEW STATS ROW with COMBAT ACTIONS -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                        <div class="vital-box" onclick="editAC()"
                            style="cursor:pointer; text-align: center; padding: 10px; background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.5));"
                            title="Editar Defesa">
                            <div style="font-size: 0.65rem; color: #888; text-transform: uppercase;">Defesa</div>
                            <div id="dispAC" style="font-size: 1.4rem; font-weight: 800; color: #fff;">10</div>
                        </div>
                        <div class="vital-box" onclick="editSpeed()" style="cursor:pointer;"
                            title="Editar Deslocamento">
                            <div
                                style="text-align: center; padding: 10px; background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.5));">
                                <div style="font-size: 0.65rem; color: #888; text-transform: uppercase;">Desl.</div>
                                <div id="dispSpeed" style="font-size: 1.4rem; font-weight: 800; color: #fff;">9m</div>
                            </div>
                        </div>
                        <button id="btnBlock" onclick="combatAction('block')" class="vital-box action-btn-combat"
                            style="color:#a8dadc; cursor:pointer;" title="Bloquear (+2 CA)">
                            <i data-lucide="shield" size="20"></i>
                            <span style="font-size:0.6rem;">Bloqueio</span>
                        </button>
                        <button id="btnDodge" onclick="combatAction('dodge')" class="vital-box action-btn-combat"
                            style="color:#20bf6b; cursor:pointer;" title="Esquivar (+DES na CA)">
                            <i data-lucide="wind" size="20"></i>
                            <span style="font-size:0.6rem;">Esquiva</span>
                        </button>
                    </div>

                    <!-- VITAL: HP -->
                    <div class="vital-card minimalist red">
                        <div class="vital-header">
                            <span class="vital-title">VIDA (HP)</span>
                            <span class="vital-values" onclick="editVital('hp')" title="Editar M√°ximo"><span
                                    id="currHP">17</span> / <span id="maxHP">17</span></span>
                        </div>

                        <!-- NORMAL STATE -->
                        <div id="hpNormalState">
                            <div class="vital-bar-container">
                                <div class="vital-bar-track">
                                    <div class="vital-bar-fill hp" style="width: 100%;"></div>
                                </div>
                                <div class="vital-controls">
                                    <button onclick="changeHP('sub')" class="vital-btn minus">-</button>
                                    <button onclick="changeHP('add')" class="vital-btn plus">+</button>
                                </div>
                            </div>
                            <div class="vital-footer">
                                <input type="number" id="hpModInput" value="1" class="vital-mod-input">
                            </div>
                        </div>

                        <!-- DYING STATE (Hidden by default) -->
                        <div id="dyingStateUI"
                            style="display:none; flex-direction:column; align-items:center; gap:10px; padding:10px 0;">
                            <div
                                style="font-family:'Cinzel', serif; color:#ff595e; font-weight:bold; letter-spacing:2px; animation: pulse 1.5s infinite;">
                                MORRENDO</div>
                            <div style="display:flex; gap:15px; margin-bottom:5px;">
                                <label
                                    style="display:flex; flex-direction:column; align-items:center; gap:5px; font-size:0.7rem; color:#888;">
                                    <input type="checkbox" class="death-save"
                                        style="accent-color:#ff595e; width:18px; height:18px;">
                                    Falha 1
                                </label>
                                <label
                                    style="display:flex; flex-direction:column; align-items:center; gap:5px; font-size:0.7rem; color:#888;">
                                    <input type="checkbox" class="death-save"
                                        style="accent-color:#ff595e; width:18px; height:18px;">
                                    Falha 2
                                </label>
                                <label
                                    style="display:flex; flex-direction:column; align-items:center; gap:5px; font-size:0.7rem; color:#888;">
                                    <input type="checkbox" class="death-save"
                                        style="accent-color:#ff595e; width:18px; height:18px;">
                                    Falha 3
                                </label>
                            </div>
                            <button onclick="revivePlayer()"
                                style="background:#ff595e; color:white; border:none; padding:8px 24px; border-radius:6px; font-weight:bold; cursor:pointer; box-shadow:0 0 15px rgba(255, 89, 94, 0.4);">
                                REVIVER (1 PV)
                            </button>
                        </div>
                    </div>

                    <!-- VITAL: PE -->
                    <div class="vital-card minimalist blue">
                        <div class="vital-header">
                            <span class="vital-title">ENERGIA (PE)</span>
                            <span class="vital-values" onclick="editVital('pe')" title="Editar M√°ximo"><span
                                    id="currPE">1</span> / <span id="maxPE">1</span></span>
                        </div>
                        <div class="vital-bar-container">
                            <div class="vital-bar-track">
                                <div class="vital-bar-fill pe" style="width: 100%;"></div>
                            </div>
                            <div class="vital-controls">
                                <button onclick="changePE('sub')" class="vital-btn minus">-</button>
                                <button onclick="changePE('add')" class="vital-btn plus">+</button>
                            </div>
                        </div>
                        <div class="vital-footer">
                            <input type="number" id="peModInput" value="1" class="vital-mod-input">
                        </div>
                    </div>

                    <!-- OLD HP SECTION (REMOVED) -->
                    <!-- OLD PE SECTION (REMOVED) -->


                    <!-- PROFICIENCIES ROW (NEW) -->
                    <div id="proficiencies-container"
                        style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; border: 1px solid rgba(255,255,255,0.05);">
                        <span
                            style="font-size: 0.75rem; color: #666; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">Profici√™ncias
                            & Talentos</span>
                        <div id="profList"
                            style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.85rem; color: #ccc;">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- MOBILE SALARY (Hidden on Desktop) -->
                    <div id="mobileSalaryDisplay" class="mobile-only-salary"
                        style="display:none; order:10; margin-top:10px; background:rgba(255,215,0,0.1); border:1px solid #ffd700; padding:10px; border-radius:8px; align-items:center; justify-content:center; gap:8px; color:#ffd700; font-weight:bold;">
                        <!-- JS Injected -->
                    </div>
                </div>

                <div class="attributes-grid" id="attrGrid"></div>
        </section>

        <!-- SECTION: INVENTORY -->
        <section id="inventory" class="dashboard-section">
            <div class="section-header">
                <span class="sec-title">Invent√°rio</span>
                <i data-lucide="backpack" color="#00b4d8"></i>
            </div>

            <div class="inventory-controls">
                <button class="devour-btn" style="width:auto; margin:0; border-color:#00b4d8; color:#00b4d8;"
                    onclick="openItemModal()">
                    <i data-lucide="plus"></i> Adicionar Item
                </button>
            </div>

            <div class="inv-workspace">
                <div class="inv-list-container" id="inventoryGrid"></div>
            </div>
        </section>

        <!-- SECTION: SKILLS (Combined Breathing & Background) -->
        <section id="skills" class="dashboard-section">
            <div class="section-header">
                <span class="sec-title">Habilidades & Poderes</span>
                <i data-lucide="sparkles" color="#00b4d8"></i>
            </div>

            <!-- SKILL TABS -->
            <div class="skill-tabs-nav"
                style="display:flex; gap:20px; border-bottom:1px solid #333; margin-bottom:20px; padding-bottom:10px;">
                <div id="tab-btn-breathing" class="skill-tab-btn active" onclick="switchSkillTab('breathing')"
                    style="cursor:pointer; padding:5px 10px; color:#fff; border-bottom:2px solid var(--accent-primary); font-weight:bold;">
                    Respira√ß√£o
                </div>
                <div id="tab-btn-features" class="skill-tab-btn" onclick="switchSkillTab('features')"
                    style="cursor:pointer; padding:5px 10px; color:#666; font-weight:bold;">
                    Habilidades
                </div>
                <div id="tab-btn-background" class="skill-tab-btn" onclick="switchSkillTab('background')"
                    style="cursor:pointer; padding:5px 10px; color:#666; font-weight:bold;">
                    Antecedente
                </div>
            </div>

            <!-- TAB 1: BREATHING -->
            <div id="tab-breathing" class="skill-tab-content">
                <div id="breathingLocked" style="text-align:center; padding:3rem; color:#666;">
                    <i data-lucide="lock" size="48" style="margin-bottom:1rem; opacity:0.5;"></i>
                    <p>As T√©cnicas de Respira√ß√£o s√£o desbloqueadas no <strong>N√≠vel 3</strong>.</p>
                </div>

                <div id="breathingUnlocked" style="display:none;">
                    <div class="breathing-header" style="margin-bottom:10px;">
                        <h2 id="breathStyleName" style="color:var(--accent-primary); margin:0;">Respira√ß√£o da √Ågua</h2>
                        <div style="font-size:0.9rem; color:#888;">Pontos de Energia: <span id="peDisplay">0 / 0</span>
                        </div>
                    </div>
                    <div class="forms-grid" id="formsGrid"
                        style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">
                        <!-- JS Injected Forms -->
                    </div>
                </div>
            </div>

            <!-- TAB 2: FEATURES (NEW) -->
            <div id="tab-features" class="skill-tab-content" style="display:none;">
                <div id="featuresContent"
                    style="animation: fadeIn 0.5s; display:flex; flex-direction:column; gap:10px;">
                    <!-- JS Injected Features -->
                </div>
            </div>

            <!-- TAB 3: BACKGROUND -->
            <div id="tab-background" class="skill-tab-content" style="display:none;">
                <div id="backgroundContent" style="animation: fadeIn 0.5s;">
                    <!-- JS Injected Background Info -->
                </div>
            </div>
        </section>

        <!-- SECTION: ATTACKS -->
        <section id="attacks" class="dashboard-section">
            <div class="section-header">
                <span class="sec-title">Ataques & Combate</span>
                <i data-lucide="swords" color="#d90429"></i>
            </div>
            <div class="atk-controls" style="margin-bottom:1rem;">
                <button class="devour-btn" style="width:auto; margin:0;" onclick="openAttackModal()">+ Novo
                    Ataque</button>
            </div>
            <div id="attacksList"></div>
        </section>

        <!-- SECTION: FORGE -->
        <section id="forge" class="dashboard-section">
            <div class="section-header">
                <span class="sec-title" style="color:#ffd700">Forja Nichirin</span>
            </div>
            <div class="nichirin-wrapper">
                <div class="heat-glow"></div>

                <!-- NEW: Sword Visualization with Layers -->
                <div class="sword-stage">
                    <div class="sword-container" id="swordContainer">
                        <!-- Blade Group -->
                        <div class="blade-group">
                            <div class="blade" id="swordBlade">
                                <div class="blade-color-layer" id="swordColorLayer"></div>
                                <div class="hamon"></div>
                                <div class="engraving" id="bladeEngraving"></div>
                            </div>
                            <div class="habaki"></div>
                        </div>
                        <!-- Guard -->
                        <div class="tsuba" id="swordTsuba"></div>
                        <!-- Handle -->
                        <div class="tsuka" id="swordTsuka">
                            <div class="tsuka-ito"></div> <!-- Wrap -->
                            <div class="samegawa"></div> <!-- Skin under wrap -->
                        </div>
                        <div class="kashira"></div> <!-- Buttcap -->
                    </div>
                </div>

                <!-- NEW: Forge UI Wrapper -->
                <div class="forge-ui" id="forgeUI">

                    <!-- STEP 1: Mode Selection -->
                    <div id="forgeModeSelect" class="forge-step active">
                        <h3 style="color:white; margin-bottom:1rem;">Escolha seu Caminho</h3>
                        <div class="mode-cards">
                            <div class="mode-card" onclick="selectForgeMode('destiny')">
                                <i data-lucide="sparkles" size="32" color="#ffd700"></i>
                                <h4>Destino</h4>
                                <p>Responda ao chamado da sua alma. A espada escolhe voc√™.</p>
                            </div>
                            <div class="mode-card" onclick="selectForgeMode('blacksmith')">
                                <i data-lucide="hammer" size="32" color="#d90429"></i>
                                <h4>Ferreiro</h4>
                                <p>Forje cada detalhe com suas pr√≥prias m√£os.</p>
                            </div>
                        </div>
                    </div>

                    <!-- QUIZ UI -->
                    <div id="forgeQuizUI"></div>

                    <!-- HAMMERING UI -->
                    <div id="forgeHammerUI"></div>

                    <!-- RESULT UI -->
                    <div id="forgeResultUI"></div>
                </div>
            </div>
        </section>

        <!-- SECTION: STORE (PREMIUM) -->
        <section id="store" class="dashboard-section">
            <div class="section-header">
                <span class="sec-title" style="color:#e0aaff">Loja Premium</span>
                <i data-lucide="shopping-bag" color="#e0aaff"></i>
            </div>

            <div
                style="background:linear-gradient(90deg, #240046, #3c096c); padding:2rem; border-radius:12px; margin-bottom:2rem; text-align:center; position:relative; overflow:hidden;">
                <div style="position:relative; z-index:2;">
                    <h2 style="font-family:'Cinzel', serif; font-size:2rem; margin:0 0 10px 0; color:#e0aaff;">Passe
                        Hashira</h2>
                    <p style="color:#c77dff; max-width:600px; margin:0 auto;">Desbloqueie estilos de respira√ß√£o
                        lend√°rios, personaliza√ß√£o avan√ßada de Nichirin e suporte o desenvolvimento do sistema.</p>
                    <button class="forge-btn"
                        style="margin-top:20px; background:#e0aaff; color:#10002b; font-weight:800;"
                        onclick="buyPremium()">ADQUIRIR AGORA</button>
                </div>
                <!-- Decor -->
                <i data-lucide="crown" size="120"
                    style="position:absolute; top:-20px; right:-20px; opacity:0.1; color:#fff;"></i>
            </div>

            <div class="store-grid" id="storeGrid"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <!-- JS Populated -->
            </div>
        </section>

    </main>

    <!-- RIGHT SIDEBAR: HUNTER ORGANIZATION -->
    <aside class="sidebar-right">
        <div class="sidebar-header">
            <span class="sec-title" style="font-size:1rem; color:#ffd700;">Organiza√ß√£o dos Ca√ßadores</span>
            <i data-lucide="shield" color="#ffd700" size="18" id="hunterShieldIcon" style="cursor:pointer;"
                onclick="handleShieldClick()"></i>
        </div>

        <div class="hunter-org-panel" style="display:flex; flex-direction:column; gap:20px; padding-top:10px;">

            <!-- RANK CARD -->
            <div
                style="background:rgba(255, 255, 255, 0.03); border:1px solid rgba(255, 255, 255, 0.1); padding:1rem; border-radius:8px; text-align:center;">
                <div
                    style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                    Rank Atual</div>
                <div id="sideRankDisplay"
                    style="font-family:'Cinzel', serif; font-size:1.5rem; color:var(--accent-primary); font-weight:bold;">
                    Mizunoto</div>
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">Espadachim N√≠vel <span
                        id="sideLevelDisplay">1</span></div>
            </div>

            <!-- SALARY CARD -->
            <div
                style="background:rgba(255, 255, 255, 0.03); border:1px solid rgba(255, 255, 255, 0.1); padding:1rem; border-radius:8px; text-align:center;">
                <div
                    style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                    Sal√°rio (Mensal)</div>
                <div
                    style="font-size:1.4rem; color:#ffd700; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:5px;">
                    <i data-lucide="coins" size="20"></i> <span id="salaryDisplay">20.000</span>
                </div>
                <div style="font-size:0.75rem; color:#666; margin-top:5px;">Kan</div>
            </div>

            <!-- MISSION LEVEL -->
            <div
                style="background:rgba(255, 255, 255, 0.03); border:1px solid rgba(255, 255, 255, 0.1); padding:1rem; border-radius:8px; text-align:center;">
                <div
                    style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                    N√≠vel de Miss√£o</div>
                <div id="missionLevelDisplay" style="font-size:1.2rem; color:#ff595e; font-weight:bold;">Rank Inferior
                </div>
                <div style="font-size:0.8rem; color:#aaa; margin-top:5px; line-height:1.4;">
                    Miss√µes de exterm√≠nio em grupo e patrulhas locais.
                </div>
            </div>

            <button onclick="completeMission()"
                style="background:rgba(0, 180, 216, 0.1); border:1px solid var(--accent-primary); color:var(--accent-primary); padding:10px; border-radius:6px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                <i data-lucide="check-circle" size="18"></i> Miss√£o Realizada
            </button>

            <!-- QUOTE / FLAVOR (TRIGGER) -->
            <div id="sideQuoteTrigger" onclick="handleQuoteClick()"
                style="border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; margin-top:auto; font-style:italic; color:#555; text-align:center; font-size:0.85rem; cursor:pointer; user-select:none; transition: color 0.3s;">
                "Dedique-se. A humanidade depende da sua l√¢mina."
            </div>

        </div>
    </aside>

    <!-- HASHIRA ASCENSION MODAL -->
    <div id="hashiraModal" class="modal-overlay"
        style="display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.95); z-index:9999;">
        <div class="hashira-card"
            style="text-align:center; max-width:600px; padding:40px; border:2px solid #ffd700; background:linear-gradient(135deg, #1a0b00 0%, #000 100%); box-shadow:0 0 50px rgba(255, 215, 0, 0.3); border-radius:12px; position:relative; overflow:hidden;">
            <!-- Decor -->
            <div style="position:absolute; top:0; left:0; width:100%; height:5px; background:#ffd700;"></div>
            <div style="position:absolute; bottom:0; left:0; width:100%; height:5px; background:#ffd700;"></div>

            <i data-lucide="crown" size="64" color="#ffd700"
                style="margin-bottom:20px; filter:drop-shadow(0 0 10px #ffd700);"></i>

            <h1
                style="font-family:'Cinzel', serif; font-size:2.5rem; color:#ffd700; margin:0 0 10px 0; letter-spacing:2px; text-transform:uppercase;">
                Ascens√£o Hashira</h1>
            <p style="color:#aaa; margin-bottom:30px; line-height:1.6; font-size:1.1rem;">
                Voc√™ provou seu valor atrav√©s de sangue e a√ßo.<br>
                Sua l√¢mina n√£o serve apenas a si mesma, mas √† humanidade inteira.<br><br>
                <span style="color:#fff; font-weight:bold;">Voc√™ aceita o fardo de ser um Pilar?</span>
            </p>

            <div style="display:flex; justify-content:center; gap:20px;">
                <button onclick="confirmHashiraAscension()"
                    style="background:linear-gradient(45deg, #ffd700, #ffaa00); border:none; padding:15px 40px; color:#000; font-weight:900; font-size:1.2rem; cursor:pointer; clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%); transition: transform 0.2s;">
                    ACEITAR DESTINO
                </button>
                <button onclick="closeHashiraModal()"
                    style="background:transparent; border:1px solid #444; padding:15px 30px; color:#888; font-weight:bold; cursor:pointer; transition: color 0.2s;">
                    AINDA N√ÉO
                </button>
            </div>
        </div>
    </div>

    <style>
        /* LAYOUT ADJUSTMENTS */
        body {
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        .sidebar-left {
            width: 250px;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.6);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        .main-content {
            flex: 1;
            padding: 20px 40px;
            /* Reduced side padding */
            overflow-y: auto;
            position: relative;
            z-index: 5;
        }

        .sidebar-right {
            width: 300px;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            height: 100vh;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .feat-list-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-right: 5px;
            /* Scrollbar space */
        }

        /* Scrollbar styling */
        .feat-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .feat-list-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .feat-list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    <div id="toastContainer"
        style="position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px;">
    </div>

    <!-- ATTACK MODAL -->
    <div id="attackModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div class="modal-content"
            style="background:#141418; padding:2rem; width:450px; border:1px solid #333; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.8);">

            <h2
                style="margin-top:0; font-family:'Cinzel', serif; color:white; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:20px;">
                <i data-lucide="sword" style="margin-right:10px; color:#d90429;"></i>Criar Ataque
            </h2>

            <div style="margin-bottom:20px;">
                <label
                    style="display:block; color:#888; margin-bottom:8px; font-size:0.8rem; text-transform:uppercase;">Predefini√ß√µes
                    R√°pidas</label>
                <div style="display:flex; gap:10px;">
                    <button onclick="setAttackPreset('katana')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">
                        üó°Ô∏è Katana
                    </button>
                    <button onclick="setAttackPreset('unarmed')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">
                        üëä Punhos
                    </button>
                    <button onclick="setAttackPreset('bow')" class="atk-preset-btn"
                        style="flex:1; padding:8px; background:#222; border:1px solid #333; color:#ccc; border-radius:6px; cursor:pointer; font-size:0.85rem;">
                        üèπ Arco
                    </button>
                </div>
            </div>

            <div style="margin-bottom:15px;">
                <label style="color:#aaa; display:block; margin-bottom:5px;">Nome do Ataque</label>
                <input type="text" id="atkNameInput" class="ds-input" placeholder="Ex: Corte Vertical"
                    style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px;">
            </div>

            <!-- ROW 2: Base Damage & Stats -->
            <div style="display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Dano Base*</label>
                    <input type="text" id="atkDmgInput" class="ds-input" placeholder="Ex: 1d8+2"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Cr√≠tico*</label>
                    <input type="number" id="atkCritInput" class="ds-input" value="20"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Mult.*</label>
                    <input type="number" id="atkMultInput" class="ds-input" value="2"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px;">
                </div>
            </div>

            <!-- ROW 3: Bonus, Type, Range -->
            <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Atk B√¥nus</label>
                    <input type="number" id="atkBonusInput" class="ds-input" value="0"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px;">
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Tipo Base</label>
                    <select id="atkTypeInput" class="ds-input"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; cursor:pointer;">
                        <option value="" disabled selected>Selecione...</option>
                        <optgroup label="F√≠sicos Padr√£o">
                            <option value="Cortante">Cortante</option>
                            <option value="Concuss√£o">Concuss√£o</option>
                            <option value="Perfurante">Perfurante</option>
                            <option value="Bal√≠stico">Bal√≠stico</option>
                        </optgroup>
                        <optgroup label="Elementais & Especiais">
                            <option value="√Åcido">√Åcido</option>
                            <option value="El√©trico">El√©trico</option>
                            <option value="Fogo">Fogo</option>
                            <option value="Frio">Frio</option>
                            <option value="Necr√≥tico">Necr√≥tico</option>
                            <option value="Ps√≠quico">Ps√≠quico</option>
                            <option value="Primordial">Primordial</option>
                            <option value="Trovejante">Trovejante</option>
                            <option value="Veneno">Veneno</option>
                            <option value="Radiante">Radiante</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label style="color:#aaa; display:block; margin-bottom:5px;">Alcance</label>
                    <select id="atkRangeInput" class="ds-input"
                        style="width:100%; padding:10px; background:#0a0a0a; border:1px solid #333; color:white; border-radius:6px; cursor:pointer;">
                        <option value="" disabled selected>Selecione...</option>
                        <option value="Toque">Toque</option>
                        <option value="Curto">Curto (1.5m)</option>
                        <option value="M√©dio">M√©dio (9m)</option>
                        <option value="Longo">Longo (30m+)</option>
                    </select>
                </div>
            </div>

            <!-- EXTRA DAMAGE SECTION -->
            <div style="margin-bottom:15px; border-top:1px solid #222; padding-top:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="color:#fff; font-weight:bold;">Dano Extra:</label>
                    <button type="button" onclick="addExtraDmgRow()"
                        style="background:#702963; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; font-weight:bold;">
                        Adicionar
                    </button>
                </div>
                <div id="extraDmgContainer" style="display:flex; flex-direction:column; gap:10px;">
                    <!-- Rows injected here -->
                </div>
            </div>

            <div
                style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; border-top:1px solid #222; padding-top:20px;">
                <button onclick="closeAttackModal()"
                    style="padding:10px 20px; background:transparent; color:#888; border:1px solid #333; border-radius:6px; cursor:pointer; font-weight:bold;">Cancelar</button>
                <button id="btnConfirmAttack" onclick="confirmAddAttack()"
                    style="padding:10px 20px; background:var(--accent-primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow:0 0 15px rgba(0, 180, 216, 0.2);">CRIAR
                    ATAQUE</button>
            </div>
        </div>
    </div>

    <!-- ITEM MODAL -->
    <div id="itemModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div class="modal-content"
            style="background:#111; padding:2rem; width:600px; max-height:80vh; overflow:auto; border:1px solid #333; border-radius:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                <h2>Adicionar Item</h2>
                <span style="cursor:pointer;" onclick="closeItemModal()">X</span>
            </div>
            <input type="text" class="ds-input" id="itemSearch" placeholder="Buscar..."
                style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #333; color:white;">
            <div id="pickerGrid"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px;"></div>
        </div>
    </div>

    <!-- COMBAT RESULT MODAL -->
    <div id="combatResultModal" style="display:none;" class="modal-overlay">
        <div class="combat-modal-content">
            <div class="combat-header">
                <h2 id="combatTitle" style="margin:0; font-family:'Cinzel', serif;">T√©cnica Executada</h2>
                <div class="close-combat" onclick="closeCombatModal()" style="cursor:pointer;">
                    <i data-lucide="x"></i>
                </div>
            </div>
            <div class="combat-body" style="text-align:center; padding:2rem;">
                <div class="combat-roll-container">
                    <span id="combatRollTotal" class="roll-total"
                        style="font-size:4rem; font-weight:800; color:#fff; text-shadow:0 0 20px rgba(255,255,255,0.5);">0</span>
                    <div id="combatRollExpr" class="roll-expr" style="font-size:1.2rem; color:#888; margin-top:5px;">...
                    </div>
                </div>
                <div class="combat-details" id="combatDetails" style="margin-top:20px; font-size:1.1rem; color:#aaa;">
                </div>
            </div>
        </div>
    </div>

    <!-- GEAR SELECTION MODAL -->
    <div id="gearSelectionModal" class="modal-overlay"
        style="display:none; align-items:center; justify-content:center; z-index:2000;">
        <div class="combat-modal-content"
            style="max-width:600px; text-align:center; background: #1a1a20; border: 1px solid #333; border-radius: 12px; padding: 2rem;">
            <h2 style="font-family:'Cinzel', serif; color:var(--accent-primary); margin-bottom:1rem;">Equipamento
                Inicial</h2>
            <p style="color:#aaa; margin-bottom:2rem;">Como um ca√ßador rec√©m-formado, voc√™ recebe o equipamento padr√£o
                da sua respira√ß√£o.</p>

            <div id="gearOptionsContainer" style="text-align:left; display:grid; gap:20px;">
                <!-- Injected via JS -->
            </div>

            <button onclick="confirmStartingGear()" class="confirm-btn"
                style="margin-top:2rem; width:100%; justify-content:center;">Receber Equipamento</button>
        </div>
    </div>

    <!-- BREATHING DISCOVERY MODAL -->
    <div id="discoveryModal" class="modal-overlay" style="display:none; z-index:9999; background:rgba(0,0,0,0.95);">
        <!-- SELECTION SCREEN -->
        <div id="discoverySelection" class="combat-modal-content"
            style="max-width:900px; width:90%; background:transparent; border:none; box-shadow:none;">
            <div style="text-align:center; margin-bottom:3rem;">
                <h2
                    style="font-family:'Cinzel', serif; font-size:2.5rem; color:#fff; text-shadow:0 0 20px rgba(255,255,255,0.3); margin-bottom:10px;">
                    Descobrir Novo Estilo</h2>
                <p style="color:#aaa; font-size:1.1rem; max-width:600px; margin:0 auto;">A medita√ß√£o profunda revela
                    novos caminhos. Escolha qual t√©cnica sua alma deseja manifestar.</p>
            </div>

            <div id="stylesGrid"
                style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:25px; justify-content:center;">
                <!-- Generated by JS -->
            </div>

            <button onclick="document.getElementById('discoveryModal').style.display='none'"
                style="margin-top:2rem; background:transparent; border:1px solid #444; color:#888; padding:10px 30px; border-radius:30px; cursor:pointer; font-weight:bold; transition:all 0.3s; display:block; margin-left:auto; margin-right:auto;">
                CANCELAR MEDITA√á√ÉO
            </button>
        </div>

        <!-- ANIMATION OVERLAY -->
        <div id="discoveryAnimation"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; flex-direction:column; overflow:hidden;">
            <!-- Dynamic Background -->
            <div id="da-bg"
                style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; transition:opacity 1s ease;">
            </div>

            <!-- Particles Container -->
            <div id="da-particles" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>

            <!-- Central Icon -->
            <div id="da-icon-container"
                style="position:relative; z-index:10; opacity:0; transform:scale(0.5); transition:all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                <div id="da-icon-ring"
                    style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:300px; height:300px; border:2px solid rgba(255,255,255,0.1); border-radius:50%;">
                </div>
                <div id="da-icon-glow"
                    style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:100px; height:100px; border-radius:50%; filter:blur(40px);">
                </div>
                <i id="da-icon" data-lucide="zap"
                    style="width:120px; height:120px; color:#fff; position:relative; z-index:2;"></i>
            </div>

            <!-- Text Reveal -->
            <h1 id="da-title"
                style="position:relative; z-index:10; font-family:'Cinzel', serif; font-size:4rem; color:#fff; text-shadow:0 0 30px rgba(0,0,0,1); margin-top:2rem; opacity:0; transform:translateY(20px); transition:all 0.8s ease; letter-spacing:5px;">
                RESPIRA√á√ÉO DO TROV√ÉO
            </h1>
            <div id="da-subtitle"
                style="position:relative; z-index:10; font-size:1.2rem; color:#ccc; letter-spacing:3px; text-transform:uppercase; margin-top:10px; opacity:0; transition:opacity 1s ease 0.5s;">
                T√©cnica Desbloqueada
            </div>

            <!-- Continue Button -->
            <button id="da-btn" onclick="finishDiscovery()"
                style="position:relative; z-index:10; margin-top:3rem; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:12px 40px; border-radius:30px; font-weight:bold; cursor:pointer; opacity:0; transition:all 0.3s ease; backdrop-filter:blur(5px);">
                CONTINUAR
            </button>
        </div>
    </div>

    <!-- STYLES FOR DISCOVERY -->
    <style>
        .discovery-card {
            background: rgba(20, 20, 25, 0.95);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .discovery-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .discovery-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #555;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .discovery-card:hover::before {
            opacity: 1;
        }

        .discovery-card .icon-wrapper {
            background: rgba(255, 255, 255, 0.03);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px auto;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .discovery-card:hover .icon-wrapper {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1) rotate(5deg);
        }

        /* Ability Cards */
        .ability-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ability-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .ability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .ability-name {
            font-weight: 700;
            color: #fff;
            font-size: 0.95rem;
        }

        .ability-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            color: #111;
            letter-spacing: 0.5px;
        }

        .ability-summary {
            color: #aaa;
            font-size: 0.85rem;
            line-height: 1.4;
            display: block;
        }

        .ability-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #ccc;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ability-card.expanded .ability-details {
            display: block;
            animation: fadeIn 0.3s;
        }

        .ability-card.expanded .ability-summary {
            display: none;
        }

        /* CARD STYLES */
        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        .anim-pulse {
            animation: pulse-ring 2s infinite;
        }

        @keyframes shake-violent {

            0%,
            100% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-5px, -5px);
            }

            20% {
                transform: translate(5px, 5px);
            }

            30% {
                transform: translate(-5px, 5px);
            }

            40% {
                transform: translate(5px, -5px);
            }

            50% {
                transform: translate(2px, 2px);
            }
        }

        .anim-shake {
            animation: shake-violent 0.5s ease-in-out;
        }

        @keyframes float-up {
            0% {
                transform: translateY(0);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .discovery-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            animation: float-up 2s linear forwards;
        }
    </style>

    <!-- SCRIPTS ORDER IS CRITICAL -->
    <script src="items_db.js"></script>
    <script src="inventory_modules.js"></script>
    <script src="hunters_algorithm.js"></script>
    <script src="breathing_class_db.js"></script> <!-- New Class DB -->
    <script src="breathing_db.js"></script> <!-- Water Breathing -->
    <script src="backgrounds_db.js"></script> <!-- Backgrounds DB -->
    <script src="skills_system.js"></script> <!-- Skills System -->
    <script src="nichirin_system.js"></script>
    <script src="premium_system.js"></script>
    <script src="campaign.js"></script> <!-- Added Campaign System -->
    <script src="dashboard.js"></script>

    <script>
        // Init logic wrapper
        function showSection(id) {
            document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active-tab'));
            const t = document.getElementById(id);
            if (t) t.classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const n = document.getElementById('nav-' + id);
            if (n) n.classList.add('active');
            if (window.lucide) lucide.createIcons();
        }

        function initWisteria() {
            const c = document.getElementById('wisteria-bg');
            if (!c) return;
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'petal';
                p.style.left = Math.random() * 100 + '%';
                p.style.width = (Math.random() * 5 + 5) + 'px';
                p.style.height = p.style.width;
                p.style.animationDuration = (Math.random() * 5 + 5) + 's';
                p.style.animationDelay = (Math.random() * 5) + 's';
                c.appendChild(p);
            }
        }

        window.onload = function () {
            initDashboard(); // <--- CRITICAL FIX: Trigger Dashboard Load
            initWisteria();
            if (window.lucide) lucide.createIcons();

            // Connect to WebSocket (Auto-detect campaign)
            // Ideally we should know which campaign the player is in.
            // For now, we connect to ALL campaigns they are part of, or pass a flag.
            // Simplified: Connect using 'demo' or try to find active campaign from localStorage.

            // For this specific request, we just need to connect. 
            // We'll pass 'global' or similar if we don't have ID, but updateSync needs ID.
            // Let's rely on CampaignSystem to handle multiple? No, CampaignSystem is simple client.

            // Try to find if this char is in a campaign
            const char = JSON.parse(localStorage.getItem('demonSlayerChar') || '{}');
            if (char.id) {
                // We need to know the CampaignID. Storage approach:
                const campaigns = window.CampaignSystem.getCampaigns();
                const myCamp = campaigns.find(c => c.players.find(p => p.charId === char.id));

                if (myCamp) {
                    console.log('Connecting to Campaign:', myCamp.name);
                    window.CampaignSystem.connectServer(myCamp.id, char.id);
                }
            }

            // Listen for Sync Events
            window.addEventListener('character-synced', (e) => {
                const newData = e.detail;
                // Refresh UI (HP Bars, Values)
                if (window.updateBars) window.updateBars();
                if (window.renderAttributes) window.renderAttributes();
                if (window.renderConditions) window.renderConditions();

                // Specific updates if functions exist
                document.querySelectorAll('.hp-text').forEach(el => el.innerText = `${newData.currentHP}/${newData.maxHP}`);
                document.querySelectorAll('.pe-text').forEach(el => el.innerText = `${newData.currentPE}/${newData.maxPE}`);
            });
        };
        window.addEventListener('server-status', (e) => {
            const el = document.getElementById('serverStatus');
            if (e.detail === 'online') {
                el.style.background = '#22c55e';
                el.style.boxShadow = '0 0 10px #22c55e';
                el.title = "Online";
            } else {
                el.style.background = '#ef4444';
                el.style.boxShadow = 'none';
                el.title = "Offline";
            }
        });
    </script>
    <!-- DICE OVERLAY FOR LEVEL UP -->
    <div id="diceOverlay" onclick="closeDiceOverlay()">
        <div class="dice-scene">
            <div class="dice-d20" id="diceElement">
                <div class="dice-face">20</div>
            </div>
            <div class="dice-glow"></div>
        </div>
        <div id="diceResultDisplay">20</div>
        <div class="dice-attack-info" id="diceInfoPanel" style="display:none; opacity:0; transition: opacity 0.5s;">
            <div class="attacker-name" id="diceInfoTitle">SUBINDO DE N√çVEL</div>
            <div class="breakdown" id="diceInfoDesc">Vida M√°xima</div>
            <div class="damage-display" id="diceInfoValue">+10</div>
        </div>
        <div class="dice-close-hint">Clique para continuar</div>
    </div>
    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="bottom-nav-bar" style="display:none;">
        <div class="nav-item-mobile active" onclick="showSection('overview'); activateMobile(this)">
            <i data-lucide="layout-dashboard"></i>
            <span>In√≠cio</span>
        </div>
        <div class="nav-item-mobile" onclick="showSection('inventory'); activateMobile(this)">
            <i data-lucide="scroll-text"></i>
            <span>Ficha</span>
        </div>
        <div class="nav-item-mobile" onclick="showSection('attacks'); activateMobile(this)">
            <i data-lucide="swords"></i>
            <span>Combate</span>
        </div>
        <div class="nav-item-mobile" onclick="window.location.href='campaign-hub.html'">
            <i data-lucide="map"></i>
            <span>Mapa</span>
        </div>
        <div class="nav-item-mobile" onclick="toggleMobileMenu()">
            <i data-lucide="menu"></i>
            <span>Menu</span>
        </div>
    </nav>
    <style>
        @media (max-width: 768px) {

            .sidebar-left,
            .sidebar-right {
                display: none !important;
            }

            .bottom-nav-bar {
                display: flex !important;
                position: fixed;
                bottom: 0px;
                left: 0;
                width: 100%;
                height: 70px;
                background: rgba(15, 15, 19, 0.85);
                backdrop-filter: blur(12px);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                justify-content: space-around;
                align-items: center;
                z-index: 10000;
                padding-bottom: 5px;
                /* Safe area */
            }

            .nav-item-mobile {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: #888;
                font-size: 0.7rem;
                gap: 4px;
                cursor: pointer;
                flex: 1;
                transition: all 0.3s;
            }

            .nav-item-mobile.active {
                color: var(--accent-primary);
                transform: translateY(-2px);
            }

            .nav-item-mobile.active svg {
                stroke: var(--accent-primary);
                filter: drop-shadow(0 0 8px var(--accent-primary));
            }

            .main-content {
                margin-left: 0 !important;
                padding: 10px !important;
                /* Reduced padding */
                padding-bottom: 90px !important;
            }

            /* --- RESPONSIVE OVERVIEW GRID --- */

            /* 1. Char Header Reordering */
            .char-header-panel {
                display: flex !important;
                flex-direction: column !important;
                gap: 15px !important;
                padding: 1rem !important;
            }

            /* Move Vitals to Top */
            .vital-card.red {
                order: 1;
            }

            /* HP */
            .vital-card.blue {
                order: 2;
            }

            /* PE */

            /* Name Row */
            .char-header-panel>div:first-child {
                order: 3;
            }

            /* Name/Rank */

            /* Stats Grid (AC/Speed) */
            .char-header-panel>div:nth-child(2) {
                order: 4;
                grid-template-columns: 1fr 1fr !important;
                /* 2 cols instead of 4 */
            }

            /* Proficiencies */
            #proficiencies-container {
                order: 5;
            }

            /* 2. Attributes Grid */
            #attrGrid {
                grid-template-columns: 1fr !important;
                /* Single Column */
                gap: 10px !important;
            }

            .attr-column {
                padding: 10px !important;
                /* Compact */
            }

            /* Typography Boosts */
            .vital-values {
                font-size: 1.1rem !important;
            }

            #dispAC,
            #dispSpeed {
                font-size: 1.6rem !important;
            }

            #currHP,
            #maxHP,
            #currPE,
            #maxPE {
                font-size: 1.2rem !important;
                font-weight: 800;
            }
        }
    </style>
    <script>
        function activateMobile(el) {
            document.querySelectorAll('.nav-item-mobile').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        function toggleMobileMenu() {
            // Simple logic for now, redirect or show modal. 
            // Reuse Exit logic for consistency as per Sidebar
            if (confirm("Sair do Painel?")) window.location.href = 'index.html';
        }

        // Ensure active tab sync
        const originalShow = window.showSection;
        window.showSection = function (id) {
            if (window.innerWidth < 768) {
                // Remove active from all
                document.querySelectorAll('.nav-item-mobile').forEach(n => n.classList.remove('active'));
                // Try to find matching icon logic is implicit in click handlers, but if called externally:
                // We can map IDs to indexes but simple click handler sets active is enough for user interaction.
            }
            // Call original
            // Re-implement basic showSection logic here if original is overwritten or accessible
            document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active-tab'));
            const t = document.getElementById(id);
            if (t) t.classList.add('active-tab');

            // Sidebar sync
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const n = document.getElementById('nav-' + id);
            if (n) n.classList.add('active');

            if (window.lucide) lucide.createIcons();
        }
    </script>
</body>

</html>